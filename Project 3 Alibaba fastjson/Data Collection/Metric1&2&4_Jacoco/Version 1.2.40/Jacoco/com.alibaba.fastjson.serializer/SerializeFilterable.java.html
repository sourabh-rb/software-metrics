<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>SerializeFilterable.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">fastjson</a> &gt; <a href="index.source.html" class="el_package">com.alibaba.fastjson.serializer</a> &gt; <span class="el_source">SerializeFilterable.java</span></div><h1>SerializeFilterable.java</h1><pre class="source lang-java linenums">package com.alibaba.fastjson.serializer;

import java.text.DecimalFormat;
import java.text.NumberFormat;
import java.util.ArrayList;
import java.util.List;

import com.alibaba.fastjson.JSON;

<span class="fc" id="L10">public abstract class SerializeFilterable {</span>

<span class="fc" id="L12">    protected List&lt;BeforeFilter&gt;       beforeFilters       = null;</span>
<span class="fc" id="L13">    protected List&lt;AfterFilter&gt;        afterFilters        = null;</span>
<span class="fc" id="L14">    protected List&lt;PropertyFilter&gt;     propertyFilters     = null;</span>
<span class="fc" id="L15">    protected List&lt;ValueFilter&gt;        valueFilters        = null;</span>
<span class="fc" id="L16">    protected List&lt;NameFilter&gt;         nameFilters         = null;</span>
<span class="fc" id="L17">    protected List&lt;PropertyPreFilter&gt;  propertyPreFilters  = null;</span>
<span class="fc" id="L18">    protected List&lt;LabelFilter&gt;        labelFilters        = null;</span>
<span class="fc" id="L19">    protected List&lt;ContextValueFilter&gt; contextValueFilters = null;</span>

<span class="fc" id="L21">    protected boolean                  writeDirect         = true;</span>

    public List&lt;BeforeFilter&gt; getBeforeFilters() {
<span class="pc bpc" id="L24" title="1 of 2 branches missed.">        if (beforeFilters == null) {</span>
<span class="fc" id="L25">            beforeFilters = new ArrayList&lt;BeforeFilter&gt;();</span>
<span class="fc" id="L26">            writeDirect = false;</span>
        }

<span class="fc" id="L29">        return beforeFilters;</span>
    }

    public List&lt;AfterFilter&gt; getAfterFilters() {
<span class="pc bpc" id="L33" title="1 of 2 branches missed.">        if (afterFilters == null) {</span>
<span class="fc" id="L34">            afterFilters = new ArrayList&lt;AfterFilter&gt;();</span>
<span class="fc" id="L35">            writeDirect = false;</span>
        }

<span class="fc" id="L38">        return afterFilters;</span>
    }

    public List&lt;NameFilter&gt; getNameFilters() {
<span class="fc bfc" id="L42" title="All 2 branches covered.">        if (nameFilters == null) {</span>
<span class="fc" id="L43">            nameFilters = new ArrayList&lt;NameFilter&gt;();</span>
<span class="fc" id="L44">            writeDirect = false;</span>
        }

<span class="fc" id="L47">        return nameFilters;</span>
    }

    public List&lt;PropertyPreFilter&gt; getPropertyPreFilters() {
<span class="fc bfc" id="L51" title="All 2 branches covered.">        if (propertyPreFilters == null) {</span>
<span class="fc" id="L52">            propertyPreFilters = new ArrayList&lt;PropertyPreFilter&gt;();</span>
<span class="fc" id="L53">            writeDirect = false;</span>
        }

<span class="fc" id="L56">        return propertyPreFilters;</span>
    }

    public List&lt;LabelFilter&gt; getLabelFilters() {
<span class="pc bpc" id="L60" title="1 of 2 branches missed.">        if (labelFilters == null) {</span>
<span class="fc" id="L61">            labelFilters = new ArrayList&lt;LabelFilter&gt;();</span>
<span class="fc" id="L62">            writeDirect = false;</span>
        }

<span class="fc" id="L65">        return labelFilters;</span>
    }

    public List&lt;PropertyFilter&gt; getPropertyFilters() {
<span class="fc bfc" id="L69" title="All 2 branches covered.">        if (propertyFilters == null) {</span>
<span class="fc" id="L70">            propertyFilters = new ArrayList&lt;PropertyFilter&gt;();</span>
<span class="fc" id="L71">            writeDirect = false;</span>
        }

<span class="fc" id="L74">        return propertyFilters;</span>
    }

    public List&lt;ContextValueFilter&gt; getContextValueFilters() {
<span class="pc bpc" id="L78" title="1 of 2 branches missed.">        if (contextValueFilters == null) {</span>
<span class="fc" id="L79">            contextValueFilters = new ArrayList&lt;ContextValueFilter&gt;();</span>
<span class="fc" id="L80">            writeDirect = false;</span>
        }

<span class="fc" id="L83">        return contextValueFilters;</span>
    }

    public List&lt;ValueFilter&gt; getValueFilters() {
<span class="fc bfc" id="L87" title="All 2 branches covered.">        if (valueFilters == null) {</span>
<span class="fc" id="L88">            valueFilters = new ArrayList&lt;ValueFilter&gt;();</span>
<span class="fc" id="L89">            writeDirect = false;</span>
        }

<span class="fc" id="L92">        return valueFilters;</span>
    }

    public void addFilter(SerializeFilter filter) {
<span class="fc bfc" id="L96" title="All 2 branches covered.">        if (filter == null) {</span>
<span class="fc" id="L97">            return;</span>
        }

<span class="fc bfc" id="L100" title="All 2 branches covered.">        if (filter instanceof PropertyPreFilter) {</span>
<span class="fc" id="L101">            this.getPropertyPreFilters().add((PropertyPreFilter) filter);</span>
        }

<span class="fc bfc" id="L104" title="All 2 branches covered.">        if (filter instanceof NameFilter) {</span>
<span class="fc" id="L105">            this.getNameFilters().add((NameFilter) filter);</span>
        }

<span class="fc bfc" id="L108" title="All 2 branches covered.">        if (filter instanceof ValueFilter) {</span>
<span class="fc" id="L109">            this.getValueFilters().add((ValueFilter) filter);</span>
        }

<span class="fc bfc" id="L112" title="All 2 branches covered.">        if (filter instanceof ContextValueFilter) {</span>
<span class="fc" id="L113">            this.getContextValueFilters().add((ContextValueFilter) filter);</span>
        }

<span class="fc bfc" id="L116" title="All 2 branches covered.">        if (filter instanceof PropertyFilter) {</span>
<span class="fc" id="L117">            this.getPropertyFilters().add((PropertyFilter) filter);</span>
        }

<span class="fc bfc" id="L120" title="All 2 branches covered.">        if (filter instanceof BeforeFilter) {</span>
<span class="fc" id="L121">            this.getBeforeFilters().add((BeforeFilter) filter);</span>
        }

<span class="fc bfc" id="L124" title="All 2 branches covered.">        if (filter instanceof AfterFilter) {</span>
<span class="fc" id="L125">            this.getAfterFilters().add((AfterFilter) filter);</span>
        }

<span class="fc bfc" id="L128" title="All 2 branches covered.">        if (filter instanceof LabelFilter) {</span>
<span class="fc" id="L129">            this.getLabelFilters().add((LabelFilter) filter);</span>
        }
<span class="fc" id="L131">    }</span>

    public boolean applyName(JSONSerializer jsonBeanDeser, //
                             Object object, String key) {

<span class="fc bfc" id="L136" title="All 2 branches covered.">        if (jsonBeanDeser.propertyPreFilters != null) {</span>
<span class="fc bfc" id="L137" title="All 2 branches covered.">            for (PropertyPreFilter filter : jsonBeanDeser.propertyPreFilters) {</span>
<span class="fc bfc" id="L138" title="All 2 branches covered.">                if (!filter.apply(jsonBeanDeser, object, key)) {</span>
<span class="fc" id="L139">                    return false;</span>
                }
<span class="fc" id="L141">            }</span>
        }
        
<span class="fc bfc" id="L144" title="All 2 branches covered.">        if (this.propertyPreFilters != null) {</span>
<span class="fc bfc" id="L145" title="All 2 branches covered.">            for (PropertyPreFilter filter : this.propertyPreFilters) {</span>
<span class="fc bfc" id="L146" title="All 2 branches covered.">                if (!filter.apply(jsonBeanDeser, object, key)) {</span>
<span class="fc" id="L147">                    return false;</span>
                }
<span class="fc" id="L149">            }</span>
        }

<span class="fc" id="L152">        return true;</span>
    }
    
    public boolean apply(JSONSerializer jsonBeanDeser, //
                         Object object, //
                         String key, Object propertyValue) {
        
<span class="fc bfc" id="L159" title="All 2 branches covered.">        if (jsonBeanDeser.propertyFilters != null) {</span>
<span class="fc bfc" id="L160" title="All 2 branches covered.">            for (PropertyFilter propertyFilter : jsonBeanDeser.propertyFilters) {</span>
<span class="fc bfc" id="L161" title="All 2 branches covered.">                if (!propertyFilter.apply(object, key, propertyValue)) {</span>
<span class="fc" id="L162">                    return false;</span>
                }
<span class="fc" id="L164">            }</span>
        }
        
<span class="fc bfc" id="L167" title="All 2 branches covered.">        if (this.propertyFilters != null) {</span>
<span class="fc bfc" id="L168" title="All 2 branches covered.">            for (PropertyFilter propertyFilter : this.propertyFilters) {</span>
<span class="fc bfc" id="L169" title="All 2 branches covered.">                if (!propertyFilter.apply(object, key, propertyValue)) {</span>
<span class="fc" id="L170">                    return false;</span>
                }
<span class="fc" id="L172">            }</span>
        }

<span class="fc" id="L175">        return true;</span>
    }
    
    protected String processKey(JSONSerializer jsonBeanDeser, //
                             Object object, //
                             String key, //
                             Object propertyValue) {

<span class="fc bfc" id="L183" title="All 2 branches covered.">        if (jsonBeanDeser.nameFilters != null) {</span>
<span class="fc bfc" id="L184" title="All 2 branches covered.">            for (NameFilter nameFilter : jsonBeanDeser.nameFilters) {</span>
<span class="fc" id="L185">                key = nameFilter.process(object, key, propertyValue);</span>
<span class="fc" id="L186">            }</span>
        }
        
<span class="fc bfc" id="L189" title="All 2 branches covered.">        if (this.nameFilters != null) {</span>
<span class="fc bfc" id="L190" title="All 2 branches covered.">            for (NameFilter nameFilter : this.nameFilters) {</span>
<span class="fc" id="L191">                key = nameFilter.process(object, key, propertyValue);</span>
<span class="fc" id="L192">            }</span>
        }

<span class="fc" id="L195">        return key;</span>
    }
    
    protected Object processValue(JSONSerializer jsonBeanDeser, //
                               BeanContext beanContext,
                               Object object, //
                               String key, //
                               Object propertyValue) {

<span class="fc bfc" id="L204" title="All 2 branches covered.">        if (propertyValue != null) {</span>
<span class="fc bfc" id="L205" title="All 4 branches covered.">            if ((jsonBeanDeser.out.writeNonStringValueAsString //</span>
<span class="fc bfc" id="L206" title="All 6 branches covered.">                    || (beanContext != null &amp;&amp; (beanContext.getFeatures() &amp; SerializerFeature.WriteNonStringValueAsString.mask) != 0))</span>
                    &amp;&amp; (propertyValue instanceof Number || propertyValue instanceof Boolean)) {
<span class="fc" id="L208">                String format = null;</span>
<span class="fc bfc" id="L209" title="All 4 branches covered.">                if (propertyValue instanceof Number</span>
                        &amp;&amp; beanContext != null) {
<span class="fc" id="L211">                    format = beanContext.getFormat();</span>
                }

<span class="fc bfc" id="L214" title="All 2 branches covered.">                if (format != null) {</span>
<span class="fc" id="L215">                    propertyValue = new DecimalFormat(format).format(propertyValue);</span>
                } else {
<span class="fc" id="L217">                    propertyValue = propertyValue.toString();</span>
                }
<span class="fc bfc" id="L219" title="All 4 branches covered.">            } else if (beanContext != null &amp;&amp; beanContext.isJsonDirect()) {</span>
<span class="fc" id="L220">                String jsonStr = (String) propertyValue;</span>
<span class="fc" id="L221">                propertyValue = JSON.parse(jsonStr);</span>
            }
        }
        
<span class="fc bfc" id="L225" title="All 2 branches covered.">        if (jsonBeanDeser.valueFilters != null) {</span>
<span class="fc bfc" id="L226" title="All 2 branches covered.">            for (ValueFilter valueFilter : jsonBeanDeser.valueFilters) {</span>
<span class="fc" id="L227">                propertyValue = valueFilter.process(object, key, propertyValue);</span>
<span class="fc" id="L228">            }</span>
        }

<span class="fc" id="L231">        List&lt;ValueFilter&gt; valueFilters = this.valueFilters;</span>
<span class="fc bfc" id="L232" title="All 2 branches covered.">        if (valueFilters != null) {</span>
<span class="fc bfc" id="L233" title="All 2 branches covered.">            for (ValueFilter valueFilter : valueFilters) {</span>
<span class="fc" id="L234">                propertyValue = valueFilter.process(object, key, propertyValue);</span>
<span class="fc" id="L235">            }</span>
        }

<span class="fc bfc" id="L238" title="All 2 branches covered.">        if (jsonBeanDeser.contextValueFilters != null) {</span>
<span class="fc bfc" id="L239" title="All 2 branches covered.">            for (ContextValueFilter valueFilter : jsonBeanDeser.contextValueFilters) {</span>
<span class="fc" id="L240">                propertyValue = valueFilter.process(beanContext, object, key, propertyValue);</span>
<span class="fc" id="L241">            }</span>
        }

<span class="fc bfc" id="L244" title="All 2 branches covered.">        if (this.contextValueFilters != null) {</span>
<span class="fc bfc" id="L245" title="All 2 branches covered.">            for (ContextValueFilter valueFilter : this.contextValueFilters) {</span>
<span class="fc" id="L246">                propertyValue = valueFilter.process(beanContext, object, key, propertyValue);</span>
<span class="fc" id="L247">            }</span>
        }

<span class="fc" id="L250">        return propertyValue;</span>
    }
    
    /**
     * only invoke by asm byte
     * 
     * @return
     */
    protected boolean writeDirect(JSONSerializer jsonBeanDeser) {
<span class="pc bpc" id="L259" title="1 of 6 branches missed.">        return jsonBeanDeser.out.writeDirect //</span>
               &amp;&amp; this.writeDirect //
               &amp;&amp; jsonBeanDeser.writeDirect;
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.5.201910111838</span></div></body></html>