<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>JavaBeanInfo.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">fastjson</a> &gt; <a href="index.source.html" class="el_package">com.alibaba.fastjson.util</a> &gt; <span class="el_source">JavaBeanInfo.java</span></div><h1>JavaBeanInfo.java</h1><pre class="source lang-java linenums">package com.alibaba.fastjson.util;

import java.lang.annotation.Annotation;
import java.lang.reflect.Constructor;
import java.lang.reflect.Field;
import java.lang.reflect.Method;
import java.lang.reflect.Modifier;
import java.lang.reflect.Type;
import java.util.*;
import java.util.concurrent.atomic.AtomicBoolean;
import java.util.concurrent.atomic.AtomicInteger;
import java.util.concurrent.atomic.AtomicLong;

import com.alibaba.fastjson.JSONException;
import com.alibaba.fastjson.PropertyNamingStrategy;
import com.alibaba.fastjson.annotation.JSONCreator;
import com.alibaba.fastjson.annotation.JSONField;
import com.alibaba.fastjson.annotation.JSONPOJOBuilder;
import com.alibaba.fastjson.annotation.JSONType;
import com.alibaba.fastjson.parser.Feature;
import com.alibaba.fastjson.serializer.SerializerFeature;

public class JavaBeanInfo {

    public final Class&lt;?&gt; clazz;
    public final Class&lt;?&gt; builderClass;
    public final Constructor&lt;?&gt; defaultConstructor;
    public final Constructor&lt;?&gt; creatorConstructor;
    public final Method factoryMethod;
    public final Method buildMethod;

    public final int defaultConstructorParameterSize;

    public final FieldInfo[] fields;
    public final FieldInfo[] sortedFields;

    public final int parserFeatures;

    public final JSONType jsonType;

    public final String typeName;
    public final String typeKey;

    public String[] orders;

    public Type[] creatorConstructorParameterTypes;
    public String[] creatorConstructorParameters;

    public boolean kotlin;
    public Constructor&lt;?&gt; kotlinDefaultConstructor;

    public JavaBeanInfo(Class&lt;?&gt; clazz, //
                        Class&lt;?&gt; builderClass, //
                        Constructor&lt;?&gt; defaultConstructor, //
                        Constructor&lt;?&gt; creatorConstructor, //
                        Method factoryMethod, //
                        Method buildMethod, //
                        JSONType jsonType, //
<span class="fc" id="L59">                        List&lt;FieldInfo&gt; fieldList) {</span>
<span class="fc" id="L60">        this.clazz = clazz;</span>
<span class="fc" id="L61">        this.builderClass = builderClass;</span>
<span class="fc" id="L62">        this.defaultConstructor = defaultConstructor;</span>
<span class="fc" id="L63">        this.creatorConstructor = creatorConstructor;</span>
<span class="fc" id="L64">        this.factoryMethod = factoryMethod;</span>
<span class="fc" id="L65">        this.parserFeatures = TypeUtils.getParserFeatures(clazz);</span>
<span class="fc" id="L66">        this.buildMethod = buildMethod;</span>

<span class="fc" id="L68">        this.jsonType = jsonType;</span>
<span class="fc bfc" id="L69" title="All 2 branches covered.">        if (jsonType != null) {</span>
<span class="fc" id="L70">            String typeName = jsonType.typeName();</span>
<span class="fc" id="L71">            String typeKey = jsonType.typeKey();</span>
<span class="fc bfc" id="L72" title="All 2 branches covered.">            this.typeKey = typeKey.length() &gt; 0 ? typeKey : null;</span>

<span class="fc bfc" id="L74" title="All 2 branches covered.">            if (typeName.length() != 0) {</span>
<span class="fc" id="L75">                this.typeName = typeName;</span>
            } else {
<span class="fc" id="L77">                this.typeName = clazz.getName();</span>
            }
<span class="fc" id="L79">            String[] orders = jsonType.orders();</span>
<span class="fc bfc" id="L80" title="All 2 branches covered.">            this.orders = orders.length == 0 ? null : orders;</span>
<span class="fc" id="L81">        } else {</span>
<span class="fc" id="L82">            this.typeName = clazz.getName();</span>
<span class="fc" id="L83">            this.typeKey = null;</span>
<span class="fc" id="L84">            this.orders = null;</span>
        }

<span class="fc" id="L87">        fields = new FieldInfo[fieldList.size()];</span>
<span class="fc" id="L88">        fieldList.toArray(fields);</span>

<span class="fc" id="L90">        FieldInfo[] sortedFields = new FieldInfo[fields.length];</span>
<span class="fc bfc" id="L91" title="All 2 branches covered.">        if (orders != null) {</span>
<span class="fc" id="L92">            LinkedHashMap&lt;String, FieldInfo&gt; map = new LinkedHashMap&lt;String, FieldInfo&gt;(fieldList.size());</span>
<span class="fc bfc" id="L93" title="All 2 branches covered.">            for (FieldInfo field : fields) {</span>
<span class="fc" id="L94">                map.put(field.name, field);</span>
            }
<span class="fc" id="L96">            int i = 0;</span>
<span class="fc bfc" id="L97" title="All 2 branches covered.">            for (String item : orders) {</span>
<span class="fc" id="L98">                FieldInfo field = map.get(item);</span>
<span class="fc bfc" id="L99" title="All 2 branches covered.">                if (field != null) {</span>
<span class="fc" id="L100">                    sortedFields[i++] = field;</span>
<span class="fc" id="L101">                    map.remove(item);</span>
                }
            }
<span class="fc bfc" id="L104" title="All 2 branches covered.">            for (FieldInfo field : map.values()) {</span>
<span class="fc" id="L105">                sortedFields[i++] = field;</span>
<span class="fc" id="L106">            }</span>
<span class="fc" id="L107">        } else {</span>
<span class="fc" id="L108">            System.arraycopy(fields, 0, sortedFields, 0, fields.length);</span>
<span class="fc" id="L109">            Arrays.sort(sortedFields);</span>
        }

<span class="fc bfc" id="L112" title="All 2 branches covered.">        if (Arrays.equals(fields, sortedFields)) {</span>
<span class="fc" id="L113">            sortedFields = fields;</span>
        }
<span class="fc" id="L115">        this.sortedFields = sortedFields;</span>

<span class="fc bfc" id="L117" title="All 2 branches covered.">        if (defaultConstructor != null) {</span>
<span class="fc" id="L118">            defaultConstructorParameterSize = defaultConstructor.getParameterTypes().length;</span>
<span class="fc bfc" id="L119" title="All 2 branches covered.">        } else if (factoryMethod != null) {</span>
<span class="fc" id="L120">            defaultConstructorParameterSize = factoryMethod.getParameterTypes().length;</span>
        } else {
<span class="fc" id="L122">            defaultConstructorParameterSize = 0;</span>
        }

<span class="fc bfc" id="L125" title="All 2 branches covered.">        if (creatorConstructor != null) {</span>
<span class="fc" id="L126">            this.creatorConstructorParameterTypes = creatorConstructor.getParameterTypes();</span>


<span class="fc" id="L129">            kotlin = TypeUtils.isKotlin(clazz);</span>
<span class="fc bfc" id="L130" title="All 2 branches covered.">            if (kotlin) {</span>
<span class="fc" id="L131">                this.creatorConstructorParameters = TypeUtils.getKoltinConstructorParameters(clazz);</span>
                try {
<span class="fc" id="L133">                    this.kotlinDefaultConstructor = clazz.getConstructor();</span>
<span class="fc" id="L134">                } catch (Throwable ex) {</span>
                    // skip
<span class="fc" id="L136">                }</span>

<span class="fc" id="L138">                Annotation[][] paramAnnotationArrays = TypeUtils.getParameterAnnotations(creatorConstructor);</span>
<span class="pc bpc" id="L139" title="1 of 4 branches missed.">                for (int i = 0; i &lt; creatorConstructorParameters.length &amp;&amp; i &lt; paramAnnotationArrays.length; ++i) {</span>
<span class="fc" id="L140">                    Annotation[] paramAnnotations = paramAnnotationArrays[i];</span>
<span class="fc" id="L141">                    JSONField fieldAnnotation = null;</span>
<span class="pc bfc" id="L142" title="All 2 branches covered.">                    for (Annotation paramAnnotation : paramAnnotations) {</span>
<span class="pc bpc" id="L143" title="1 of 2 branches missed.">                        if (paramAnnotation instanceof JSONField) {</span>
<span class="fc" id="L144">                            fieldAnnotation = (JSONField) paramAnnotation;</span>
<span class="fc" id="L145">                            break;</span>
                        }
                    }
<span class="fc bfc" id="L148" title="All 2 branches covered.">                    if (fieldAnnotation != null) {</span>
<span class="fc" id="L149">                        String fieldAnnotationName = fieldAnnotation.name();</span>
<span class="pc bpc" id="L150" title="1 of 2 branches missed.">                        if (fieldAnnotationName.length() &gt; 0) {</span>
<span class="fc" id="L151">                            creatorConstructorParameters[i] = fieldAnnotationName;</span>
                        }
                    }
                }
<span class="fc" id="L155">            } else {</span>
                boolean match;
<span class="fc bfc" id="L157" title="All 2 branches covered.">                if (creatorConstructorParameterTypes.length != fields.length) {</span>
<span class="fc" id="L158">                    match = false;</span>
                } else {
<span class="fc" id="L160">                    match = true;</span>
<span class="fc bfc" id="L161" title="All 2 branches covered.">                    for (int i = 0; i &lt; creatorConstructorParameterTypes.length; i++) {</span>
<span class="fc bfc" id="L162" title="All 2 branches covered.">                        if (creatorConstructorParameterTypes[i] != fields[i].fieldClass) {</span>
<span class="fc" id="L163">                            match = false;</span>
<span class="fc" id="L164">                            break;</span>
                        }
                    }
                }

<span class="fc bfc" id="L169" title="All 2 branches covered.">                if (!match) {</span>
<span class="fc" id="L170">                    this.creatorConstructorParameters = ASMUtils.lookupParameterNames(creatorConstructor);</span>
                }
            }
        }
<span class="fc" id="L174">    }</span>

    private static FieldInfo getField(List&lt;FieldInfo&gt; fieldList, String propertyName) {
<span class="fc bfc" id="L177" title="All 2 branches covered.">        for (FieldInfo item : fieldList) {</span>
<span class="fc bfc" id="L178" title="All 2 branches covered.">            if (item.name.equals(propertyName)) {</span>
<span class="fc" id="L179">                return item;</span>
            }

<span class="fc" id="L182">            Field field = item.field;</span>
<span class="fc bfc" id="L183" title="All 6 branches covered.">            if (field != null &amp;&amp; item.getAnnotation() != null &amp;&amp; field.getName().equals(propertyName)) {</span>
<span class="fc" id="L184">                return item;</span>
            }
<span class="fc" id="L186">        }</span>
<span class="fc" id="L187">        return null;</span>
    }


    static boolean add(List&lt;FieldInfo&gt; fieldList, FieldInfo field) {
<span class="fc bfc" id="L192" title="All 2 branches covered.">        for (int i = fieldList.size() - 1; i &gt;= 0; --i) {</span>
<span class="fc" id="L193">            FieldInfo item = fieldList.get(i);</span>

<span class="fc bfc" id="L195" title="All 2 branches covered.">            if (item.name.equals(field.name)) {</span>
<span class="pc bpc" id="L196" title="3 of 4 branches missed.">                if (item.getOnly &amp;&amp; !field.getOnly) {</span>
<span class="nc" id="L197">                    continue;</span>
                }

<span class="fc bfc" id="L200" title="All 2 branches covered.">                if (item.fieldClass.isAssignableFrom(field.fieldClass)) {</span>
<span class="fc" id="L201">                    fieldList.set(i, field);</span>
<span class="fc" id="L202">                    return true;</span>
                }

<span class="fc" id="L205">                int result = item.compareTo(field);</span>

<span class="fc bfc" id="L207" title="All 2 branches covered.">                if (result &lt; 0) {</span>
<span class="fc" id="L208">                    fieldList.set(i, field);</span>
<span class="fc" id="L209">                    return true;</span>
                } else {
<span class="fc" id="L211">                    return false;</span>
                }
            }
        }
<span class="fc" id="L215">        fieldList.add(field);</span>

<span class="fc" id="L217">        return true;</span>
    }

    public static JavaBeanInfo build(Class&lt;?&gt; clazz, Type type, PropertyNamingStrategy propertyNamingStrategy) {
<span class="fc" id="L221">        return build(clazz, type, propertyNamingStrategy, false, TypeUtils.compatibleWithJavaBean, false);</span>
    }

    public static JavaBeanInfo build(Class&lt;?&gt; clazz //
            , Type type //
            , PropertyNamingStrategy propertyNamingStrategy //
            , boolean fieldBased //
            , boolean compatibleWithJavaBean
    ) {
<span class="nc" id="L230">        return build(clazz, type, propertyNamingStrategy, fieldBased, compatibleWithJavaBean, false);</span>
    }

    public static JavaBeanInfo build(Class&lt;?&gt; clazz //
            , Type type //
            , PropertyNamingStrategy propertyNamingStrategy //
            , boolean fieldBased //
            , boolean compatibleWithJavaBean
            , boolean jacksonCompatible
    ) {
<span class="fc" id="L240">        JSONType jsonType = TypeUtils.getAnnotation(clazz,JSONType.class);</span>
<span class="fc bfc" id="L241" title="All 2 branches covered.">        if (jsonType != null) {</span>
<span class="fc" id="L242">            PropertyNamingStrategy jsonTypeNaming = jsonType.naming();</span>
<span class="pc bpc" id="L243" title="1 of 4 branches missed.">            if (jsonTypeNaming != null &amp;&amp; jsonTypeNaming != PropertyNamingStrategy.CamelCase) {</span>
<span class="fc" id="L244">                propertyNamingStrategy = jsonTypeNaming;</span>
            }
        }

<span class="fc" id="L248">        Class&lt;?&gt; builderClass = getBuilderClass(clazz, jsonType);</span>

<span class="fc" id="L250">        Field[] declaredFields = clazz.getDeclaredFields();</span>
<span class="fc" id="L251">        Method[] methods = clazz.getMethods();</span>

<span class="fc" id="L253">        boolean kotlin = TypeUtils.isKotlin(clazz);</span>
<span class="fc" id="L254">        Constructor[] constructors = clazz.getDeclaredConstructors();</span>

<span class="fc" id="L256">        Constructor&lt;?&gt; defaultConstructor = null;</span>
<span class="fc bfc" id="L257" title="All 4 branches covered.">        if ((!kotlin) || constructors.length == 1) {</span>
<span class="fc bfc" id="L258" title="All 2 branches covered.">            if (builderClass == null) {</span>
<span class="fc" id="L259">                defaultConstructor = getDefaultConstructor(clazz, constructors);</span>
            } else {
<span class="fc" id="L261">                defaultConstructor = getDefaultConstructor(builderClass, builderClass.getDeclaredConstructors());</span>
            }
        }

<span class="fc" id="L265">        Constructor&lt;?&gt; creatorConstructor = null;</span>
<span class="fc" id="L266">        Method buildMethod = null;</span>
<span class="fc" id="L267">        Method factoryMethod = null;</span>

<span class="fc" id="L269">        List&lt;FieldInfo&gt; fieldList = new ArrayList&lt;FieldInfo&gt;();</span>

<span class="fc bfc" id="L271" title="All 2 branches covered.">        if (fieldBased) {</span>
<span class="fc bfc" id="L272" title="All 2 branches covered.">            for (Class&lt;?&gt; currentClass = clazz; currentClass != null; currentClass = currentClass.getSuperclass()) {</span>
<span class="fc" id="L273">                Field[] fields = currentClass.getDeclaredFields();</span>

<span class="fc" id="L275">                computeFields(clazz, type, propertyNamingStrategy, fieldList, fields);</span>
            }
<span class="fc" id="L277">            return new JavaBeanInfo(clazz, builderClass, defaultConstructor, null, factoryMethod, buildMethod, jsonType, fieldList);</span>
        }

<span class="fc bfc" id="L280" title="All 4 branches covered.">        boolean isInterfaceOrAbstract = clazz.isInterface() || Modifier.isAbstract(clazz.getModifiers());</span>
<span class="pc bpc" id="L281" title="2 of 6 branches missed.">        if ((defaultConstructor == null &amp;&amp; builderClass == null) || isInterfaceOrAbstract) {</span>
<span class="fc" id="L282">            creatorConstructor = getCreatorConstructor(constructors);</span>

<span class="pc bpc" id="L284" title="1 of 4 branches missed.">            if (creatorConstructor != null &amp;&amp; !isInterfaceOrAbstract) { // 基于标记 JSONCreator 注解的构造方法</span>
<span class="fc" id="L285">                TypeUtils.setAccessible(creatorConstructor);</span>

<span class="fc" id="L287">                Class&lt;?&gt;[] types = creatorConstructor.getParameterTypes();</span>

<span class="fc" id="L289">                String[] lookupParameterNames = null;</span>
<span class="pc bpc" id="L290" title="1 of 2 branches missed.">                if (types.length &gt; 0) {</span>
<span class="fc" id="L291">                    Annotation[][] paramAnnotationArrays = TypeUtils.getParameterAnnotations(creatorConstructor);</span>
<span class="fc bfc" id="L292" title="All 2 branches covered.">                    for (int i = 0; i &lt; types.length; ++i) {</span>
<span class="fc" id="L293">                        Annotation[] paramAnnotations = paramAnnotationArrays[i];</span>
<span class="fc" id="L294">                        JSONField fieldAnnotation = null;</span>
<span class="pc bfc" id="L295" title="All 2 branches covered.">                        for (Annotation paramAnnotation : paramAnnotations) {</span>
<span class="pc bpc" id="L296" title="1 of 2 branches missed.">                            if (paramAnnotation instanceof JSONField) {</span>
<span class="fc" id="L297">                                fieldAnnotation = (JSONField) paramAnnotation;</span>
<span class="fc" id="L298">                                break;</span>
                            }
                        }

<span class="fc" id="L302">                        Class&lt;?&gt; fieldClass = types[i];</span>
<span class="fc" id="L303">                        Type fieldType = creatorConstructor.getGenericParameterTypes()[i];</span>

<span class="fc" id="L305">                        String fieldName = null;</span>
<span class="fc" id="L306">                        Field field = null;</span>
<span class="fc" id="L307">                        int ordinal = 0, serialzeFeatures = 0, parserFeatures = 0;</span>
<span class="fc bfc" id="L308" title="All 2 branches covered.">                        if (fieldAnnotation != null) {</span>
<span class="fc" id="L309">                            field = TypeUtils.getField(clazz, fieldAnnotation.name(), declaredFields);</span>
<span class="fc" id="L310">                            ordinal = fieldAnnotation.ordinal();</span>
<span class="fc" id="L311">                            serialzeFeatures = SerializerFeature.of(fieldAnnotation.serialzeFeatures());</span>
<span class="fc" id="L312">                            parserFeatures = Feature.of(fieldAnnotation.parseFeatures());</span>
<span class="fc" id="L313">                            fieldName = fieldAnnotation.name();</span>
                        }

<span class="fc bfc" id="L316" title="All 4 branches covered.">                        if (fieldName == null || fieldName.length() == 0) {</span>
<span class="pc bpc" id="L317" title="1 of 2 branches missed.">                            if (lookupParameterNames == null) {</span>
<span class="fc" id="L318">                                lookupParameterNames = ASMUtils.lookupParameterNames(creatorConstructor);</span>
                            }
<span class="fc" id="L320">                            fieldName = lookupParameterNames[i];</span>
                        }

<span class="fc bfc" id="L323" title="All 2 branches covered.">                        if (field == null) {</span>
<span class="fc bfc" id="L324" title="All 2 branches covered.">                            if (lookupParameterNames == null) {</span>
<span class="fc bfc" id="L325" title="All 2 branches covered.">                                if (kotlin) {</span>
<span class="fc" id="L326">                                    lookupParameterNames = TypeUtils.getKoltinConstructorParameters(clazz);</span>
                                } else {
<span class="fc" id="L328">                                    lookupParameterNames = ASMUtils.lookupParameterNames(creatorConstructor);</span>
                                }
                            }

<span class="pc bpc" id="L332" title="1 of 2 branches missed.">                            if (lookupParameterNames.length &gt; i) {</span>
<span class="fc" id="L333">                                String parameterName = lookupParameterNames[i];</span>
<span class="fc" id="L334">                                field = TypeUtils.getField(clazz, parameterName, declaredFields);</span>
                            }
                        }

<span class="fc" id="L338">                        FieldInfo fieldInfo = new FieldInfo(fieldName, clazz, fieldClass, fieldType, field,</span>
                                ordinal, serialzeFeatures, parserFeatures);
<span class="fc" id="L340">                        add(fieldList, fieldInfo);</span>
                    }
                }

                //return new JavaBeanInfo(clazz, builderClass, null, creatorConstructor, null, null, jsonType, fieldList);
<span class="fc bfc" id="L345" title="All 2 branches covered.">            } else if ((factoryMethod = getFactoryMethod(clazz, methods, jacksonCompatible)) != null) {</span>
<span class="fc" id="L346">                TypeUtils.setAccessible(factoryMethod);</span>

<span class="fc" id="L348">                String[] lookupParameterNames = null;</span>
<span class="fc" id="L349">                Class&lt;?&gt;[] types = factoryMethod.getParameterTypes();</span>
<span class="fc bfc" id="L350" title="All 2 branches covered.">                if (types.length &gt; 0) {</span>
<span class="fc" id="L351">                    Annotation[][] paramAnnotationArrays = TypeUtils.getParameterAnnotations(factoryMethod);</span>
<span class="fc bfc" id="L352" title="All 2 branches covered.">                    for (int i = 0; i &lt; types.length; ++i) {</span>
<span class="fc" id="L353">                        Annotation[] paramAnnotations = paramAnnotationArrays[i];</span>
<span class="fc" id="L354">                        JSONField fieldAnnotation = null;</span>
<span class="pc bfc" id="L355" title="All 2 branches covered.">                        for (Annotation paramAnnotation : paramAnnotations) {</span>
<span class="pc bpc" id="L356" title="1 of 2 branches missed.">                            if (paramAnnotation instanceof JSONField) {</span>
<span class="fc" id="L357">                                fieldAnnotation = (JSONField) paramAnnotation;</span>
<span class="fc" id="L358">                                break;</span>
                            }
                        }
<span class="pc bpc" id="L361" title="1 of 6 branches missed.">                        if (fieldAnnotation == null &amp;&amp; !(jacksonCompatible &amp;&amp; TypeUtils.isJacksonCreator(factoryMethod))) {</span>
<span class="fc" id="L362">                            throw new JSONException(&quot;illegal json creator&quot;);</span>
                        }

<span class="fc" id="L365">                        String fieldName = null;</span>
<span class="fc" id="L366">                        int ordinal = 0, serialzeFeatures = 0, parserFeatures = 0;</span>

<span class="fc bfc" id="L368" title="All 2 branches covered.">                        if (fieldAnnotation != null) {</span>
<span class="fc" id="L369">                            fieldName = fieldAnnotation.name();</span>
<span class="fc" id="L370">                            ordinal = fieldAnnotation.ordinal();</span>
<span class="fc" id="L371">                            serialzeFeatures = SerializerFeature.of(fieldAnnotation.serialzeFeatures());</span>
<span class="fc" id="L372">                            parserFeatures = Feature.of(fieldAnnotation.parseFeatures());</span>
                        }

<span class="pc bpc" id="L375" title="1 of 4 branches missed.">                        if (fieldName == null || fieldName.length() == 0) {</span>
<span class="pc bpc" id="L376" title="1 of 2 branches missed.">                            if (lookupParameterNames == null) {</span>
<span class="fc" id="L377">                                lookupParameterNames = ASMUtils.lookupParameterNames(factoryMethod);</span>
                            }
<span class="fc" id="L379">                            fieldName = lookupParameterNames[i];</span>
                        }

<span class="fc" id="L382">                        Class&lt;?&gt; fieldClass = types[i];</span>
<span class="fc" id="L383">                        Type fieldType = factoryMethod.getGenericParameterTypes()[i];</span>

<span class="fc" id="L385">                        Field field = TypeUtils.getField(clazz, fieldName, declaredFields);</span>
<span class="fc" id="L386">                        FieldInfo fieldInfo = new FieldInfo(fieldName, clazz, fieldClass, fieldType, field,</span>
                                ordinal, serialzeFeatures, parserFeatures);
<span class="fc" id="L388">                        add(fieldList, fieldInfo);</span>
                    }

<span class="fc" id="L391">                    return new JavaBeanInfo(clazz, builderClass, null, null, factoryMethod, null, jsonType, fieldList);</span>
                }
<span class="fc bfc" id="L393" title="All 2 branches covered.">            } else if (!isInterfaceOrAbstract) {</span>
<span class="fc" id="L394">                String className = clazz.getName();</span>

<span class="fc" id="L396">                String[] paramNames = null;</span>
<span class="pc bpc" id="L397" title="1 of 4 branches missed.">                if (kotlin &amp;&amp; constructors.length &gt; 0) {</span>
<span class="fc" id="L398">                    paramNames = TypeUtils.getKoltinConstructorParameters(clazz);</span>
<span class="fc" id="L399">                    creatorConstructor = TypeUtils.getKoltinConstructor(constructors, paramNames);</span>
<span class="fc" id="L400">                    TypeUtils.setAccessible(creatorConstructor);</span>
                } else {

<span class="fc bfc" id="L403" title="All 2 branches covered.">                    for (Constructor constructor : constructors) {</span>
<span class="fc" id="L404">                        Class&lt;?&gt;[] parameterTypes = constructor.getParameterTypes();</span>

<span class="fc bfc" id="L406" title="All 2 branches covered.">                        if (className.equals(&quot;org.springframework.security.web.authentication.WebAuthenticationDetails&quot;)) {</span>
<span class="pc bpc" id="L407" title="2 of 6 branches missed.">                            if (parameterTypes.length == 2 &amp;&amp; parameterTypes[0] == String.class &amp;&amp; parameterTypes[1] == String.class) {</span>
<span class="fc" id="L408">                                creatorConstructor = constructor;</span>
<span class="fc" id="L409">                                creatorConstructor.setAccessible(true);</span>
<span class="fc" id="L410">                                paramNames = ASMUtils.lookupParameterNames(constructor);</span>
<span class="fc" id="L411">                                break;</span>
                            }
                        }

<span class="fc bfc" id="L415" title="All 2 branches covered.">                        if (className.equals(&quot;org.springframework.security.web.authentication.preauth.PreAuthenticatedAuthenticationToken&quot;)) {</span>
<span class="pc bpc" id="L416" title="3 of 8 branches missed.">                            if (parameterTypes.length == 3</span>
                                    &amp;&amp; parameterTypes[0] == Object.class
                                    &amp;&amp; parameterTypes[1] == Object.class
                                    &amp;&amp; parameterTypes[2] == Collection.class) {
<span class="fc" id="L420">                                creatorConstructor = constructor;</span>
<span class="fc" id="L421">                                creatorConstructor.setAccessible(true);</span>
<span class="fc" id="L422">                                paramNames = new String[] {&quot;principal&quot;, &quot;credentials&quot;, &quot;authorities&quot;};</span>
<span class="fc" id="L423">                                break;</span>
                            }
                        }

<span class="fc bfc" id="L427" title="All 2 branches covered.">                        if (className.equals(&quot;org.springframework.security.core.authority.SimpleGrantedAuthority&quot;)) {</span>
<span class="pc bpc" id="L428" title="2 of 4 branches missed.">                            if (parameterTypes.length == 1</span>
                                    &amp;&amp; parameterTypes[0] == String.class) {
<span class="fc" id="L430">                                creatorConstructor = constructor;</span>
<span class="fc" id="L431">                                paramNames = new String[] {&quot;authority&quot;};</span>
<span class="fc" id="L432">                                break;</span>
                            }
                        }

                        //


<span class="pc bpc" id="L439" title="1 of 2 branches missed.">                        boolean is_public = (constructor.getModifiers() &amp; Modifier.PUBLIC) != 0;</span>
<span class="pc bpc" id="L440" title="1 of 2 branches missed.">                        if (!is_public) {</span>
<span class="nc" id="L441">                            continue;</span>
                        }
<span class="fc" id="L443">                        String[] lookupParameterNames = ASMUtils.lookupParameterNames(constructor);</span>
<span class="pc bpc" id="L444" title="2 of 4 branches missed.">                        if (lookupParameterNames == null || lookupParameterNames.length == 0) {</span>
<span class="nc" id="L445">                            continue;</span>
                        }

<span class="pc bpc" id="L448" title="1 of 6 branches missed.">                        if (creatorConstructor != null</span>
                                &amp;&amp; paramNames != null &amp;&amp; lookupParameterNames.length &lt;= paramNames.length) {
<span class="fc" id="L450">                            continue;</span>
                        }

<span class="fc" id="L453">                        paramNames = lookupParameterNames;</span>
<span class="fc" id="L454">                        creatorConstructor = constructor;</span>
                    }
                }

<span class="fc" id="L458">                Class&lt;?&gt;[] types = null;</span>
<span class="pc bpc" id="L459" title="1 of 2 branches missed.">                if (paramNames != null) {</span>
<span class="fc" id="L460">                    types = creatorConstructor.getParameterTypes();</span>
                }

<span class="pc bpc" id="L463" title="1 of 4 branches missed.">                if (paramNames != null</span>
                        &amp;&amp; types.length == paramNames.length) {
<span class="fc" id="L465">                    Annotation[][] paramAnnotationArrays = TypeUtils.getParameterAnnotations(creatorConstructor);</span>
<span class="fc bfc" id="L466" title="All 2 branches covered.">                    for (int i = 0; i &lt; types.length; ++i) {</span>
<span class="fc" id="L467">                        Annotation[] paramAnnotations = paramAnnotationArrays[i];</span>
<span class="fc" id="L468">                        String paramName = paramNames[i];</span>

<span class="fc" id="L470">                        JSONField fieldAnnotation = null;</span>
<span class="pc bpc" id="L471" title="1 of 2 branches missed.">                        for (Annotation paramAnnotation : paramAnnotations) {</span>
<span class="nc bnc" id="L472" title="All 2 branches missed.">                            if (paramAnnotation instanceof JSONField) {</span>
<span class="nc" id="L473">                                fieldAnnotation = (JSONField) paramAnnotation;</span>
<span class="nc" id="L474">                                break;</span>
                            }
                        }

<span class="fc" id="L478">                        Class&lt;?&gt; fieldClass = types[i];</span>
<span class="fc" id="L479">                        Type fieldType = creatorConstructor.getGenericParameterTypes()[i];</span>
<span class="fc" id="L480">                        Field field = TypeUtils.getField(clazz, paramName, declaredFields);</span>
<span class="fc bfc" id="L481" title="All 2 branches covered.">                        if (field != null) {</span>
<span class="pc bpc" id="L482" title="1 of 2 branches missed.">                            if (fieldAnnotation == null) {</span>
<span class="fc" id="L483">                                fieldAnnotation = TypeUtils.getAnnotation(field, JSONField.class);</span>
                            }
                        }
                        final int ordinal, serialzeFeatures, parserFeatures;
<span class="fc bfc" id="L487" title="All 2 branches covered.">                        if (fieldAnnotation == null) {</span>
<span class="fc" id="L488">                            ordinal = 0;</span>
<span class="fc" id="L489">                            serialzeFeatures = 0;</span>

<span class="fc bfc" id="L491" title="All 2 branches covered.">                            if (&quot;org.springframework.security.core.userdetails.User&quot;.equals(className)</span>
<span class="fc bfc" id="L492" title="All 2 branches covered.">                                    &amp;&amp; &quot;password&quot;.equals(paramName)) {</span>
<span class="fc" id="L493">                                parserFeatures = Feature.InitStringFieldAsEmpty.mask;</span>
                            } else {
<span class="fc" id="L495">                                parserFeatures = 0;</span>
                            }
                        } else {
<span class="fc" id="L498">                            String nameAnnotated = fieldAnnotation.name();</span>
<span class="pc bpc" id="L499" title="1 of 2 branches missed.">                            if (nameAnnotated.length() != 0) {</span>
<span class="fc" id="L500">                                paramName = nameAnnotated;</span>
                            }
<span class="fc" id="L502">                            ordinal = fieldAnnotation.ordinal();</span>
<span class="fc" id="L503">                            serialzeFeatures = SerializerFeature.of(fieldAnnotation.serialzeFeatures());</span>
<span class="fc" id="L504">                            parserFeatures = Feature.of(fieldAnnotation.parseFeatures());</span>
                        }
<span class="fc" id="L506">                        FieldInfo fieldInfo = new FieldInfo(paramName, clazz, fieldClass, fieldType, field,</span>
                                ordinal, serialzeFeatures, parserFeatures);
<span class="fc" id="L508">                        add(fieldList, fieldInfo);</span>
                    }

<span class="fc bfc" id="L511" title="All 2 branches covered.">                    if ((!kotlin)</span>
<span class="fc bfc" id="L512" title="All 2 branches covered.">                            &amp;&amp; !clazz.getName().equals(&quot;javax.servlet.http.Cookie&quot;)) {</span>
<span class="fc" id="L513">                        return new JavaBeanInfo(clazz, builderClass, null, creatorConstructor, null, null, jsonType, fieldList);</span>
                    }
<span class="fc" id="L515">                } else {</span>
<span class="fc" id="L516">                    throw new JSONException(&quot;default constructor not found. &quot; + clazz);</span>
                }
            }
        }

<span class="fc bfc" id="L521" title="All 2 branches covered.">        if (defaultConstructor != null) {</span>
<span class="fc" id="L522">            TypeUtils.setAccessible(defaultConstructor);</span>
        }

<span class="fc bfc" id="L525" title="All 2 branches covered.">        if (builderClass != null) {</span>
<span class="fc" id="L526">            String withPrefix = null;</span>

<span class="fc" id="L528">            JSONPOJOBuilder builderAnno = TypeUtils.getAnnotation(builderClass, JSONPOJOBuilder.class);</span>
<span class="fc bfc" id="L529" title="All 2 branches covered.">            if (builderAnno != null) {</span>
<span class="fc" id="L530">                withPrefix = builderAnno.withPrefix();</span>
            }

<span class="fc bfc" id="L533" title="All 2 branches covered.">            if (withPrefix == null) {</span>
<span class="fc" id="L534">                withPrefix = &quot;with&quot;;</span>
            }

<span class="fc bfc" id="L537" title="All 2 branches covered.">            for (Method method : builderClass.getMethods()) {</span>
<span class="pc bpc" id="L538" title="1 of 2 branches missed.">                if (Modifier.isStatic(method.getModifiers())) {</span>
<span class="nc" id="L539">                    continue;</span>
                }

<span class="fc bfc" id="L542" title="All 2 branches covered.">                if (!(method.getReturnType().equals(builderClass))) {</span>
<span class="fc" id="L543">                    continue;</span>
                }

<span class="fc" id="L546">                int ordinal = 0, serialzeFeatures = 0, parserFeatures = 0;</span>

<span class="fc" id="L548">                JSONField annotation = TypeUtils.getAnnotation(method, JSONField.class);</span>

<span class="fc bfc" id="L550" title="All 2 branches covered.">                if (annotation == null) {</span>
<span class="fc" id="L551">                    annotation = TypeUtils.getSuperMethodAnnotation(clazz, method);</span>
                }

<span class="fc bfc" id="L554" title="All 2 branches covered.">                if (annotation != null) {</span>
<span class="pc bpc" id="L555" title="1 of 2 branches missed.">                    if (!annotation.deserialize()) {</span>
<span class="nc" id="L556">                        continue;</span>
                    }

<span class="fc" id="L559">                    ordinal = annotation.ordinal();</span>
<span class="fc" id="L560">                    serialzeFeatures = SerializerFeature.of(annotation.serialzeFeatures());</span>
<span class="fc" id="L561">                    parserFeatures = Feature.of(annotation.parseFeatures());</span>

<span class="pc bpc" id="L563" title="1 of 2 branches missed.">                    if (annotation.name().length() != 0) {</span>
<span class="fc" id="L564">                        String propertyName = annotation.name();</span>
<span class="fc" id="L565">                        add(fieldList, new FieldInfo(propertyName, method, null, clazz, type, ordinal, serialzeFeatures, parserFeatures,</span>
                                annotation, null, null));
<span class="fc" id="L567">                        continue;</span>
                    }
                }

<span class="fc" id="L571">                String methodName = method.getName();</span>
                StringBuilder properNameBuilder;
<span class="pc bpc" id="L573" title="1 of 4 branches missed.">                if (methodName.startsWith(&quot;set&quot;) &amp;&amp; methodName.length() &gt; 3) {</span>
<span class="fc" id="L574">                    properNameBuilder = new StringBuilder(methodName.substring(3));</span>
                } else {
<span class="fc bfc" id="L576" title="All 2 branches covered.">                    if (withPrefix.length() == 0){</span>
<span class="fc" id="L577">                        properNameBuilder = new StringBuilder(methodName);</span>
                    } else {
<span class="pc bpc" id="L579" title="1 of 2 branches missed.">                        if (!methodName.startsWith(withPrefix)) {</span>
<span class="nc" id="L580">                            continue;</span>
                        }
    
<span class="pc bpc" id="L583" title="1 of 2 branches missed.">                        if (methodName.length() &lt;= withPrefix.length()) {</span>
<span class="nc" id="L584">                            continue;</span>
                        }
    
<span class="fc" id="L587">                        properNameBuilder = new StringBuilder(methodName.substring(withPrefix.length()));</span>
                    }
                }

<span class="fc" id="L591">                char c0 = properNameBuilder.charAt(0);</span>
<span class="pc bpc" id="L592" title="1 of 4 branches missed.">                if (withPrefix.length() != 0 &amp;&amp; !Character.isUpperCase(c0)) {</span>
<span class="nc" id="L593">                    continue;</span>
                }

<span class="fc" id="L596">                properNameBuilder.setCharAt(0, Character.toLowerCase(c0));</span>

<span class="fc" id="L598">                String propertyName = properNameBuilder.toString();</span>

<span class="fc" id="L600">                add(fieldList, new FieldInfo(propertyName, method, null, clazz, type, ordinal, serialzeFeatures, parserFeatures,</span>
                        annotation, null, null));
            }

<span class="pc bpc" id="L604" title="1 of 2 branches missed.">            if (builderClass != null) {</span>
<span class="fc" id="L605">                JSONPOJOBuilder builderAnnotation = TypeUtils.getAnnotation(builderClass, JSONPOJOBuilder.class);</span>

<span class="fc" id="L607">                String buildMethodName = null;</span>
<span class="fc bfc" id="L608" title="All 2 branches covered.">                if (builderAnnotation != null) {</span>
<span class="fc" id="L609">                    buildMethodName = builderAnnotation.buildMethod();</span>
                }

<span class="pc bpc" id="L612" title="1 of 4 branches missed.">                if (buildMethodName == null || buildMethodName.length() == 0) {</span>
<span class="fc" id="L613">                    buildMethodName = &quot;build&quot;;</span>
                }

                try {
<span class="fc" id="L617">                    buildMethod = builderClass.getMethod(buildMethodName);</span>
<span class="fc" id="L618">                } catch (NoSuchMethodException e) {</span>
                    // skip
<span class="nc" id="L620">                } catch (SecurityException e) {</span>
                    // skip
<span class="fc" id="L622">                }</span>

<span class="fc bfc" id="L624" title="All 2 branches covered.">                if (buildMethod == null) {</span>
                    try {
<span class="fc" id="L626">                        buildMethod = builderClass.getMethod(&quot;create&quot;);</span>
<span class="nc" id="L627">                    } catch (NoSuchMethodException e) {</span>
                        // skip
<span class="nc" id="L629">                    } catch (SecurityException e) {</span>
                        // skip
<span class="pc" id="L631">                    }</span>
                }

<span class="pc bpc" id="L634" title="1 of 2 branches missed.">                if (buildMethod == null) {</span>
<span class="nc" id="L635">                    throw new JSONException(&quot;buildMethod not found.&quot;);</span>
                }

<span class="fc" id="L638">                TypeUtils.setAccessible(buildMethod);</span>
            }
        }

<span class="fc bfc" id="L642" title="All 2 branches covered.">        for (Method method : methods) { //</span>
<span class="fc" id="L643">            int ordinal = 0, serialzeFeatures = 0, parserFeatures = 0;</span>
<span class="fc" id="L644">            String methodName = method.getName();</span>

<span class="fc bfc" id="L646" title="All 2 branches covered.">            if (Modifier.isStatic(method.getModifiers())) {</span>
<span class="fc" id="L647">                continue;</span>
            }

            // support builder set
<span class="fc" id="L651">            Class&lt;?&gt; returnType = method.getReturnType();</span>
<span class="fc bfc" id="L652" title="All 4 branches covered.">            if (!(returnType.equals(Void.TYPE) || returnType.equals(method.getDeclaringClass()))) {</span>
<span class="fc" id="L653">                continue;</span>
            }

<span class="fc bfc" id="L656" title="All 2 branches covered.">            if (method.getDeclaringClass() == Object.class) {</span>
<span class="fc" id="L657">                continue;</span>
            }

<span class="fc" id="L660">            Class&lt;?&gt;[] types = method.getParameterTypes();</span>

<span class="fc bfc" id="L662" title="All 4 branches covered.">            if (types.length == 0 || types.length &gt; 2) {</span>
<span class="fc" id="L663">                continue;</span>
            }

<span class="fc" id="L666">            JSONField annotation = TypeUtils.getAnnotation(method, JSONField.class);</span>
<span class="pc bpc" id="L667" title="2 of 8 branches missed.">            if (annotation != null</span>
                    &amp;&amp; types.length == 2
                    &amp;&amp; types[0] == String.class
                    &amp;&amp; types[1] == Object.class) {
<span class="fc" id="L671">                add(fieldList, new FieldInfo(&quot;&quot;, method, null, clazz, type, ordinal,</span>
                        serialzeFeatures, parserFeatures, annotation, null, null));
<span class="fc" id="L673">                continue;</span>
            }

<span class="fc bfc" id="L676" title="All 2 branches covered.">            if (types.length != 1) {</span>
<span class="fc" id="L677">                continue;</span>
            }

<span class="fc bfc" id="L680" title="All 2 branches covered.">            if (annotation == null) {</span>
<span class="fc" id="L681">                annotation = TypeUtils.getSuperMethodAnnotation(clazz, method);</span>
            }

<span class="fc bfc" id="L684" title="All 4 branches covered.">            if (annotation == null &amp;&amp; methodName.length() &lt; 4) {</span>
<span class="fc" id="L685">                continue;</span>
            }

<span class="fc bfc" id="L688" title="All 2 branches covered.">            if (annotation != null) {</span>
<span class="fc bfc" id="L689" title="All 2 branches covered.">                if (!annotation.deserialize()) {</span>
<span class="fc" id="L690">                    continue;</span>
                }

<span class="fc" id="L693">                ordinal = annotation.ordinal();</span>
<span class="fc" id="L694">                serialzeFeatures = SerializerFeature.of(annotation.serialzeFeatures());</span>
<span class="fc" id="L695">                parserFeatures = Feature.of(annotation.parseFeatures());</span>

<span class="fc bfc" id="L697" title="All 2 branches covered.">                if (annotation.name().length() != 0) {</span>
<span class="fc" id="L698">                    String propertyName = annotation.name();</span>
<span class="fc" id="L699">                    add(fieldList, new FieldInfo(propertyName, method, null, clazz, type, ordinal, serialzeFeatures, parserFeatures,</span>
                            annotation, null, null));
<span class="fc" id="L701">                    continue;</span>
                }
            }

<span class="fc bfc" id="L705" title="All 6 branches covered.">            if (annotation == null &amp;&amp; !methodName.startsWith(&quot;set&quot;) || builderClass != null) { // TODO &quot;set&quot;的判断放在 JSONField 注解后面，意思是允许非 setter 方法标记 JSONField 注解？</span>
<span class="fc" id="L706">                continue;</span>
            }

<span class="fc" id="L709">            char c3 = methodName.charAt(3);</span>

            String propertyName;
<span class="fc bfc" id="L712" title="All 4 branches covered.">            if (Character.isUpperCase(c3) //</span>
                    || c3 &gt; 512 // for unicode method name
                    ) {
<span class="fc bfc" id="L715" title="All 2 branches covered.">                if (TypeUtils.compatibleWithJavaBean) {</span>
<span class="fc" id="L716">                    propertyName = TypeUtils.decapitalize(methodName.substring(3));</span>
                } else {
<span class="fc" id="L718">                    propertyName = Character.toLowerCase(methodName.charAt(3)) + methodName.substring(4);</span>
                }
<span class="fc bfc" id="L720" title="All 2 branches covered.">            } else if (c3 == '_') {</span>
<span class="fc" id="L721">                propertyName = methodName.substring(4);</span>
<span class="fc bfc" id="L722" title="All 2 branches covered.">            } else if (c3 == 'f') {</span>
<span class="fc" id="L723">                propertyName = methodName.substring(3);</span>
<span class="pc bpc" id="L724" title="1 of 4 branches missed.">            } else if (methodName.length() &gt;= 5 &amp;&amp; Character.isUpperCase(methodName.charAt(4))) {</span>
<span class="fc" id="L725">                propertyName = TypeUtils.decapitalize(methodName.substring(3));</span>
            } else {
                continue;
            }

<span class="fc" id="L730">            Field field = TypeUtils.getField(clazz, propertyName, declaredFields);</span>
<span class="fc bfc" id="L731" title="All 4 branches covered.">            if (field == null &amp;&amp; types[0] == boolean.class) {</span>
<span class="fc" id="L732">                String isFieldName = &quot;is&quot; + Character.toUpperCase(propertyName.charAt(0)) + propertyName.substring(1);</span>
<span class="fc" id="L733">                field = TypeUtils.getField(clazz, isFieldName, declaredFields);</span>
            }

<span class="fc" id="L736">            JSONField fieldAnnotation = null;</span>
<span class="fc bfc" id="L737" title="All 2 branches covered.">            if (field != null) {</span>
<span class="fc" id="L738">                fieldAnnotation = TypeUtils.getAnnotation(field, JSONField.class);</span>

<span class="fc bfc" id="L740" title="All 2 branches covered.">                if (fieldAnnotation != null) {</span>
<span class="fc bfc" id="L741" title="All 2 branches covered.">                    if (!fieldAnnotation.deserialize()) {</span>
<span class="fc" id="L742">                        continue;</span>
                    }

<span class="fc" id="L745">                    ordinal = fieldAnnotation.ordinal();</span>
<span class="fc" id="L746">                    serialzeFeatures = SerializerFeature.of(fieldAnnotation.serialzeFeatures());</span>
<span class="fc" id="L747">                    parserFeatures = Feature.of(fieldAnnotation.parseFeatures());</span>

<span class="fc bfc" id="L749" title="All 2 branches covered.">                    if (fieldAnnotation.name().length() != 0) {</span>
<span class="fc" id="L750">                        propertyName = fieldAnnotation.name();</span>
<span class="fc" id="L751">                        add(fieldList, new FieldInfo(propertyName, method, field, clazz, type, ordinal,</span>
                                serialzeFeatures, parserFeatures, annotation, fieldAnnotation, null));
<span class="fc" id="L753">                        continue;</span>
                    }
                }

            }

<span class="fc bfc" id="L759" title="All 2 branches covered.">            if (propertyNamingStrategy != null) {</span>
<span class="fc" id="L760">                propertyName = propertyNamingStrategy.translate(propertyName);</span>
            }

<span class="fc" id="L763">            add(fieldList, new FieldInfo(propertyName, method, field, clazz, type, ordinal, serialzeFeatures, parserFeatures,</span>
                    annotation, fieldAnnotation, null));
        }

<span class="fc" id="L767">        Field[] fields = clazz.getFields();</span>
<span class="fc" id="L768">        computeFields(clazz, type, propertyNamingStrategy, fieldList, fields);</span>

<span class="fc bfc" id="L770" title="All 2 branches covered.">        for (Method method : clazz.getMethods()) { // getter methods</span>
<span class="fc" id="L771">            String methodName = method.getName();</span>
<span class="fc bfc" id="L772" title="All 2 branches covered.">            if (methodName.length() &lt; 4) {</span>
<span class="fc" id="L773">                continue;</span>
            }

<span class="fc bfc" id="L776" title="All 2 branches covered.">            if (Modifier.isStatic(method.getModifiers())) {</span>
<span class="fc" id="L777">                continue;</span>
            }

<span class="fc bfc" id="L780" title="All 6 branches covered.">            if (builderClass == null &amp;&amp; methodName.startsWith(&quot;get&quot;) &amp;&amp; Character.isUpperCase(methodName.charAt(3))) {</span>
<span class="fc bfc" id="L781" title="All 2 branches covered.">                if (method.getParameterTypes().length != 0) {</span>
<span class="fc" id="L782">                    continue;</span>
                }

<span class="fc bfc" id="L785" title="All 2 branches covered.">                if (Collection.class.isAssignableFrom(method.getReturnType()) //</span>
<span class="fc bfc" id="L786" title="All 2 branches covered.">                        || Map.class.isAssignableFrom(method.getReturnType()) //</span>
<span class="fc bfc" id="L787" title="All 2 branches covered.">                        || AtomicBoolean.class == method.getReturnType() //</span>
<span class="fc bfc" id="L788" title="All 2 branches covered.">                        || AtomicInteger.class == method.getReturnType() //</span>
<span class="fc bfc" id="L789" title="All 2 branches covered.">                        || AtomicLong.class == method.getReturnType() //</span>
                        ) {
                    String propertyName;

<span class="fc" id="L793">                    JSONField annotation = TypeUtils.getAnnotation(method, JSONField.class);</span>
<span class="pc bpc" id="L794" title="1 of 4 branches missed.">                    if (annotation != null &amp;&amp; annotation.deserialize()) {</span>
<span class="fc" id="L795">                        continue;</span>
                    }

<span class="pc bpc" id="L798" title="3 of 4 branches missed.">                    if (annotation != null &amp;&amp; annotation.name().length() &gt; 0) {</span>
<span class="nc" id="L799">                        propertyName = annotation.name();</span>
                    } else {
<span class="fc" id="L801">                        propertyName = Character.toLowerCase(methodName.charAt(3)) + methodName.substring(4);</span>

<span class="fc" id="L803">                        Field field = TypeUtils.getField(clazz, propertyName, declaredFields);</span>
<span class="fc bfc" id="L804" title="All 2 branches covered.">                        if (field != null) {</span>
<span class="fc" id="L805">                            JSONField fieldAnnotation = TypeUtils.getAnnotation(field, JSONField.class);</span>
<span class="fc bfc" id="L806" title="All 4 branches covered.">                            if (fieldAnnotation != null &amp;&amp; !fieldAnnotation.deserialize()) {</span>
<span class="fc" id="L807">                                continue;</span>
                            }
                        }
                    }

<span class="fc bfc" id="L812" title="All 2 branches covered.">                    if (propertyNamingStrategy != null) {</span>
<span class="fc" id="L813">                        propertyName = propertyNamingStrategy.translate(propertyName);</span>
                    }

<span class="fc" id="L816">                    FieldInfo fieldInfo = getField(fieldList, propertyName);</span>
<span class="fc bfc" id="L817" title="All 2 branches covered.">                    if (fieldInfo != null) {</span>
<span class="fc" id="L818">                        continue;</span>
                    }

<span class="fc" id="L821">                    add(fieldList, new FieldInfo(propertyName, method, null, clazz, type, 0, 0, 0, annotation, null, null));</span>
                }
            }
        }

<span class="fc bfc" id="L826" title="All 2 branches covered.">        if (fieldList.size() == 0) {</span>
<span class="fc bfc" id="L827" title="All 2 branches covered.">            if (TypeUtils.isXmlField(clazz)) {</span>
<span class="fc" id="L828">                fieldBased = true;</span>
            }

<span class="fc bfc" id="L831" title="All 2 branches covered.">            if (fieldBased) {</span>
<span class="fc bfc" id="L832" title="All 2 branches covered.">                for (Class&lt;?&gt; currentClass = clazz; currentClass != null; currentClass = currentClass.getSuperclass()) {</span>
<span class="fc" id="L833">                    computeFields(clazz, type, propertyNamingStrategy, fieldList, declaredFields);</span>
                }
            }
        }

<span class="fc" id="L838">        return new JavaBeanInfo(clazz, builderClass, defaultConstructor, creatorConstructor, factoryMethod, buildMethod, jsonType, fieldList);</span>
    }

    private static void computeFields(Class&lt;?&gt; clazz, Type type, PropertyNamingStrategy propertyNamingStrategy, List&lt;FieldInfo&gt; fieldList, Field[] fields) {
<span class="fc bfc" id="L842" title="All 2 branches covered.">        for (Field field : fields) { // public static fields</span>
<span class="fc" id="L843">            int modifiers = field.getModifiers();</span>
<span class="fc bfc" id="L844" title="All 2 branches covered.">            if ((modifiers &amp; Modifier.STATIC) != 0) {</span>
<span class="fc" id="L845">                continue;</span>
            }

<span class="fc bfc" id="L848" title="All 2 branches covered.">            if ((modifiers &amp; Modifier.FINAL) != 0) {</span>
<span class="fc" id="L849">                Class&lt;?&gt; fieldType = field.getType();</span>
<span class="fc bfc" id="L850" title="All 2 branches covered.">                boolean supportReadOnly = Map.class.isAssignableFrom(fieldType)</span>
<span class="fc bfc" id="L851" title="All 2 branches covered.">                        || Collection.class.isAssignableFrom(fieldType)</span>
<span class="fc bfc" id="L852" title="All 2 branches covered.">                        || AtomicLong.class.equals(fieldType) //</span>
<span class="fc bfc" id="L853" title="All 2 branches covered.">                        || AtomicInteger.class.equals(fieldType) //</span>
<span class="fc bfc" id="L854" title="All 2 branches covered.">                        || AtomicBoolean.class.equals(fieldType);</span>
<span class="fc bfc" id="L855" title="All 2 branches covered.">                if (!supportReadOnly) {</span>
<span class="fc" id="L856">                    continue;</span>
                }
            }

<span class="fc" id="L860">            boolean contains = false;</span>
<span class="fc bfc" id="L861" title="All 2 branches covered.">            for (FieldInfo item : fieldList) {</span>
<span class="fc bfc" id="L862" title="All 2 branches covered.">                if (item.name.equals(field.getName())) {</span>
<span class="fc" id="L863">                    contains = true;</span>
<span class="fc" id="L864">                    break; // 已经是 contains = true，无需继续遍历</span>
                }
<span class="fc" id="L866">            }</span>

<span class="fc bfc" id="L868" title="All 2 branches covered.">            if (contains) {</span>
<span class="fc" id="L869">                continue;</span>
            }

<span class="fc" id="L872">            int ordinal = 0, serialzeFeatures = 0, parserFeatures = 0;</span>
<span class="fc" id="L873">            String propertyName = field.getName();</span>

<span class="fc" id="L875">            JSONField fieldAnnotation = TypeUtils.getAnnotation(field, JSONField.class);</span>

<span class="fc bfc" id="L877" title="All 2 branches covered.">            if (fieldAnnotation != null) {</span>
<span class="fc bfc" id="L878" title="All 2 branches covered.">                if (!fieldAnnotation.deserialize()) {</span>
<span class="fc" id="L879">                    continue;</span>
                }

<span class="fc" id="L882">                ordinal = fieldAnnotation.ordinal();</span>
<span class="fc" id="L883">                serialzeFeatures = SerializerFeature.of(fieldAnnotation.serialzeFeatures());</span>
<span class="fc" id="L884">                parserFeatures = Feature.of(fieldAnnotation.parseFeatures());</span>

<span class="fc bfc" id="L886" title="All 2 branches covered.">                if (fieldAnnotation.name().length() != 0) {</span>
<span class="fc" id="L887">                    propertyName = fieldAnnotation.name();</span>
                }
            }

<span class="fc bfc" id="L891" title="All 2 branches covered.">            if (propertyNamingStrategy != null) {</span>
<span class="fc" id="L892">                propertyName = propertyNamingStrategy.translate(propertyName);</span>
            }

<span class="fc" id="L895">            add(fieldList, new FieldInfo(propertyName, null, field, clazz, type, ordinal, serialzeFeatures, parserFeatures, null,</span>
                    fieldAnnotation, null));
        }
<span class="fc" id="L898">    }</span>

    static Constructor&lt;?&gt; getDefaultConstructor(Class&lt;?&gt; clazz, final Constructor&lt;?&gt;[] constructors) {
<span class="fc bfc" id="L901" title="All 2 branches covered.">        if (Modifier.isAbstract(clazz.getModifiers())) {</span>
<span class="fc" id="L902">            return null;</span>
        }

<span class="fc" id="L905">        Constructor&lt;?&gt; defaultConstructor = null;</span>

<span class="fc bfc" id="L907" title="All 2 branches covered.">        for (Constructor&lt;?&gt; constructor : constructors) {</span>
<span class="fc bfc" id="L908" title="All 2 branches covered.">            if (constructor.getParameterTypes().length == 0) {</span>
<span class="fc" id="L909">                defaultConstructor = constructor;</span>
<span class="fc" id="L910">                break;</span>
            }
        }

<span class="fc bfc" id="L914" title="All 2 branches covered.">        if (defaultConstructor == null) {</span>
<span class="fc bfc" id="L915" title="All 4 branches covered.">            if (clazz.isMemberClass() &amp;&amp; !Modifier.isStatic(clazz.getModifiers())) {</span>
                Class&lt;?&gt;[] types;
<span class="fc bfc" id="L917" title="All 2 branches covered.">                for (Constructor&lt;?&gt; constructor : constructors) {</span>
<span class="fc bfc" id="L918" title="All 2 branches covered.">                    if ((types = constructor.getParameterTypes()).length == 1</span>
<span class="pc bpc" id="L919" title="1 of 2 branches missed.">                            &amp;&amp; types[0].equals(clazz.getDeclaringClass())) {</span>
<span class="fc" id="L920">                        defaultConstructor = constructor;</span>
<span class="fc" id="L921">                        break;</span>
                    }
                }
            }
        }

<span class="fc" id="L927">        return defaultConstructor;</span>
    }

    public static Constructor&lt;?&gt; getCreatorConstructor(Constructor[] constructors) {
<span class="fc" id="L931">        Constructor&lt;?&gt; creatorConstructor = null;</span>

<span class="fc bfc" id="L933" title="All 2 branches covered.">        for (Constructor&lt;?&gt; constructor : constructors) {</span>
<span class="fc" id="L934">            JSONCreator annotation = constructor.getAnnotation(JSONCreator.class);</span>
<span class="fc bfc" id="L935" title="All 2 branches covered.">            if (annotation != null) {</span>
<span class="pc bpc" id="L936" title="1 of 2 branches missed.">                if (creatorConstructor != null) {</span>
<span class="nc" id="L937">                    throw new JSONException(&quot;multi-JSONCreator&quot;);</span>
                }

<span class="fc" id="L940">                creatorConstructor = constructor;</span>
                // 不应该break，否则多个构造方法上存在 JSONCreator 注解时，并不会触发上述异常抛出
            }
        }
<span class="fc bfc" id="L944" title="All 2 branches covered.">        if (creatorConstructor != null) {</span>
<span class="fc" id="L945">            return creatorConstructor;</span>
        }

<span class="fc bfc" id="L948" title="All 2 branches covered.">        for (Constructor constructor : constructors) {</span>
<span class="fc" id="L949">            Annotation[][] paramAnnotationArrays = TypeUtils.getParameterAnnotations(constructor);</span>
<span class="fc bfc" id="L950" title="All 2 branches covered.">            if (paramAnnotationArrays.length == 0) {</span>
<span class="fc" id="L951">                continue;</span>
            }
<span class="fc" id="L953">            boolean match = true;</span>
<span class="fc bfc" id="L954" title="All 2 branches covered.">            for (Annotation[] paramAnnotationArray : paramAnnotationArrays) {</span>
<span class="fc" id="L955">                boolean paramMatch = false;</span>
<span class="pc bfc" id="L956" title="All 2 branches covered.">                for (Annotation paramAnnotation : paramAnnotationArray) {</span>
<span class="pc bpc" id="L957" title="1 of 2 branches missed.">                    if (paramAnnotation instanceof JSONField) {</span>
<span class="fc" id="L958">                        paramMatch = true;</span>
<span class="fc" id="L959">                        break;</span>
                    }
                }
<span class="fc bfc" id="L962" title="All 2 branches covered.">                if (!paramMatch) {</span>
<span class="fc" id="L963">                    match = false;</span>
<span class="fc" id="L964">                    break;</span>
                }
            }

<span class="fc bfc" id="L968" title="All 2 branches covered.">            if (match) {</span>
<span class="pc bpc" id="L969" title="1 of 2 branches missed.">                if (creatorConstructor != null) {</span>
<span class="nc" id="L970">                    throw new JSONException(&quot;multi-JSONCreator&quot;);</span>
                }

<span class="fc" id="L973">                creatorConstructor = constructor;</span>
            }
        }

<span class="fc bfc" id="L977" title="All 2 branches covered.">        if (creatorConstructor != null) {</span>
<span class="fc" id="L978">            return creatorConstructor;</span>
        }

<span class="fc" id="L981">        return creatorConstructor;</span>
    }

    private static Method getFactoryMethod(Class&lt;?&gt; clazz, Method[] methods, boolean jacksonCompatible) {
<span class="fc" id="L985">        Method factoryMethod = null;</span>

<span class="fc bfc" id="L987" title="All 2 branches covered.">        for (Method method : methods) {</span>
<span class="fc bfc" id="L988" title="All 2 branches covered.">            if (!Modifier.isStatic(method.getModifiers())) {</span>
<span class="fc" id="L989">                continue;</span>
            }

<span class="fc bfc" id="L992" title="All 2 branches covered.">            if (!clazz.isAssignableFrom(method.getReturnType())) {</span>
<span class="fc" id="L993">                continue;</span>
            }

<span class="fc" id="L996">            JSONCreator annotation = TypeUtils.getAnnotation(method, JSONCreator.class);</span>
<span class="fc bfc" id="L997" title="All 2 branches covered.">            if (annotation != null) {</span>
<span class="fc bfc" id="L998" title="All 2 branches covered.">                if (factoryMethod != null) {</span>
<span class="fc" id="L999">                    throw new JSONException(&quot;multi-JSONCreator&quot;);</span>
                }

<span class="fc" id="L1002">                factoryMethod = method;</span>
                // 不应该break，否则多个静态工厂方法上存在 JSONCreator 注解时，并不会触发上述异常抛出
            }
        }

<span class="fc bfc" id="L1007" title="All 4 branches covered.">        if (factoryMethod == null &amp;&amp; jacksonCompatible) {</span>
<span class="pc bpc" id="L1008" title="1 of 2 branches missed.">            for (Method method : methods) {</span>
<span class="fc bfc" id="L1009" title="All 2 branches covered.">                if (TypeUtils.isJacksonCreator(method)) {</span>
<span class="fc" id="L1010">                    factoryMethod = method;</span>
<span class="fc" id="L1011">                    break;</span>
                }
            }
        }
<span class="fc" id="L1015">        return factoryMethod;</span>
    }

    /**
     * @deprecated
     */
    public static Class&lt;?&gt; getBuilderClass(JSONType type) {
<span class="fc" id="L1022">        return getBuilderClass(null, type);</span>
    }

    public static Class&lt;?&gt; getBuilderClass(Class&lt;?&gt; clazz, JSONType type) {
<span class="fc bfc" id="L1026" title="All 4 branches covered.">        if (clazz != null &amp;&amp; clazz.getName().equals(&quot;org.springframework.security.web.savedrequest.DefaultSavedRequest&quot;)) {</span>
<span class="fc" id="L1027">            return TypeUtils.loadClass(&quot;org.springframework.security.web.savedrequest.DefaultSavedRequest$Builder&quot;);</span>
        }

<span class="fc bfc" id="L1030" title="All 2 branches covered.">        if (type == null) {</span>
<span class="fc" id="L1031">            return null;</span>
        }

<span class="fc" id="L1034">        Class&lt;?&gt; builderClass = type.builder();</span>

<span class="fc bfc" id="L1036" title="All 2 branches covered.">        if (builderClass == Void.class) {</span>
<span class="fc" id="L1037">            return null;</span>
        }

<span class="fc" id="L1040">        return builderClass;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.5.201910111838</span></div></body></html>