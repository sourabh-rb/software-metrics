<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>JavaBeanInfo.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">fastjson</a> &gt; <a href="index.source.html" class="el_package">com.alibaba.fastjson.util</a> &gt; <span class="el_source">JavaBeanInfo.java</span></div><h1>JavaBeanInfo.java</h1><pre class="source lang-java linenums">package com.alibaba.fastjson.util;

import java.lang.annotation.Annotation;
import java.lang.reflect.Constructor;
import java.lang.reflect.Field;
import java.lang.reflect.Method;
import java.lang.reflect.Modifier;
import java.lang.reflect.Type;
import java.util.*;
import java.util.concurrent.atomic.AtomicBoolean;
import java.util.concurrent.atomic.AtomicInteger;
import java.util.concurrent.atomic.AtomicLong;

import com.alibaba.fastjson.JSONException;
import com.alibaba.fastjson.PropertyNamingStrategy;
import com.alibaba.fastjson.annotation.JSONCreator;
import com.alibaba.fastjson.annotation.JSONField;
import com.alibaba.fastjson.annotation.JSONPOJOBuilder;
import com.alibaba.fastjson.annotation.JSONType;
import com.alibaba.fastjson.parser.Feature;
import com.alibaba.fastjson.serializer.SerializerFeature;

import javax.xml.bind.annotation.XmlAccessType;
import javax.xml.bind.annotation.XmlAccessorType;

public class JavaBeanInfo {

    public final Class&lt;?&gt; clazz;
    public final Class&lt;?&gt; builderClass;
    public final Constructor&lt;?&gt; defaultConstructor;
    public final Constructor&lt;?&gt; creatorConstructor;
    public final Method factoryMethod;
    public final Method buildMethod;

    public final int defaultConstructorParameterSize;

    public final FieldInfo[] fields;
    public final FieldInfo[] sortedFields;

    public final int parserFeatures;

    public final JSONType jsonType;

    public final String typeName;
    public final String typeKey;

    public String[] orders;

    public Type[] creatorConstructorParameterTypes;
    public String[] creatorConstructorParameters;

    public boolean kotlin;
    public Constructor&lt;?&gt; kotlinDefaultConstructor;

    public JavaBeanInfo(Class&lt;?&gt; clazz, //
                        Class&lt;?&gt; builderClass, //
                        Constructor&lt;?&gt; defaultConstructor, //
                        Constructor&lt;?&gt; creatorConstructor, //
                        Method factoryMethod, //
                        Method buildMethod, //
                        JSONType jsonType, //
<span class="fc" id="L62">                        List&lt;FieldInfo&gt; fieldList) {</span>
<span class="fc" id="L63">        this.clazz = clazz;</span>
<span class="fc" id="L64">        this.builderClass = builderClass;</span>
<span class="fc" id="L65">        this.defaultConstructor = defaultConstructor;</span>
<span class="fc" id="L66">        this.creatorConstructor = creatorConstructor;</span>
<span class="fc" id="L67">        this.factoryMethod = factoryMethod;</span>
<span class="fc" id="L68">        this.parserFeatures = TypeUtils.getParserFeatures(clazz);</span>
<span class="fc" id="L69">        this.buildMethod = buildMethod;</span>

<span class="fc" id="L71">        this.jsonType = jsonType;</span>
<span class="fc bfc" id="L72" title="All 2 branches covered.">        if (jsonType != null) {</span>
<span class="fc" id="L73">            String typeName = jsonType.typeName();</span>
<span class="fc" id="L74">            String typeKey = jsonType.typeKey();</span>
<span class="fc bfc" id="L75" title="All 2 branches covered.">            this.typeKey = typeKey.length() &gt; 0 ? typeKey : null;</span>

<span class="fc bfc" id="L77" title="All 2 branches covered.">            if (typeName.length() != 0) {</span>
<span class="fc" id="L78">                this.typeName = typeName;</span>
            } else {
<span class="fc" id="L80">                this.typeName = clazz.getName();</span>
            }
<span class="fc" id="L82">            String[] orders = jsonType.orders();</span>
<span class="fc bfc" id="L83" title="All 2 branches covered.">            this.orders = orders.length == 0 ? null : orders;</span>
<span class="fc" id="L84">        } else {</span>
<span class="fc" id="L85">            this.typeName = clazz.getName();</span>
<span class="fc" id="L86">            this.typeKey = null;</span>
<span class="fc" id="L87">            this.orders = null;</span>
        }

<span class="fc" id="L90">        fields = new FieldInfo[fieldList.size()];</span>
<span class="fc" id="L91">        fieldList.toArray(fields);</span>

<span class="fc" id="L93">        FieldInfo[] sortedFields = new FieldInfo[fields.length];</span>
<span class="fc bfc" id="L94" title="All 2 branches covered.">        if (orders != null) {</span>
<span class="fc" id="L95">            LinkedHashMap&lt;String, FieldInfo&gt; map = new LinkedHashMap&lt;String, FieldInfo&gt;(fieldList.size());</span>
<span class="fc bfc" id="L96" title="All 2 branches covered.">            for (FieldInfo field : fields) {</span>
<span class="fc" id="L97">                map.put(field.name, field);</span>
            }
<span class="fc" id="L99">            int i = 0;</span>
<span class="fc bfc" id="L100" title="All 2 branches covered.">            for (String item : orders) {</span>
<span class="fc" id="L101">                FieldInfo field = map.get(item);</span>
<span class="fc bfc" id="L102" title="All 2 branches covered.">                if (field != null) {</span>
<span class="fc" id="L103">                    sortedFields[i++] = field;</span>
<span class="fc" id="L104">                    map.remove(item);</span>
                }
            }
<span class="fc bfc" id="L107" title="All 2 branches covered.">            for (FieldInfo field : map.values()) {</span>
<span class="fc" id="L108">                sortedFields[i++] = field;</span>
<span class="fc" id="L109">            }</span>
<span class="fc" id="L110">        } else {</span>
<span class="fc" id="L111">            System.arraycopy(fields, 0, sortedFields, 0, fields.length);</span>
<span class="fc" id="L112">            Arrays.sort(sortedFields);</span>
        }

<span class="fc bfc" id="L115" title="All 2 branches covered.">        if (Arrays.equals(fields, sortedFields)) {</span>
<span class="fc" id="L116">            sortedFields = fields;</span>
        }
<span class="fc" id="L118">        this.sortedFields = sortedFields;</span>

<span class="fc bfc" id="L120" title="All 2 branches covered.">        if (defaultConstructor != null) {</span>
<span class="fc" id="L121">            defaultConstructorParameterSize = defaultConstructor.getParameterTypes().length;</span>
<span class="fc bfc" id="L122" title="All 2 branches covered.">        } else if (factoryMethod != null) {</span>
<span class="fc" id="L123">            defaultConstructorParameterSize = factoryMethod.getParameterTypes().length;</span>
        } else {
<span class="fc" id="L125">            defaultConstructorParameterSize = 0;</span>
        }

<span class="fc bfc" id="L128" title="All 2 branches covered.">        if (creatorConstructor != null) {</span>
<span class="fc" id="L129">            this.creatorConstructorParameterTypes = creatorConstructor.getParameterTypes();</span>


<span class="fc" id="L132">            kotlin = TypeUtils.isKotlin(clazz);</span>
<span class="fc bfc" id="L133" title="All 2 branches covered.">            if (kotlin) {</span>
<span class="fc" id="L134">                this.creatorConstructorParameters = TypeUtils.getKoltinConstructorParameters(clazz);</span>
                try {
<span class="fc" id="L136">                    this.kotlinDefaultConstructor = clazz.getConstructor();</span>
<span class="fc" id="L137">                } catch (Throwable ex) {</span>
                    // skip
<span class="fc" id="L139">                }</span>

<span class="fc" id="L141">                Annotation[][] paramAnnotationArrays = creatorConstructor.getParameterAnnotations();</span>
<span class="pc bpc" id="L142" title="1 of 4 branches missed.">                for (int i = 0; i &lt; creatorConstructorParameters.length &amp;&amp; i &lt; paramAnnotationArrays.length; ++i) {</span>
<span class="fc" id="L143">                    Annotation[] paramAnnotations = paramAnnotationArrays[i];</span>
<span class="fc" id="L144">                    JSONField fieldAnnotation = null;</span>
<span class="pc bfc" id="L145" title="All 2 branches covered.">                    for (Annotation paramAnnotation : paramAnnotations) {</span>
<span class="pc bpc" id="L146" title="1 of 2 branches missed.">                        if (paramAnnotation instanceof JSONField) {</span>
<span class="fc" id="L147">                            fieldAnnotation = (JSONField) paramAnnotation;</span>
<span class="fc" id="L148">                            break;</span>
                        }
                    }
<span class="fc bfc" id="L151" title="All 2 branches covered.">                    if (fieldAnnotation != null) {</span>
<span class="fc" id="L152">                        String fieldAnnotationName = fieldAnnotation.name();</span>
<span class="pc bpc" id="L153" title="1 of 2 branches missed.">                        if (fieldAnnotationName.length() &gt; 0) {</span>
<span class="fc" id="L154">                            creatorConstructorParameters[i] = fieldAnnotationName;</span>
                        }
                    }
                }
<span class="fc" id="L158">            } else {</span>
                boolean match;
<span class="fc bfc" id="L160" title="All 2 branches covered.">                if (creatorConstructorParameterTypes.length != fields.length) {</span>
<span class="fc" id="L161">                    match = false;</span>
                } else {
<span class="fc" id="L163">                    match = true;</span>
<span class="fc bfc" id="L164" title="All 2 branches covered.">                    for (int i = 0; i &lt; creatorConstructorParameterTypes.length; i++) {</span>
<span class="fc bfc" id="L165" title="All 2 branches covered.">                        if (creatorConstructorParameterTypes[i] != fields[i].fieldClass) {</span>
<span class="fc" id="L166">                            match = false;</span>
<span class="fc" id="L167">                            break;</span>
                        }
                    }
                }

<span class="fc bfc" id="L172" title="All 2 branches covered.">                if (!match) {</span>
<span class="fc" id="L173">                    this.creatorConstructorParameters = ASMUtils.lookupParameterNames(creatorConstructor);</span>
                }
            }
        }
<span class="fc" id="L177">    }</span>

    private static FieldInfo getField(List&lt;FieldInfo&gt; fieldList, String propertyName) {
<span class="fc bfc" id="L180" title="All 2 branches covered.">        for (FieldInfo item : fieldList) {</span>
<span class="fc bfc" id="L181" title="All 2 branches covered.">            if (item.name.equals(propertyName)) {</span>
<span class="fc" id="L182">                return item;</span>
            }

<span class="fc" id="L185">            Field field = item.field;</span>
<span class="fc bfc" id="L186" title="All 6 branches covered.">            if (field != null &amp;&amp; item.getAnnotation() != null &amp;&amp; field.getName().equals(propertyName)) {</span>
<span class="fc" id="L187">                return item;</span>
            }
<span class="fc" id="L189">        }</span>
<span class="fc" id="L190">        return null;</span>
    }


    static boolean add(List&lt;FieldInfo&gt; fieldList, FieldInfo field) {
<span class="fc bfc" id="L195" title="All 2 branches covered.">        for (int i = fieldList.size() - 1; i &gt;= 0; --i) {</span>
<span class="fc" id="L196">            FieldInfo item = fieldList.get(i);</span>

<span class="fc bfc" id="L198" title="All 2 branches covered.">            if (item.name.equals(field.name)) {</span>
<span class="pc bpc" id="L199" title="3 of 4 branches missed.">                if (item.getOnly &amp;&amp; !field.getOnly) {</span>
<span class="nc" id="L200">                    continue;</span>
                }

<span class="fc bfc" id="L203" title="All 2 branches covered.">                if (item.fieldClass.isAssignableFrom(field.fieldClass)) {</span>
<span class="fc" id="L204">                    fieldList.set(i, field);</span>
<span class="fc" id="L205">                    return true;</span>
                }

<span class="fc" id="L208">                int result = item.compareTo(field);</span>

<span class="fc bfc" id="L210" title="All 2 branches covered.">                if (result &lt; 0) {</span>
<span class="fc" id="L211">                    fieldList.set(i, field);</span>
<span class="fc" id="L212">                    return true;</span>
                } else {
<span class="fc" id="L214">                    return false;</span>
                }
            }
        }
<span class="fc" id="L218">        fieldList.add(field);</span>

<span class="fc" id="L220">        return true;</span>
    }

    public static JavaBeanInfo build(Class&lt;?&gt; clazz, Type type, PropertyNamingStrategy propertyNamingStrategy) {
<span class="fc" id="L224">        return build(clazz, type, propertyNamingStrategy, false, TypeUtils.compatibleWithJavaBean, false);</span>
    }

    public static JavaBeanInfo build(Class&lt;?&gt; clazz //
            , Type type //
            , PropertyNamingStrategy propertyNamingStrategy //
            , boolean fieldBased //
            , boolean compatibleWithJavaBean
    ) {
<span class="nc" id="L233">        return build(clazz, type, propertyNamingStrategy, fieldBased, compatibleWithJavaBean, false);</span>
    }

    public static JavaBeanInfo build(Class&lt;?&gt; clazz //
            , Type type //
            , PropertyNamingStrategy propertyNamingStrategy //
            , boolean fieldBased //
            , boolean compatibleWithJavaBean
            , boolean jacksonCompatible
    ) {
<span class="fc" id="L243">        JSONType jsonType = TypeUtils.getAnnotation(clazz,JSONType.class);</span>
<span class="fc bfc" id="L244" title="All 2 branches covered.">        if (jsonType != null) {</span>
<span class="fc" id="L245">            PropertyNamingStrategy jsonTypeNaming = jsonType.naming();</span>
<span class="pc bpc" id="L246" title="1 of 4 branches missed.">            if (jsonTypeNaming != null &amp;&amp; jsonTypeNaming != PropertyNamingStrategy.CamelCase) {</span>
<span class="fc" id="L247">                propertyNamingStrategy = jsonTypeNaming;</span>
            }
        }

<span class="fc" id="L251">        Class&lt;?&gt; builderClass = getBuilderClass(clazz, jsonType);</span>

<span class="fc" id="L253">        Field[] declaredFields = clazz.getDeclaredFields();</span>
<span class="fc" id="L254">        Method[] methods = clazz.getMethods();</span>

<span class="fc" id="L256">        boolean kotlin = TypeUtils.isKotlin(clazz);</span>
<span class="fc" id="L257">        Constructor[] constructors = clazz.getDeclaredConstructors();</span>

<span class="fc" id="L259">        Constructor&lt;?&gt; defaultConstructor = null;</span>
<span class="fc bfc" id="L260" title="All 4 branches covered.">        if ((!kotlin) || constructors.length == 1) {</span>
<span class="fc bfc" id="L261" title="All 2 branches covered.">            if (builderClass == null) {</span>
<span class="fc" id="L262">                defaultConstructor = getDefaultConstructor(clazz, constructors);</span>
            } else {
<span class="fc" id="L264">                defaultConstructor = getDefaultConstructor(builderClass, builderClass.getDeclaredConstructors());</span>
            }
        }

<span class="fc" id="L268">        Constructor&lt;?&gt; creatorConstructor = null;</span>
<span class="fc" id="L269">        Method buildMethod = null;</span>
<span class="fc" id="L270">        Method factoryMethod = null;</span>

<span class="fc" id="L272">        List&lt;FieldInfo&gt; fieldList = new ArrayList&lt;FieldInfo&gt;();</span>

<span class="fc bfc" id="L274" title="All 2 branches covered.">        if (fieldBased) {</span>
<span class="fc bfc" id="L275" title="All 2 branches covered.">            for (Class&lt;?&gt; currentClass = clazz; currentClass != null; currentClass = currentClass.getSuperclass()) {</span>
<span class="fc" id="L276">                Field[] fields = currentClass.getDeclaredFields();</span>

<span class="fc" id="L278">                computeFields(clazz, type, propertyNamingStrategy, fieldList, fields);</span>
            }
<span class="fc" id="L280">            return new JavaBeanInfo(clazz, builderClass, defaultConstructor, null, factoryMethod, buildMethod, jsonType, fieldList);</span>
        }

<span class="fc bfc" id="L283" title="All 4 branches covered.">        boolean isInterfaceOrAbstract = clazz.isInterface() || Modifier.isAbstract(clazz.getModifiers());</span>
<span class="pc bpc" id="L284" title="2 of 6 branches missed.">        if ((defaultConstructor == null &amp;&amp; builderClass == null) || isInterfaceOrAbstract) {</span>
<span class="fc" id="L285">            creatorConstructor = getCreatorConstructor(constructors);</span>

<span class="pc bpc" id="L287" title="1 of 4 branches missed.">            if (creatorConstructor != null &amp;&amp; !isInterfaceOrAbstract) { // 基于标记 JSONCreator 注解的构造方法</span>
<span class="fc" id="L288">                TypeUtils.setAccessible(creatorConstructor);</span>

<span class="fc" id="L290">                Class&lt;?&gt;[] types = creatorConstructor.getParameterTypes();</span>

<span class="fc" id="L292">                String[] lookupParameterNames = null;</span>
<span class="pc bpc" id="L293" title="1 of 2 branches missed.">                if (types.length &gt; 0) {</span>
<span class="fc" id="L294">                    Annotation[][] paramAnnotationArrays = creatorConstructor.getParameterAnnotations();</span>
<span class="fc bfc" id="L295" title="All 2 branches covered.">                    for (int i = 0; i &lt; types.length; ++i) {</span>
<span class="fc" id="L296">                        Annotation[] paramAnnotations = paramAnnotationArrays[i];</span>
<span class="fc" id="L297">                        JSONField fieldAnnotation = null;</span>
<span class="pc bfc" id="L298" title="All 2 branches covered.">                        for (Annotation paramAnnotation : paramAnnotations) {</span>
<span class="pc bpc" id="L299" title="1 of 2 branches missed.">                            if (paramAnnotation instanceof JSONField) {</span>
<span class="fc" id="L300">                                fieldAnnotation = (JSONField) paramAnnotation;</span>
<span class="fc" id="L301">                                break;</span>
                            }
                        }

<span class="fc" id="L305">                        Class&lt;?&gt; fieldClass = types[i];</span>
<span class="fc" id="L306">                        Type fieldType = creatorConstructor.getGenericParameterTypes()[i];</span>

<span class="fc" id="L308">                        String fieldName = null;</span>
<span class="fc" id="L309">                        Field field = null;</span>
<span class="fc" id="L310">                        int ordinal = 0, serialzeFeatures = 0, parserFeatures = 0;</span>
<span class="fc bfc" id="L311" title="All 2 branches covered.">                        if (fieldAnnotation != null) {</span>
<span class="fc" id="L312">                            field = TypeUtils.getField(clazz, fieldAnnotation.name(), declaredFields);</span>
<span class="fc" id="L313">                            ordinal = fieldAnnotation.ordinal();</span>
<span class="fc" id="L314">                            serialzeFeatures = SerializerFeature.of(fieldAnnotation.serialzeFeatures());</span>
<span class="fc" id="L315">                            parserFeatures = Feature.of(fieldAnnotation.parseFeatures());</span>
<span class="fc" id="L316">                            fieldName = fieldAnnotation.name();</span>
                        }

<span class="fc bfc" id="L319" title="All 4 branches covered.">                        if (fieldName == null || fieldName.length() == 0) {</span>
<span class="pc bpc" id="L320" title="1 of 2 branches missed.">                            if (lookupParameterNames == null) {</span>
<span class="fc" id="L321">                                lookupParameterNames = ASMUtils.lookupParameterNames(creatorConstructor);</span>
                            }
<span class="fc" id="L323">                            fieldName = lookupParameterNames[i];</span>
                        }

<span class="fc bfc" id="L326" title="All 2 branches covered.">                        if (field == null) {</span>
<span class="fc bfc" id="L327" title="All 2 branches covered.">                            if (lookupParameterNames == null) {</span>
<span class="fc bfc" id="L328" title="All 2 branches covered.">                                if (kotlin) {</span>
<span class="fc" id="L329">                                    lookupParameterNames = TypeUtils.getKoltinConstructorParameters(clazz);</span>
                                } else {
<span class="fc" id="L331">                                    lookupParameterNames = ASMUtils.lookupParameterNames(creatorConstructor);</span>
                                }
                            }

<span class="pc bpc" id="L335" title="1 of 2 branches missed.">                            if (lookupParameterNames.length &gt; i) {</span>
<span class="fc" id="L336">                                String parameterName = lookupParameterNames[i];</span>
<span class="fc" id="L337">                                field = TypeUtils.getField(clazz, parameterName, declaredFields);</span>
                            }
                        }

<span class="fc" id="L341">                        FieldInfo fieldInfo = new FieldInfo(fieldName, clazz, fieldClass, fieldType, field,</span>
                                ordinal, serialzeFeatures, parserFeatures);
<span class="fc" id="L343">                        add(fieldList, fieldInfo);</span>
                    }
                }

                //return new JavaBeanInfo(clazz, builderClass, null, creatorConstructor, null, null, jsonType, fieldList);
<span class="fc bfc" id="L348" title="All 2 branches covered.">            } else if ((factoryMethod = getFactoryMethod(clazz, methods, jacksonCompatible)) != null) {</span>
<span class="fc" id="L349">                TypeUtils.setAccessible(factoryMethod);</span>

<span class="fc" id="L351">                String[] lookupParameterNames = null;</span>
<span class="fc" id="L352">                Class&lt;?&gt;[] types = factoryMethod.getParameterTypes();</span>
<span class="fc bfc" id="L353" title="All 2 branches covered.">                if (types.length &gt; 0) {</span>
<span class="fc" id="L354">                    Annotation[][] paramAnnotationArrays = factoryMethod.getParameterAnnotations();</span>
<span class="fc bfc" id="L355" title="All 2 branches covered.">                    for (int i = 0; i &lt; types.length; ++i) {</span>
<span class="fc" id="L356">                        Annotation[] paramAnnotations = paramAnnotationArrays[i];</span>
<span class="fc" id="L357">                        JSONField fieldAnnotation = null;</span>
<span class="pc bfc" id="L358" title="All 2 branches covered.">                        for (Annotation paramAnnotation : paramAnnotations) {</span>
<span class="pc bpc" id="L359" title="1 of 2 branches missed.">                            if (paramAnnotation instanceof JSONField) {</span>
<span class="fc" id="L360">                                fieldAnnotation = (JSONField) paramAnnotation;</span>
<span class="fc" id="L361">                                break;</span>
                            }
                        }
<span class="pc bpc" id="L364" title="1 of 6 branches missed.">                        if (fieldAnnotation == null &amp;&amp; !(jacksonCompatible &amp;&amp; TypeUtils.isJacksonCreator(factoryMethod))) {</span>
<span class="fc" id="L365">                            throw new JSONException(&quot;illegal json creator&quot;);</span>
                        }

<span class="fc" id="L368">                        String fieldName = null;</span>
<span class="fc" id="L369">                        int ordinal = 0, serialzeFeatures = 0, parserFeatures = 0;</span>

<span class="fc bfc" id="L371" title="All 2 branches covered.">                        if (fieldAnnotation != null) {</span>
<span class="fc" id="L372">                            fieldName = fieldAnnotation.name();</span>
<span class="fc" id="L373">                            ordinal = fieldAnnotation.ordinal();</span>
<span class="fc" id="L374">                            serialzeFeatures = SerializerFeature.of(fieldAnnotation.serialzeFeatures());</span>
<span class="fc" id="L375">                            parserFeatures = Feature.of(fieldAnnotation.parseFeatures());</span>
                        }

<span class="pc bpc" id="L378" title="1 of 4 branches missed.">                        if (fieldName == null || fieldName.length() == 0) {</span>
<span class="pc bpc" id="L379" title="1 of 2 branches missed.">                            if (lookupParameterNames == null) {</span>
<span class="fc" id="L380">                                lookupParameterNames = ASMUtils.lookupParameterNames(factoryMethod);</span>
                            }
<span class="fc" id="L382">                            fieldName = lookupParameterNames[i];</span>
                        }

<span class="fc" id="L385">                        Class&lt;?&gt; fieldClass = types[i];</span>
<span class="fc" id="L386">                        Type fieldType = factoryMethod.getGenericParameterTypes()[i];</span>

<span class="fc" id="L388">                        Field field = TypeUtils.getField(clazz, fieldName, declaredFields);</span>
<span class="fc" id="L389">                        FieldInfo fieldInfo = new FieldInfo(fieldName, clazz, fieldClass, fieldType, field,</span>
                                ordinal, serialzeFeatures, parserFeatures);
<span class="fc" id="L391">                        add(fieldList, fieldInfo);</span>
                    }

<span class="fc" id="L394">                    return new JavaBeanInfo(clazz, builderClass, null, null, factoryMethod, null, jsonType, fieldList);</span>
                }
<span class="fc bfc" id="L396" title="All 2 branches covered.">            } else if (!isInterfaceOrAbstract) {</span>
<span class="fc" id="L397">                String className = clazz.getName();</span>

<span class="fc" id="L399">                String[] paramNames = null;</span>
<span class="pc bpc" id="L400" title="1 of 4 branches missed.">                if (kotlin &amp;&amp; constructors.length &gt; 0) {</span>
<span class="fc" id="L401">                    paramNames = TypeUtils.getKoltinConstructorParameters(clazz);</span>
<span class="fc" id="L402">                    creatorConstructor = TypeUtils.getKoltinConstructor(constructors, paramNames);</span>
<span class="fc" id="L403">                    TypeUtils.setAccessible(creatorConstructor);</span>
                } else {

<span class="fc bfc" id="L406" title="All 2 branches covered.">                    for (Constructor constructor : constructors) {</span>
<span class="fc" id="L407">                        Class&lt;?&gt;[] parameterTypes = constructor.getParameterTypes();</span>

<span class="fc bfc" id="L409" title="All 2 branches covered.">                        if (className.equals(&quot;org.springframework.security.web.authentication.WebAuthenticationDetails&quot;)) {</span>
<span class="pc bpc" id="L410" title="2 of 6 branches missed.">                            if (parameterTypes.length == 2 &amp;&amp; parameterTypes[0] == String.class &amp;&amp; parameterTypes[1] == String.class) {</span>
<span class="fc" id="L411">                                creatorConstructor = constructor;</span>
<span class="fc" id="L412">                                creatorConstructor.setAccessible(true);</span>
<span class="fc" id="L413">                                paramNames = ASMUtils.lookupParameterNames(constructor);</span>
<span class="fc" id="L414">                                break;</span>
                            }
                        }

<span class="fc bfc" id="L418" title="All 2 branches covered.">                        if (className.equals(&quot;org.springframework.security.web.authentication.preauth.PreAuthenticatedAuthenticationToken&quot;)) {</span>
<span class="pc bpc" id="L419" title="3 of 8 branches missed.">                            if (parameterTypes.length == 3</span>
                                    &amp;&amp; parameterTypes[0] == Object.class
                                    &amp;&amp; parameterTypes[1] == Object.class
                                    &amp;&amp; parameterTypes[2] == Collection.class) {
<span class="fc" id="L423">                                creatorConstructor = constructor;</span>
<span class="fc" id="L424">                                creatorConstructor.setAccessible(true);</span>
<span class="fc" id="L425">                                paramNames = new String[] {&quot;principal&quot;, &quot;credentials&quot;, &quot;authorities&quot;};</span>
<span class="fc" id="L426">                                break;</span>
                            }
                        }

<span class="fc bfc" id="L430" title="All 2 branches covered.">                        if (className.equals(&quot;org.springframework.security.core.authority.SimpleGrantedAuthority&quot;)) {</span>
<span class="pc bpc" id="L431" title="2 of 4 branches missed.">                            if (parameterTypes.length == 1</span>
                                    &amp;&amp; parameterTypes[0] == String.class) {
<span class="fc" id="L433">                                creatorConstructor = constructor;</span>
<span class="fc" id="L434">                                paramNames = new String[] {&quot;authority&quot;};</span>
<span class="fc" id="L435">                                break;</span>
                            }
                        }

                        //


<span class="pc bpc" id="L442" title="1 of 2 branches missed.">                        boolean is_public = (constructor.getModifiers() &amp; Modifier.PUBLIC) != 0;</span>
<span class="pc bpc" id="L443" title="1 of 2 branches missed.">                        if (!is_public) {</span>
<span class="nc" id="L444">                            continue;</span>
                        }
<span class="fc" id="L446">                        String[] lookupParameterNames = ASMUtils.lookupParameterNames(constructor);</span>
<span class="pc bpc" id="L447" title="2 of 4 branches missed.">                        if (lookupParameterNames == null || lookupParameterNames.length == 0) {</span>
<span class="nc" id="L448">                            continue;</span>
                        }

<span class="pc bpc" id="L451" title="1 of 6 branches missed.">                        if (creatorConstructor != null</span>
                                &amp;&amp; paramNames != null &amp;&amp; lookupParameterNames.length &lt;= paramNames.length) {
<span class="fc" id="L453">                            continue;</span>
                        }

<span class="fc" id="L456">                        paramNames = lookupParameterNames;</span>
<span class="fc" id="L457">                        creatorConstructor = constructor;</span>
                    }
                }

<span class="fc" id="L461">                Class&lt;?&gt;[] types = null;</span>
<span class="pc bpc" id="L462" title="1 of 2 branches missed.">                if (paramNames != null) {</span>
<span class="fc" id="L463">                    types = creatorConstructor.getParameterTypes();</span>
                }

<span class="pc bpc" id="L466" title="1 of 4 branches missed.">                if (paramNames != null</span>
                        &amp;&amp; types.length == paramNames.length) {
<span class="fc" id="L468">                    Annotation[][] paramAnnotationArrays = creatorConstructor.getParameterAnnotations();</span>
<span class="fc bfc" id="L469" title="All 2 branches covered.">                    for (int i = 0; i &lt; types.length; ++i) {</span>
<span class="fc" id="L470">                        Annotation[] paramAnnotations = paramAnnotationArrays[i];</span>
<span class="fc" id="L471">                        String paramName = paramNames[i];</span>

<span class="fc" id="L473">                        JSONField fieldAnnotation = null;</span>
<span class="pc bpc" id="L474" title="1 of 2 branches missed.">                        for (Annotation paramAnnotation : paramAnnotations) {</span>
<span class="nc bnc" id="L475" title="All 2 branches missed.">                            if (paramAnnotation instanceof JSONField) {</span>
<span class="nc" id="L476">                                fieldAnnotation = (JSONField) paramAnnotation;</span>
<span class="nc" id="L477">                                break;</span>
                            }
                        }

<span class="fc" id="L481">                        Class&lt;?&gt; fieldClass = types[i];</span>
<span class="fc" id="L482">                        Type fieldType = creatorConstructor.getGenericParameterTypes()[i];</span>
<span class="fc" id="L483">                        Field field = TypeUtils.getField(clazz, paramName, declaredFields);</span>
<span class="fc bfc" id="L484" title="All 2 branches covered.">                        if (field != null) {</span>
<span class="pc bpc" id="L485" title="1 of 2 branches missed.">                            if (fieldAnnotation == null) {</span>
<span class="fc" id="L486">                                fieldAnnotation = field.getAnnotation(JSONField.class);</span>
                            }
                        }
                        final int ordinal, serialzeFeatures, parserFeatures;
<span class="fc bfc" id="L490" title="All 2 branches covered.">                        if (fieldAnnotation == null) {</span>
<span class="fc" id="L491">                            ordinal = 0;</span>
<span class="fc" id="L492">                            serialzeFeatures = 0;</span>

<span class="fc bfc" id="L494" title="All 2 branches covered.">                            if (&quot;org.springframework.security.core.userdetails.User&quot;.equals(className)</span>
<span class="fc bfc" id="L495" title="All 2 branches covered.">                                    &amp;&amp; &quot;password&quot;.equals(paramName)) {</span>
<span class="fc" id="L496">                                parserFeatures = Feature.InitStringFieldAsEmpty.mask;</span>
                            } else {
<span class="fc" id="L498">                                parserFeatures = 0;</span>
                            }
                        } else {
<span class="fc" id="L501">                            String nameAnnotated = fieldAnnotation.name();</span>
<span class="pc bpc" id="L502" title="1 of 2 branches missed.">                            if (nameAnnotated.length() != 0) {</span>
<span class="fc" id="L503">                                paramName = nameAnnotated;</span>
                            }
<span class="fc" id="L505">                            ordinal = fieldAnnotation.ordinal();</span>
<span class="fc" id="L506">                            serialzeFeatures = SerializerFeature.of(fieldAnnotation.serialzeFeatures());</span>
<span class="fc" id="L507">                            parserFeatures = Feature.of(fieldAnnotation.parseFeatures());</span>
                        }
<span class="fc" id="L509">                        FieldInfo fieldInfo = new FieldInfo(paramName, clazz, fieldClass, fieldType, field,</span>
                                ordinal, serialzeFeatures, parserFeatures);
<span class="fc" id="L511">                        add(fieldList, fieldInfo);</span>
                    }

<span class="fc bfc" id="L514" title="All 2 branches covered.">                    if ((!kotlin)</span>
<span class="fc bfc" id="L515" title="All 2 branches covered.">                            &amp;&amp; !clazz.getName().equals(&quot;javax.servlet.http.Cookie&quot;)) {</span>
<span class="fc" id="L516">                        return new JavaBeanInfo(clazz, builderClass, null, creatorConstructor, null, null, jsonType, fieldList);</span>
                    }
<span class="fc" id="L518">                } else {</span>
<span class="fc" id="L519">                    throw new JSONException(&quot;default constructor not found. &quot; + clazz);</span>
                }
            }
        }

<span class="fc bfc" id="L524" title="All 2 branches covered.">        if (defaultConstructor != null) {</span>
<span class="fc" id="L525">            TypeUtils.setAccessible(defaultConstructor);</span>
        }

<span class="fc bfc" id="L528" title="All 2 branches covered.">        if (builderClass != null) {</span>
<span class="fc" id="L529">            String withPrefix = null;</span>

<span class="fc" id="L531">            JSONPOJOBuilder builderAnno = builderClass.getAnnotation(JSONPOJOBuilder.class);</span>
<span class="fc bfc" id="L532" title="All 2 branches covered.">            if (builderAnno != null) {</span>
<span class="fc" id="L533">                withPrefix = builderAnno.withPrefix();</span>
            }

<span class="pc bpc" id="L536" title="1 of 4 branches missed.">            if (withPrefix == null || withPrefix.length() == 0) {</span>
<span class="fc" id="L537">                withPrefix = &quot;with&quot;;</span>
            }

<span class="fc bfc" id="L540" title="All 2 branches covered.">            for (Method method : builderClass.getMethods()) {</span>
<span class="pc bpc" id="L541" title="1 of 2 branches missed.">                if (Modifier.isStatic(method.getModifiers())) {</span>
<span class="nc" id="L542">                    continue;</span>
                }

<span class="fc bfc" id="L545" title="All 2 branches covered.">                if (!(method.getReturnType().equals(builderClass))) {</span>
<span class="fc" id="L546">                    continue;</span>
                }

<span class="fc" id="L549">                int ordinal = 0, serialzeFeatures = 0, parserFeatures = 0;</span>

<span class="fc" id="L551">                JSONField annotation = method.getAnnotation(JSONField.class);</span>

<span class="fc bfc" id="L553" title="All 2 branches covered.">                if (annotation == null) {</span>
<span class="fc" id="L554">                    annotation = TypeUtils.getSuperMethodAnnotation(clazz, method);</span>
                }

<span class="fc bfc" id="L557" title="All 2 branches covered.">                if (annotation != null) {</span>
<span class="pc bpc" id="L558" title="1 of 2 branches missed.">                    if (!annotation.deserialize()) {</span>
<span class="nc" id="L559">                        continue;</span>
                    }

<span class="fc" id="L562">                    ordinal = annotation.ordinal();</span>
<span class="fc" id="L563">                    serialzeFeatures = SerializerFeature.of(annotation.serialzeFeatures());</span>
<span class="fc" id="L564">                    parserFeatures = Feature.of(annotation.parseFeatures());</span>

<span class="pc bpc" id="L566" title="1 of 2 branches missed.">                    if (annotation.name().length() != 0) {</span>
<span class="fc" id="L567">                        String propertyName = annotation.name();</span>
<span class="fc" id="L568">                        add(fieldList, new FieldInfo(propertyName, method, null, clazz, type, ordinal, serialzeFeatures, parserFeatures,</span>
                                annotation, null, null));
<span class="fc" id="L570">                        continue;</span>
                    }
                }

<span class="fc" id="L574">                String methodName = method.getName();</span>
                StringBuilder properNameBuilder;
<span class="pc bpc" id="L576" title="1 of 4 branches missed.">                if (methodName.startsWith(&quot;set&quot;) &amp;&amp; methodName.length() &gt; 3) {</span>
<span class="fc" id="L577">                    properNameBuilder = new StringBuilder(methodName.substring(3));</span>
                } else {
<span class="pc bpc" id="L579" title="1 of 2 branches missed.">                    if (!methodName.startsWith(withPrefix)) {</span>
<span class="nc" id="L580">                        continue;</span>
                    }

<span class="pc bpc" id="L583" title="1 of 2 branches missed.">                    if (methodName.length() &lt;= withPrefix.length()) {</span>
<span class="nc" id="L584">                        continue;</span>
                    }

<span class="fc" id="L587">                    properNameBuilder = new StringBuilder(methodName.substring(withPrefix.length()));</span>
                }

<span class="fc" id="L590">                char c0 = properNameBuilder.charAt(0);</span>
<span class="pc bpc" id="L591" title="1 of 2 branches missed.">                if (!Character.isUpperCase(c0)) {</span>
<span class="nc" id="L592">                    continue;</span>
                }

<span class="fc" id="L595">                properNameBuilder.setCharAt(0, Character.toLowerCase(c0));</span>

<span class="fc" id="L597">                String propertyName = properNameBuilder.toString();</span>

<span class="fc" id="L599">                add(fieldList, new FieldInfo(propertyName, method, null, clazz, type, ordinal, serialzeFeatures, parserFeatures,</span>
                        annotation, null, null));
            }

<span class="pc bpc" id="L603" title="1 of 2 branches missed.">            if (builderClass != null) {</span>
<span class="fc" id="L604">                JSONPOJOBuilder builderAnnotation = builderClass.getAnnotation(JSONPOJOBuilder.class);</span>

<span class="fc" id="L606">                String buildMethodName = null;</span>
<span class="fc bfc" id="L607" title="All 2 branches covered.">                if (builderAnnotation != null) {</span>
<span class="fc" id="L608">                    buildMethodName = builderAnnotation.buildMethod();</span>
                }

<span class="pc bpc" id="L611" title="1 of 4 branches missed.">                if (buildMethodName == null || buildMethodName.length() == 0) {</span>
<span class="fc" id="L612">                    buildMethodName = &quot;build&quot;;</span>
                }

                try {
<span class="fc" id="L616">                    buildMethod = builderClass.getMethod(buildMethodName);</span>
<span class="fc" id="L617">                } catch (NoSuchMethodException e) {</span>
                    // skip
<span class="nc" id="L619">                } catch (SecurityException e) {</span>
                    // skip
<span class="fc" id="L621">                }</span>

<span class="fc bfc" id="L623" title="All 2 branches covered.">                if (buildMethod == null) {</span>
                    try {
<span class="fc" id="L625">                        buildMethod = builderClass.getMethod(&quot;create&quot;);</span>
<span class="nc" id="L626">                    } catch (NoSuchMethodException e) {</span>
                        // skip
<span class="nc" id="L628">                    } catch (SecurityException e) {</span>
                        // skip
<span class="pc" id="L630">                    }</span>
                }

<span class="pc bpc" id="L633" title="1 of 2 branches missed.">                if (buildMethod == null) {</span>
<span class="nc" id="L634">                    throw new JSONException(&quot;buildMethod not found.&quot;);</span>
                }

<span class="fc" id="L637">                TypeUtils.setAccessible(buildMethod);</span>
            }
        }

<span class="fc bfc" id="L641" title="All 2 branches covered.">        for (Method method : methods) { //</span>
<span class="fc" id="L642">            int ordinal = 0, serialzeFeatures = 0, parserFeatures = 0;</span>
<span class="fc" id="L643">            String methodName = method.getName();</span>

<span class="fc bfc" id="L645" title="All 2 branches covered.">            if (Modifier.isStatic(method.getModifiers())) {</span>
<span class="fc" id="L646">                continue;</span>
            }

            // support builder set
<span class="fc" id="L650">            Class&lt;?&gt; returnType = method.getReturnType();</span>
<span class="fc bfc" id="L651" title="All 4 branches covered.">            if (!(returnType.equals(Void.TYPE) || returnType.equals(method.getDeclaringClass()))) {</span>
<span class="fc" id="L652">                continue;</span>
            }

<span class="fc bfc" id="L655" title="All 2 branches covered.">            if (method.getDeclaringClass() == Object.class) {</span>
<span class="fc" id="L656">                continue;</span>
            }

<span class="fc" id="L659">            Class&lt;?&gt;[] types = method.getParameterTypes();</span>

<span class="fc bfc" id="L661" title="All 4 branches covered.">            if (types.length == 0 || types.length &gt; 2) {</span>
<span class="fc" id="L662">                continue;</span>
            }

<span class="fc" id="L665">            JSONField annotation = method.getAnnotation(JSONField.class);</span>
<span class="pc bpc" id="L666" title="2 of 8 branches missed.">            if (annotation != null</span>
                    &amp;&amp; types.length == 2
                    &amp;&amp; types[0] == String.class
                    &amp;&amp; types[1] == Object.class) {
<span class="fc" id="L670">                add(fieldList, new FieldInfo(&quot;&quot;, method, null, clazz, type, ordinal,</span>
                        serialzeFeatures, parserFeatures, annotation, null, null));
<span class="fc" id="L672">                continue;</span>
            }

<span class="fc bfc" id="L675" title="All 2 branches covered.">            if (types.length != 1) {</span>
<span class="fc" id="L676">                continue;</span>
            }

<span class="fc bfc" id="L679" title="All 2 branches covered.">            if (annotation == null) {</span>
<span class="fc" id="L680">                annotation = TypeUtils.getSuperMethodAnnotation(clazz, method);</span>
            }

<span class="fc bfc" id="L683" title="All 4 branches covered.">            if (annotation == null &amp;&amp; methodName.length() &lt; 4) {</span>
<span class="fc" id="L684">                continue;</span>
            }

<span class="fc bfc" id="L687" title="All 2 branches covered.">            if (annotation != null) {</span>
<span class="fc bfc" id="L688" title="All 2 branches covered.">                if (!annotation.deserialize()) {</span>
<span class="fc" id="L689">                    continue;</span>
                }

<span class="fc" id="L692">                ordinal = annotation.ordinal();</span>
<span class="fc" id="L693">                serialzeFeatures = SerializerFeature.of(annotation.serialzeFeatures());</span>
<span class="fc" id="L694">                parserFeatures = Feature.of(annotation.parseFeatures());</span>

<span class="fc bfc" id="L696" title="All 2 branches covered.">                if (annotation.name().length() != 0) {</span>
<span class="fc" id="L697">                    String propertyName = annotation.name();</span>
<span class="fc" id="L698">                    add(fieldList, new FieldInfo(propertyName, method, null, clazz, type, ordinal, serialzeFeatures, parserFeatures,</span>
                            annotation, null, null));
<span class="fc" id="L700">                    continue;</span>
                }
            }

<span class="fc bfc" id="L704" title="All 4 branches covered.">            if (annotation == null &amp;&amp; !methodName.startsWith(&quot;set&quot;)) { // TODO &quot;set&quot;的判断放在 JSONField 注解后面，意思是允许非 setter 方法标记 JSONField 注解？</span>
<span class="fc" id="L705">                continue;</span>
            }

<span class="fc" id="L708">            char c3 = methodName.charAt(3);</span>

            String propertyName;
<span class="fc bfc" id="L711" title="All 4 branches covered.">            if (Character.isUpperCase(c3) //</span>
                    || c3 &gt; 512 // for unicode method name
                    ) {
<span class="fc bfc" id="L714" title="All 2 branches covered.">                if (TypeUtils.compatibleWithJavaBean) {</span>
<span class="fc" id="L715">                    propertyName = TypeUtils.decapitalize(methodName.substring(3));</span>
                } else {
<span class="fc" id="L717">                    propertyName = Character.toLowerCase(methodName.charAt(3)) + methodName.substring(4);</span>
                }
<span class="fc bfc" id="L719" title="All 2 branches covered.">            } else if (c3 == '_') {</span>
<span class="fc" id="L720">                propertyName = methodName.substring(4);</span>
<span class="fc bfc" id="L721" title="All 2 branches covered.">            } else if (c3 == 'f') {</span>
<span class="fc" id="L722">                propertyName = methodName.substring(3);</span>
<span class="pc bpc" id="L723" title="1 of 4 branches missed.">            } else if (methodName.length() &gt;= 5 &amp;&amp; Character.isUpperCase(methodName.charAt(4))) {</span>
<span class="fc" id="L724">                propertyName = TypeUtils.decapitalize(methodName.substring(3));</span>
            } else {
                continue;
            }

<span class="fc" id="L729">            Field field = TypeUtils.getField(clazz, propertyName, declaredFields);</span>
<span class="fc bfc" id="L730" title="All 4 branches covered.">            if (field == null &amp;&amp; types[0] == boolean.class) {</span>
<span class="fc" id="L731">                String isFieldName = &quot;is&quot; + Character.toUpperCase(propertyName.charAt(0)) + propertyName.substring(1);</span>
<span class="fc" id="L732">                field = TypeUtils.getField(clazz, isFieldName, declaredFields);</span>
            }

<span class="fc" id="L735">            JSONField fieldAnnotation = null;</span>
<span class="fc bfc" id="L736" title="All 2 branches covered.">            if (field != null) {</span>
<span class="fc" id="L737">                fieldAnnotation = field.getAnnotation(JSONField.class);</span>

<span class="fc bfc" id="L739" title="All 2 branches covered.">                if (fieldAnnotation != null) {</span>
<span class="fc bfc" id="L740" title="All 2 branches covered.">                    if (!fieldAnnotation.deserialize()) {</span>
<span class="fc" id="L741">                        continue;</span>
                    }

<span class="fc" id="L744">                    ordinal = fieldAnnotation.ordinal();</span>
<span class="fc" id="L745">                    serialzeFeatures = SerializerFeature.of(fieldAnnotation.serialzeFeatures());</span>
<span class="fc" id="L746">                    parserFeatures = Feature.of(fieldAnnotation.parseFeatures());</span>

<span class="fc bfc" id="L748" title="All 2 branches covered.">                    if (fieldAnnotation.name().length() != 0) {</span>
<span class="fc" id="L749">                        propertyName = fieldAnnotation.name();</span>
<span class="fc" id="L750">                        add(fieldList, new FieldInfo(propertyName, method, field, clazz, type, ordinal,</span>
                                serialzeFeatures, parserFeatures, annotation, fieldAnnotation, null));
<span class="fc" id="L752">                        continue;</span>
                    }
                }

            }

<span class="fc bfc" id="L758" title="All 2 branches covered.">            if (propertyNamingStrategy != null) {</span>
<span class="fc" id="L759">                propertyName = propertyNamingStrategy.translate(propertyName);</span>
            }

<span class="fc" id="L762">            add(fieldList, new FieldInfo(propertyName, method, field, clazz, type, ordinal, serialzeFeatures, parserFeatures,</span>
                    annotation, fieldAnnotation, null));
        }

<span class="fc" id="L766">        Field[] fields = clazz.getFields();</span>
<span class="fc" id="L767">        computeFields(clazz, type, propertyNamingStrategy, fieldList, fields);</span>

<span class="fc bfc" id="L769" title="All 2 branches covered.">        for (Method method : clazz.getMethods()) { // getter methods</span>
<span class="fc" id="L770">            String methodName = method.getName();</span>
<span class="fc bfc" id="L771" title="All 2 branches covered.">            if (methodName.length() &lt; 4) {</span>
<span class="fc" id="L772">                continue;</span>
            }

<span class="fc bfc" id="L775" title="All 2 branches covered.">            if (Modifier.isStatic(method.getModifiers())) {</span>
<span class="fc" id="L776">                continue;</span>
            }

<span class="fc bfc" id="L779" title="All 6 branches covered.">            if (builderClass == null &amp;&amp; methodName.startsWith(&quot;get&quot;) &amp;&amp; Character.isUpperCase(methodName.charAt(3))) {</span>
<span class="fc bfc" id="L780" title="All 2 branches covered.">                if (method.getParameterTypes().length != 0) {</span>
<span class="fc" id="L781">                    continue;</span>
                }

<span class="fc bfc" id="L784" title="All 2 branches covered.">                if (Collection.class.isAssignableFrom(method.getReturnType()) //</span>
<span class="fc bfc" id="L785" title="All 2 branches covered.">                        || Map.class.isAssignableFrom(method.getReturnType()) //</span>
<span class="fc bfc" id="L786" title="All 2 branches covered.">                        || AtomicBoolean.class == method.getReturnType() //</span>
<span class="fc bfc" id="L787" title="All 2 branches covered.">                        || AtomicInteger.class == method.getReturnType() //</span>
<span class="fc bfc" id="L788" title="All 2 branches covered.">                        || AtomicLong.class == method.getReturnType() //</span>
                        ) {
                    String propertyName;

<span class="fc" id="L792">                    JSONField annotation = method.getAnnotation(JSONField.class);</span>
<span class="pc bpc" id="L793" title="1 of 4 branches missed.">                    if (annotation != null &amp;&amp; annotation.deserialize()) {</span>
<span class="fc" id="L794">                        continue;</span>
                    }

<span class="pc bpc" id="L797" title="3 of 4 branches missed.">                    if (annotation != null &amp;&amp; annotation.name().length() &gt; 0) {</span>
<span class="nc" id="L798">                        propertyName = annotation.name();</span>
                    } else {
<span class="fc" id="L800">                        propertyName = Character.toLowerCase(methodName.charAt(3)) + methodName.substring(4);</span>

<span class="fc" id="L802">                        Field field = TypeUtils.getField(clazz, propertyName, declaredFields);</span>
<span class="fc bfc" id="L803" title="All 2 branches covered.">                        if (field != null) {</span>
<span class="fc" id="L804">                            JSONField fieldAnnotation = field.getAnnotation(JSONField.class);</span>
<span class="fc bfc" id="L805" title="All 4 branches covered.">                            if (fieldAnnotation != null &amp;&amp; !fieldAnnotation.deserialize()) {</span>
<span class="fc" id="L806">                                continue;</span>
                            }
                        }
                    }

<span class="fc bfc" id="L811" title="All 2 branches covered.">                    if (propertyNamingStrategy != null) {</span>
<span class="fc" id="L812">                        propertyName = propertyNamingStrategy.translate(propertyName);</span>
                    }

<span class="fc" id="L815">                    FieldInfo fieldInfo = getField(fieldList, propertyName);</span>
<span class="fc bfc" id="L816" title="All 2 branches covered.">                    if (fieldInfo != null) {</span>
<span class="fc" id="L817">                        continue;</span>
                    }

<span class="fc" id="L820">                    add(fieldList, new FieldInfo(propertyName, method, null, clazz, type, 0, 0, 0, annotation, null, null));</span>
                }
            }
        }

<span class="fc bfc" id="L825" title="All 2 branches covered.">        if (fieldList.size() == 0) {</span>
<span class="fc" id="L826">            XmlAccessorType accessorType = clazz.getAnnotation(XmlAccessorType.class);</span>
<span class="pc bpc" id="L827" title="1 of 4 branches missed.">            if (accessorType != null &amp;&amp; accessorType.value() == XmlAccessType.FIELD) {</span>
<span class="fc" id="L828">                fieldBased = true;</span>
            }

<span class="fc bfc" id="L831" title="All 2 branches covered.">            if (fieldBased) {</span>
<span class="fc bfc" id="L832" title="All 2 branches covered.">                for (Class&lt;?&gt; currentClass = clazz; currentClass != null; currentClass = currentClass.getSuperclass()) {</span>
<span class="fc" id="L833">                    computeFields(clazz, type, propertyNamingStrategy, fieldList, declaredFields);</span>
                }
            }
        }

<span class="fc" id="L838">        return new JavaBeanInfo(clazz, builderClass, defaultConstructor, creatorConstructor, factoryMethod, buildMethod, jsonType, fieldList);</span>
    }

    private static void computeFields(Class&lt;?&gt; clazz, Type type, PropertyNamingStrategy propertyNamingStrategy, List&lt;FieldInfo&gt; fieldList, Field[] fields) {
<span class="fc bfc" id="L842" title="All 2 branches covered.">        for (Field field : fields) { // public static fields</span>
<span class="fc" id="L843">            int modifiers = field.getModifiers();</span>
<span class="fc bfc" id="L844" title="All 2 branches covered.">            if ((modifiers &amp; Modifier.STATIC) != 0) {</span>
<span class="fc" id="L845">                continue;</span>
            }

<span class="fc bfc" id="L848" title="All 2 branches covered.">            if ((modifiers &amp; Modifier.FINAL) != 0) {</span>
<span class="fc" id="L849">                Class&lt;?&gt; fieldType = field.getType();</span>
<span class="fc bfc" id="L850" title="All 2 branches covered.">                boolean supportReadOnly = Map.class.isAssignableFrom(fieldType)</span>
<span class="fc bfc" id="L851" title="All 2 branches covered.">                        || Collection.class.isAssignableFrom(fieldType)</span>
<span class="fc bfc" id="L852" title="All 2 branches covered.">                        || AtomicLong.class.equals(fieldType) //</span>
<span class="fc bfc" id="L853" title="All 2 branches covered.">                        || AtomicInteger.class.equals(fieldType) //</span>
<span class="fc bfc" id="L854" title="All 2 branches covered.">                        || AtomicBoolean.class.equals(fieldType);</span>
<span class="fc bfc" id="L855" title="All 2 branches covered.">                if (!supportReadOnly) {</span>
<span class="fc" id="L856">                    continue;</span>
                }
            }

<span class="fc" id="L860">            boolean contains = false;</span>
<span class="fc bfc" id="L861" title="All 2 branches covered.">            for (FieldInfo item : fieldList) {</span>
<span class="fc bfc" id="L862" title="All 2 branches covered.">                if (item.name.equals(field.getName())) {</span>
<span class="fc" id="L863">                    contains = true;</span>
<span class="fc" id="L864">                    break; // 已经是 contains = true，无需继续遍历</span>
                }
<span class="fc" id="L866">            }</span>

<span class="fc bfc" id="L868" title="All 2 branches covered.">            if (contains) {</span>
<span class="fc" id="L869">                continue;</span>
            }

<span class="fc" id="L872">            int ordinal = 0, serialzeFeatures = 0, parserFeatures = 0;</span>
<span class="fc" id="L873">            String propertyName = field.getName();</span>

<span class="fc" id="L875">            JSONField fieldAnnotation = field.getAnnotation(JSONField.class);</span>

<span class="fc bfc" id="L877" title="All 2 branches covered.">            if (fieldAnnotation != null) {</span>
<span class="fc bfc" id="L878" title="All 2 branches covered.">                if (!fieldAnnotation.deserialize()) {</span>
<span class="fc" id="L879">                    continue;</span>
                }

<span class="fc" id="L882">                ordinal = fieldAnnotation.ordinal();</span>
<span class="fc" id="L883">                serialzeFeatures = SerializerFeature.of(fieldAnnotation.serialzeFeatures());</span>
<span class="fc" id="L884">                parserFeatures = Feature.of(fieldAnnotation.parseFeatures());</span>

<span class="fc bfc" id="L886" title="All 2 branches covered.">                if (fieldAnnotation.name().length() != 0) {</span>
<span class="fc" id="L887">                    propertyName = fieldAnnotation.name();</span>
                }
            }

<span class="fc bfc" id="L891" title="All 2 branches covered.">            if (propertyNamingStrategy != null) {</span>
<span class="fc" id="L892">                propertyName = propertyNamingStrategy.translate(propertyName);</span>
            }

<span class="fc" id="L895">            add(fieldList, new FieldInfo(propertyName, null, field, clazz, type, ordinal, serialzeFeatures, parserFeatures, null,</span>
                    fieldAnnotation, null));
        }
<span class="fc" id="L898">    }</span>

    static Constructor&lt;?&gt; getDefaultConstructor(Class&lt;?&gt; clazz, final Constructor&lt;?&gt;[] constructors) {
<span class="fc bfc" id="L901" title="All 2 branches covered.">        if (Modifier.isAbstract(clazz.getModifiers())) {</span>
<span class="fc" id="L902">            return null;</span>
        }

<span class="fc" id="L905">        Constructor&lt;?&gt; defaultConstructor = null;</span>

<span class="fc bfc" id="L907" title="All 2 branches covered.">        for (Constructor&lt;?&gt; constructor : constructors) {</span>
<span class="fc bfc" id="L908" title="All 2 branches covered.">            if (constructor.getParameterTypes().length == 0) {</span>
<span class="fc" id="L909">                defaultConstructor = constructor;</span>
<span class="fc" id="L910">                break;</span>
            }
        }

<span class="fc bfc" id="L914" title="All 2 branches covered.">        if (defaultConstructor == null) {</span>
<span class="fc bfc" id="L915" title="All 4 branches covered.">            if (clazz.isMemberClass() &amp;&amp; !Modifier.isStatic(clazz.getModifiers())) {</span>
                Class&lt;?&gt;[] types;
<span class="fc bfc" id="L917" title="All 2 branches covered.">                for (Constructor&lt;?&gt; constructor : constructors) {</span>
<span class="fc bfc" id="L918" title="All 2 branches covered.">                    if ((types = constructor.getParameterTypes()).length == 1</span>
<span class="pc bpc" id="L919" title="1 of 2 branches missed.">                            &amp;&amp; types[0].equals(clazz.getDeclaringClass())) {</span>
<span class="fc" id="L920">                        defaultConstructor = constructor;</span>
<span class="fc" id="L921">                        break;</span>
                    }
                }
            }
        }

<span class="fc" id="L927">        return defaultConstructor;</span>
    }

    public static Constructor&lt;?&gt; getCreatorConstructor(Constructor[] constructors) {
<span class="fc" id="L931">        Constructor&lt;?&gt; creatorConstructor = null;</span>

<span class="fc bfc" id="L933" title="All 2 branches covered.">        for (Constructor&lt;?&gt; constructor : constructors) {</span>
<span class="fc" id="L934">            JSONCreator annotation = constructor.getAnnotation(JSONCreator.class);</span>
<span class="fc bfc" id="L935" title="All 2 branches covered.">            if (annotation != null) {</span>
<span class="pc bpc" id="L936" title="1 of 2 branches missed.">                if (creatorConstructor != null) {</span>
<span class="nc" id="L937">                    throw new JSONException(&quot;multi-JSONCreator&quot;);</span>
                }

<span class="fc" id="L940">                creatorConstructor = constructor;</span>
                // 不应该break，否则多个构造方法上存在 JSONCreator 注解时，并不会触发上述异常抛出
            }
        }
<span class="fc bfc" id="L944" title="All 2 branches covered.">        if (creatorConstructor != null) {</span>
<span class="fc" id="L945">            return creatorConstructor;</span>
        }

<span class="fc bfc" id="L948" title="All 2 branches covered.">        for (Constructor constructor : constructors) {</span>
<span class="fc" id="L949">            Annotation[][] paramAnnotationArrays = constructor.getParameterAnnotations();</span>
<span class="fc bfc" id="L950" title="All 2 branches covered.">            if (paramAnnotationArrays.length == 0) {</span>
<span class="fc" id="L951">                continue;</span>
            }
<span class="fc" id="L953">            boolean match = true;</span>
<span class="fc bfc" id="L954" title="All 2 branches covered.">            for (Annotation[] paramAnnotationArray : paramAnnotationArrays) {</span>
<span class="fc" id="L955">                boolean paramMatch = false;</span>
<span class="pc bfc" id="L956" title="All 2 branches covered.">                for (Annotation paramAnnotation : paramAnnotationArray) {</span>
<span class="pc bpc" id="L957" title="1 of 2 branches missed.">                    if (paramAnnotation instanceof JSONField) {</span>
<span class="fc" id="L958">                        paramMatch = true;</span>
<span class="fc" id="L959">                        break;</span>
                    }
                }
<span class="fc bfc" id="L962" title="All 2 branches covered.">                if (!paramMatch) {</span>
<span class="fc" id="L963">                    match = false;</span>
<span class="fc" id="L964">                    break;</span>
                }
            }

<span class="fc bfc" id="L968" title="All 2 branches covered.">            if (match) {</span>
<span class="pc bpc" id="L969" title="1 of 2 branches missed.">                if (creatorConstructor != null) {</span>
<span class="nc" id="L970">                    throw new JSONException(&quot;multi-JSONCreator&quot;);</span>
                }

<span class="fc" id="L973">                creatorConstructor = constructor;</span>
            }
        }

<span class="fc bfc" id="L977" title="All 2 branches covered.">        if (creatorConstructor != null) {</span>
<span class="fc" id="L978">            return creatorConstructor;</span>
        }

<span class="fc" id="L981">        return creatorConstructor;</span>
    }

    private static Method getFactoryMethod(Class&lt;?&gt; clazz, Method[] methods, boolean jacksonCompatible) {
<span class="fc" id="L985">        Method factoryMethod = null;</span>

<span class="fc bfc" id="L987" title="All 2 branches covered.">        for (Method method : methods) {</span>
<span class="fc bfc" id="L988" title="All 2 branches covered.">            if (!Modifier.isStatic(method.getModifiers())) {</span>
<span class="fc" id="L989">                continue;</span>
            }

<span class="fc bfc" id="L992" title="All 2 branches covered.">            if (!clazz.isAssignableFrom(method.getReturnType())) {</span>
<span class="fc" id="L993">                continue;</span>
            }

<span class="fc" id="L996">            JSONCreator annotation = method.getAnnotation(JSONCreator.class);</span>
<span class="fc bfc" id="L997" title="All 2 branches covered.">            if (annotation != null) {</span>
<span class="fc bfc" id="L998" title="All 2 branches covered.">                if (factoryMethod != null) {</span>
<span class="fc" id="L999">                    throw new JSONException(&quot;multi-JSONCreator&quot;);</span>
                }

<span class="fc" id="L1002">                factoryMethod = method;</span>
                // 不应该break，否则多个静态工厂方法上存在 JSONCreator 注解时，并不会触发上述异常抛出
            }
        }

<span class="fc bfc" id="L1007" title="All 4 branches covered.">        if (factoryMethod == null &amp;&amp; jacksonCompatible) {</span>
<span class="pc bpc" id="L1008" title="1 of 2 branches missed.">            for (Method method : methods) {</span>
<span class="fc bfc" id="L1009" title="All 2 branches covered.">                if (TypeUtils.isJacksonCreator(method)) {</span>
<span class="fc" id="L1010">                    factoryMethod = method;</span>
<span class="fc" id="L1011">                    break;</span>
                }
            }
        }
<span class="fc" id="L1015">        return factoryMethod;</span>
    }

    /**
     * @deprecated
     */
    public static Class&lt;?&gt; getBuilderClass(JSONType type) {
<span class="fc" id="L1022">        return getBuilderClass(null, type);</span>
    }

    public static Class&lt;?&gt; getBuilderClass(Class&lt;?&gt; clazz, JSONType type) {
<span class="fc bfc" id="L1026" title="All 4 branches covered.">        if (clazz != null &amp;&amp; clazz.getName().equals(&quot;org.springframework.security.web.savedrequest.DefaultSavedRequest&quot;)) {</span>
<span class="fc" id="L1027">            return TypeUtils.loadClass(&quot;org.springframework.security.web.savedrequest.DefaultSavedRequest$Builder&quot;);</span>
        }

<span class="fc bfc" id="L1030" title="All 2 branches covered.">        if (type == null) {</span>
<span class="fc" id="L1031">            return null;</span>
        }

<span class="fc" id="L1034">        Class&lt;?&gt; builderClass = type.builder();</span>

<span class="fc bfc" id="L1036" title="All 2 branches covered.">        if (builderClass == Void.class) {</span>
<span class="fc" id="L1037">            return null;</span>
        }

<span class="fc" id="L1040">        return builderClass;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.5.201910111838</span></div></body></html>