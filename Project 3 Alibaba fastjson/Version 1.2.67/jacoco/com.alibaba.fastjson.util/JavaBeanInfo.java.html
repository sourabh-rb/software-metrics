<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>JavaBeanInfo.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">fastjson</a> &gt; <a href="index.source.html" class="el_package">com.alibaba.fastjson.util</a> &gt; <span class="el_source">JavaBeanInfo.java</span></div><h1>JavaBeanInfo.java</h1><pre class="source lang-java linenums">package com.alibaba.fastjson.util;

import java.lang.annotation.Annotation;
import java.lang.reflect.*;
import java.util.*;
import java.util.concurrent.atomic.AtomicBoolean;
import java.util.concurrent.atomic.AtomicInteger;
import java.util.concurrent.atomic.AtomicLong;

import com.alibaba.fastjson.JSONException;
import com.alibaba.fastjson.PropertyNamingStrategy;
import com.alibaba.fastjson.annotation.JSONCreator;
import com.alibaba.fastjson.annotation.JSONField;
import com.alibaba.fastjson.annotation.JSONPOJOBuilder;
import com.alibaba.fastjson.annotation.JSONType;
import com.alibaba.fastjson.parser.Feature;
import com.alibaba.fastjson.serializer.SerializerFeature;

public class JavaBeanInfo {

    public final Class&lt;?&gt; clazz;
    public final Class&lt;?&gt; builderClass;
    public final Constructor&lt;?&gt; defaultConstructor;
    public final Constructor&lt;?&gt; creatorConstructor;
    public final Method factoryMethod;
    public final Method buildMethod;

    public final int defaultConstructorParameterSize;

    public final FieldInfo[] fields;
    public final FieldInfo[] sortedFields;

    public final int parserFeatures;

    public final JSONType jsonType;

    public final String typeName;
    public final String typeKey;

    public String[] orders;

    public Type[] creatorConstructorParameterTypes;
    public String[] creatorConstructorParameters;

    public boolean kotlin;
    public Constructor&lt;?&gt; kotlinDefaultConstructor;

<span class="fc" id="L48">    public JavaBeanInfo(Class&lt;?&gt; clazz, //</span>
                        Class&lt;?&gt; builderClass, //
                        Constructor&lt;?&gt; defaultConstructor, //
                        Constructor&lt;?&gt; creatorConstructor, //
                        Method factoryMethod, //
                        Method buildMethod, //
                        JSONType jsonType, //
                        List&lt;FieldInfo&gt; fieldList) {
<span class="fc" id="L56">        this.clazz = clazz;</span>
<span class="fc" id="L57">        this.builderClass = builderClass;</span>
<span class="fc" id="L58">        this.defaultConstructor = defaultConstructor;</span>
<span class="fc" id="L59">        this.creatorConstructor = creatorConstructor;</span>
<span class="fc" id="L60">        this.factoryMethod = factoryMethod;</span>
<span class="fc" id="L61">        this.parserFeatures = TypeUtils.getParserFeatures(clazz);</span>
<span class="fc" id="L62">        this.buildMethod = buildMethod;</span>

<span class="fc" id="L64">        this.jsonType = jsonType;</span>
<span class="fc bfc" id="L65" title="All 2 branches covered.">        if (jsonType != null) {</span>
<span class="fc" id="L66">            String typeName = jsonType.typeName();</span>
<span class="fc" id="L67">            String typeKey = jsonType.typeKey();</span>
<span class="fc bfc" id="L68" title="All 2 branches covered.">            this.typeKey = typeKey.length() &gt; 0 ? typeKey : null;</span>

<span class="fc bfc" id="L70" title="All 2 branches covered.">            if (typeName.length() != 0) {</span>
<span class="fc" id="L71">                this.typeName = typeName;</span>
<span class="fc" id="L72">            } else {</span>
<span class="fc" id="L73">                this.typeName = clazz.getName();</span>
            }
<span class="fc" id="L75">            String[] orders = jsonType.orders();</span>
<span class="fc bfc" id="L76" title="All 2 branches covered.">            this.orders = orders.length == 0 ? null : orders;</span>
<span class="fc" id="L77">        } else {</span>
<span class="fc" id="L78">            this.typeName = clazz.getName();</span>
<span class="fc" id="L79">            this.typeKey = null;</span>
<span class="fc" id="L80">            this.orders = null;</span>
        }

<span class="fc" id="L83">        fields = new FieldInfo[fieldList.size()];</span>
<span class="fc" id="L84">        fieldList.toArray(fields);</span>

<span class="fc" id="L86">        FieldInfo[] sortedFields = new FieldInfo[fields.length];</span>
<span class="fc bfc" id="L87" title="All 2 branches covered.">        if (orders != null) {</span>
<span class="fc" id="L88">            LinkedHashMap&lt;String, FieldInfo&gt; map = new LinkedHashMap&lt;String, FieldInfo&gt;(fieldList.size());</span>
<span class="fc bfc" id="L89" title="All 2 branches covered.">            for (FieldInfo field : fields) {</span>
<span class="fc" id="L90">                map.put(field.name, field);</span>
            }
<span class="fc" id="L92">            int i = 0;</span>
<span class="fc bfc" id="L93" title="All 2 branches covered.">            for (String item : orders) {</span>
<span class="fc" id="L94">                FieldInfo field = map.get(item);</span>
<span class="fc bfc" id="L95" title="All 2 branches covered.">                if (field != null) {</span>
<span class="fc" id="L96">                    sortedFields[i++] = field;</span>
<span class="fc" id="L97">                    map.remove(item);</span>
                }
            }
<span class="fc bfc" id="L100" title="All 2 branches covered.">            for (FieldInfo field : map.values()) {</span>
<span class="fc" id="L101">                sortedFields[i++] = field;</span>
            }
<span class="fc" id="L103">        } else {</span>
<span class="fc" id="L104">            System.arraycopy(fields, 0, sortedFields, 0, fields.length);</span>
<span class="fc" id="L105">            Arrays.sort(sortedFields);</span>
        }

<span class="fc bfc" id="L108" title="All 2 branches covered.">        if (Arrays.equals(fields, sortedFields)) {</span>
<span class="fc" id="L109">            sortedFields = fields;</span>
        }
<span class="fc" id="L111">        this.sortedFields = sortedFields;</span>

<span class="fc bfc" id="L113" title="All 2 branches covered.">        if (defaultConstructor != null) {</span>
<span class="fc" id="L114">            defaultConstructorParameterSize = defaultConstructor.getParameterTypes().length;</span>
<span class="fc bfc" id="L115" title="All 2 branches covered.">        } else if (factoryMethod != null) {</span>
<span class="fc" id="L116">            defaultConstructorParameterSize = factoryMethod.getParameterTypes().length;</span>
<span class="fc" id="L117">        } else {</span>
<span class="fc" id="L118">            defaultConstructorParameterSize = 0;</span>
        }

<span class="fc bfc" id="L121" title="All 2 branches covered.">        if (creatorConstructor != null) {</span>
<span class="fc" id="L122">            this.creatorConstructorParameterTypes = creatorConstructor.getParameterTypes();</span>


<span class="fc" id="L125">            kotlin = TypeUtils.isKotlin(clazz);</span>
<span class="fc bfc" id="L126" title="All 2 branches covered.">            if (kotlin) {</span>
<span class="fc" id="L127">                this.creatorConstructorParameters = TypeUtils.getKoltinConstructorParameters(clazz);</span>
                try {
<span class="fc" id="L129">                    this.kotlinDefaultConstructor = clazz.getConstructor();</span>
<span class="fc" id="L130">                } catch (Throwable ex) {</span>
                    // skip
                }

<span class="fc" id="L134">                Annotation[][] paramAnnotationArrays = TypeUtils.getParameterAnnotations(creatorConstructor);</span>
<span class="pc bpc" id="L135" title="1 of 4 branches missed.">                for (int i = 0; i &lt; creatorConstructorParameters.length &amp;&amp; i &lt; paramAnnotationArrays.length; ++i) {</span>
<span class="fc" id="L136">                    Annotation[] paramAnnotations = paramAnnotationArrays[i];</span>
<span class="fc" id="L137">                    JSONField fieldAnnotation = null;</span>
<span class="pc bfc" id="L138" title="All 2 branches covered.">                    for (Annotation paramAnnotation : paramAnnotations) {</span>
<span class="pc bpc" id="L139" title="1 of 2 branches missed.">                        if (paramAnnotation instanceof JSONField) {</span>
<span class="fc" id="L140">                            fieldAnnotation = (JSONField) paramAnnotation;</span>
<span class="fc" id="L141">                            break;</span>
                        }
                    }
<span class="fc bfc" id="L144" title="All 2 branches covered.">                    if (fieldAnnotation != null) {</span>
<span class="fc" id="L145">                        String fieldAnnotationName = fieldAnnotation.name();</span>
<span class="pc bpc" id="L146" title="1 of 2 branches missed.">                        if (fieldAnnotationName.length() &gt; 0) {</span>
<span class="fc" id="L147">                            creatorConstructorParameters[i] = fieldAnnotationName;</span>
                        }
                    }
                }
<span class="nc" id="L151">            } else {</span>
                boolean match;
<span class="fc bfc" id="L153" title="All 2 branches covered.">                if (creatorConstructorParameterTypes.length != fields.length) {</span>
<span class="fc" id="L154">                    match = false;</span>
<span class="fc" id="L155">                } else {</span>
<span class="fc" id="L156">                    match = true;</span>
<span class="fc bfc" id="L157" title="All 2 branches covered.">                    for (int i = 0; i &lt; creatorConstructorParameterTypes.length; i++) {</span>
<span class="fc bfc" id="L158" title="All 2 branches covered.">                        if (creatorConstructorParameterTypes[i] != fields[i].fieldClass) {</span>
<span class="fc" id="L159">                            match = false;</span>
<span class="fc" id="L160">                            break;</span>
                        }
                    }
                }

<span class="fc bfc" id="L165" title="All 2 branches covered.">                if (!match) {</span>
<span class="fc" id="L166">                    this.creatorConstructorParameters = ASMUtils.lookupParameterNames(creatorConstructor);</span>
                }
            }
        }
<span class="fc" id="L170">    }</span>

    private static FieldInfo getField(List&lt;FieldInfo&gt; fieldList, String propertyName) {
<span class="fc bfc" id="L173" title="All 2 branches covered.">        for (FieldInfo item : fieldList) {</span>
<span class="fc bfc" id="L174" title="All 2 branches covered.">            if (item.name.equals(propertyName)) {</span>
<span class="fc" id="L175">                return item;</span>
            }

<span class="fc" id="L178">            Field field = item.field;</span>
<span class="fc bfc" id="L179" title="All 6 branches covered.">            if (field != null &amp;&amp; item.getAnnotation() != null &amp;&amp; field.getName().equals(propertyName)) {</span>
<span class="fc" id="L180">                return item;</span>
            }
        }
<span class="fc" id="L183">        return null;</span>
    }


    static boolean add(List&lt;FieldInfo&gt; fieldList, FieldInfo field) {
<span class="fc bfc" id="L188" title="All 2 branches covered.">        for (int i = fieldList.size() - 1; i &gt;= 0; --i) {</span>
<span class="fc" id="L189">            FieldInfo item = fieldList.get(i);</span>

<span class="fc bfc" id="L191" title="All 2 branches covered.">            if (item.name.equals(field.name)) {</span>
<span class="pc bpc" id="L192" title="3 of 4 branches missed.">                if (item.getOnly &amp;&amp; !field.getOnly) {</span>
<span class="nc" id="L193">                    continue;</span>
                }

<span class="fc bfc" id="L196" title="All 2 branches covered.">                if (item.fieldClass.isAssignableFrom(field.fieldClass)) {</span>
<span class="fc" id="L197">                    fieldList.set(i, field);</span>
<span class="fc" id="L198">                    return true;</span>
                }

<span class="fc" id="L201">                int result = item.compareTo(field);</span>

<span class="fc bfc" id="L203" title="All 2 branches covered.">                if (result &lt; 0) {</span>
<span class="fc" id="L204">                    fieldList.set(i, field);</span>
<span class="fc" id="L205">                    return true;</span>
                } else {
<span class="fc" id="L207">                    return false;</span>
                }
            }
        }
<span class="fc" id="L211">        fieldList.add(field);</span>

<span class="fc" id="L213">        return true;</span>
    }

    public static JavaBeanInfo build(Class&lt;?&gt; clazz, Type type, PropertyNamingStrategy propertyNamingStrategy) {
<span class="fc" id="L217">        return build(clazz, type, propertyNamingStrategy, false, TypeUtils.compatibleWithJavaBean, false);</span>
    }

    private static Map&lt;TypeVariable, Type&gt; buildGenericInfo(Class&lt;?&gt; clazz) {
<span class="fc" id="L221">        Class&lt;?&gt; childClass = clazz;</span>
<span class="fc" id="L222">        Class&lt;?&gt; currentClass = clazz.getSuperclass();</span>
<span class="fc bfc" id="L223" title="All 2 branches covered.">        if (currentClass == null) {</span>
<span class="fc" id="L224">            return null;</span>
        }

<span class="fc" id="L227">        Map&lt;TypeVariable, Type&gt; typeVarMap = null;</span>

        //analyse the whole generic info from the class inheritance
<span class="pc bpc" id="L230" title="1 of 4 branches missed.">        for (; currentClass != null &amp;&amp; currentClass != Object.class; childClass = currentClass, currentClass = currentClass.getSuperclass()) {</span>
<span class="fc bfc" id="L231" title="All 2 branches covered.">            if (childClass.getGenericSuperclass() instanceof ParameterizedType) {</span>
<span class="fc" id="L232">                Type[] childGenericParentActualTypeArgs = ((ParameterizedType) childClass.getGenericSuperclass()).getActualTypeArguments();</span>
<span class="fc" id="L233">                TypeVariable[] currentTypeParameters = currentClass.getTypeParameters();</span>
<span class="fc bfc" id="L234" title="All 2 branches covered.">                for (int i = 0; i &lt; childGenericParentActualTypeArgs.length; i++) {</span>
                    //if the child class's generic super class actual args is defined in the child class type parameters
<span class="fc bfc" id="L236" title="All 2 branches covered.">                    if (typeVarMap == null) {</span>
<span class="fc" id="L237">                        typeVarMap = new HashMap&lt;TypeVariable, Type&gt;();</span>
                    }

<span class="fc bfc" id="L240" title="All 2 branches covered.">                    if (typeVarMap.containsKey(childGenericParentActualTypeArgs[i])) {</span>
<span class="fc" id="L241">                        Type actualArg = typeVarMap.get(childGenericParentActualTypeArgs[i]);</span>
<span class="fc" id="L242">                        typeVarMap.put(currentTypeParameters[i], actualArg);</span>
<span class="fc" id="L243">                    } else {</span>
<span class="fc" id="L244">                        typeVarMap.put(currentTypeParameters[i], childGenericParentActualTypeArgs[i]);</span>
                    }
                }
            }
        }

<span class="fc" id="L250">        return typeVarMap;</span>
    }


    public static JavaBeanInfo build(Class&lt;?&gt; clazz //
            , Type type //
            , PropertyNamingStrategy propertyNamingStrategy //
            , boolean fieldBased //
            , boolean compatibleWithJavaBean
    ) {
<span class="nc" id="L260">        return build(clazz, type, propertyNamingStrategy, fieldBased, compatibleWithJavaBean, false);</span>
    }

    public static JavaBeanInfo build(Class&lt;?&gt; clazz //
            , Type type //
            , PropertyNamingStrategy propertyNamingStrategy //
            , boolean fieldBased //
            , boolean compatibleWithJavaBean
            , boolean jacksonCompatible
    ) {
<span class="fc" id="L270">        JSONType jsonType = TypeUtils.getAnnotation(clazz,JSONType.class);</span>
<span class="fc bfc" id="L271" title="All 2 branches covered.">        if (jsonType != null) {</span>
<span class="fc" id="L272">            PropertyNamingStrategy jsonTypeNaming = jsonType.naming();</span>
<span class="pc bpc" id="L273" title="1 of 4 branches missed.">            if (jsonTypeNaming != null &amp;&amp; jsonTypeNaming != PropertyNamingStrategy.CamelCase) {</span>
<span class="fc" id="L274">                propertyNamingStrategy = jsonTypeNaming;</span>
            }
        }

<span class="fc" id="L278">        Class&lt;?&gt; builderClass = getBuilderClass(clazz, jsonType);</span>

<span class="fc" id="L280">        Field[] declaredFields = clazz.getDeclaredFields();</span>
<span class="fc" id="L281">        Method[] methods = clazz.getMethods();</span>
<span class="fc" id="L282">        Map&lt;TypeVariable, Type&gt; genericInfo = buildGenericInfo(clazz);</span>

<span class="fc" id="L284">        boolean kotlin = TypeUtils.isKotlin(clazz);</span>
<span class="fc" id="L285">        Constructor[] constructors = clazz.getDeclaredConstructors();</span>

<span class="fc" id="L287">        Constructor&lt;?&gt; defaultConstructor = null;</span>
<span class="fc bfc" id="L288" title="All 4 branches covered.">        if ((!kotlin) || constructors.length == 1) {</span>
<span class="fc bfc" id="L289" title="All 2 branches covered.">            if (builderClass == null) {</span>
<span class="fc" id="L290">                defaultConstructor = getDefaultConstructor(clazz, constructors);</span>
<span class="fc" id="L291">            } else {</span>
<span class="fc" id="L292">                defaultConstructor = getDefaultConstructor(builderClass, builderClass.getDeclaredConstructors());</span>
            }
        }

<span class="fc" id="L296">        Constructor&lt;?&gt; creatorConstructor = null;</span>
<span class="fc" id="L297">        Method buildMethod = null;</span>
<span class="fc" id="L298">        Method factoryMethod = null;</span>

<span class="fc" id="L300">        List&lt;FieldInfo&gt; fieldList = new ArrayList&lt;FieldInfo&gt;();</span>

<span class="fc bfc" id="L302" title="All 2 branches covered.">        if (fieldBased) {</span>
<span class="fc bfc" id="L303" title="All 2 branches covered.">            for (Class&lt;?&gt; currentClass = clazz; currentClass != null; currentClass = currentClass.getSuperclass()) {</span>
<span class="fc" id="L304">                Field[] fields = currentClass.getDeclaredFields();</span>

<span class="fc" id="L306">                computeFields(clazz, type, propertyNamingStrategy, fieldList, fields);</span>
            }

<span class="pc bpc" id="L309" title="1 of 2 branches missed.">            if (defaultConstructor != null) {</span>
<span class="fc" id="L310">                TypeUtils.setAccessible(defaultConstructor);</span>
            }

<span class="fc" id="L313">            return new JavaBeanInfo(clazz, builderClass, defaultConstructor, null, factoryMethod, buildMethod, jsonType, fieldList);</span>
        }

<span class="fc bfc" id="L316" title="All 4 branches covered.">        boolean isInterfaceOrAbstract = clazz.isInterface() || Modifier.isAbstract(clazz.getModifiers());</span>
<span class="pc bpc" id="L317" title="2 of 6 branches missed.">        if ((defaultConstructor == null &amp;&amp; builderClass == null) || isInterfaceOrAbstract) {</span>
<span class="fc" id="L318">            creatorConstructor = getCreatorConstructor(constructors);</span>

<span class="pc bpc" id="L320" title="1 of 4 branches missed.">            if (creatorConstructor != null &amp;&amp; !isInterfaceOrAbstract) { // 基于标记 JSONCreator 注解的构造方法</span>
<span class="fc" id="L321">                TypeUtils.setAccessible(creatorConstructor);</span>

<span class="fc" id="L323">                Class&lt;?&gt;[] types = creatorConstructor.getParameterTypes();</span>

<span class="fc" id="L325">                String[] lookupParameterNames = null;</span>
<span class="pc bpc" id="L326" title="1 of 2 branches missed.">                if (types.length &gt; 0) {</span>
<span class="fc" id="L327">                    Annotation[][] paramAnnotationArrays = TypeUtils.getParameterAnnotations(creatorConstructor);</span>
<span class="pc bpc" id="L328" title="1 of 4 branches missed.">                    for (int i = 0; i &lt; types.length &amp;&amp; i &lt; paramAnnotationArrays.length; ++i) {</span>
<span class="fc" id="L329">                        Annotation[] paramAnnotations = paramAnnotationArrays[i];</span>
<span class="fc" id="L330">                        JSONField fieldAnnotation = null;</span>
<span class="pc bfc" id="L331" title="All 2 branches covered.">                        for (Annotation paramAnnotation : paramAnnotations) {</span>
<span class="pc bpc" id="L332" title="1 of 2 branches missed.">                            if (paramAnnotation instanceof JSONField) {</span>
<span class="fc" id="L333">                                fieldAnnotation = (JSONField) paramAnnotation;</span>
<span class="fc" id="L334">                                break;</span>
                            }
                        }

<span class="fc" id="L338">                        Class&lt;?&gt; fieldClass = types[i];</span>
<span class="fc" id="L339">                        Type fieldType = creatorConstructor.getGenericParameterTypes()[i];</span>

<span class="fc" id="L341">                        String fieldName = null;</span>
<span class="fc" id="L342">                        Field field = null;</span>
<span class="fc" id="L343">                        int ordinal = 0, serialzeFeatures = 0, parserFeatures = 0;</span>
<span class="fc bfc" id="L344" title="All 2 branches covered.">                        if (fieldAnnotation != null) {</span>
<span class="fc" id="L345">                            field = TypeUtils.getField(clazz, fieldAnnotation.name(), declaredFields);</span>
<span class="fc" id="L346">                            ordinal = fieldAnnotation.ordinal();</span>
<span class="fc" id="L347">                            serialzeFeatures = SerializerFeature.of(fieldAnnotation.serialzeFeatures());</span>
<span class="fc" id="L348">                            parserFeatures = Feature.of(fieldAnnotation.parseFeatures());</span>
<span class="fc" id="L349">                            fieldName = fieldAnnotation.name();</span>
                        }

<span class="fc bfc" id="L352" title="All 4 branches covered.">                        if (fieldName == null || fieldName.length() == 0) {</span>
<span class="pc bpc" id="L353" title="1 of 2 branches missed.">                            if (lookupParameterNames == null) {</span>
<span class="fc" id="L354">                                lookupParameterNames = ASMUtils.lookupParameterNames(creatorConstructor);</span>
                            }
<span class="fc" id="L356">                            fieldName = lookupParameterNames[i];</span>
                        }

<span class="fc bfc" id="L359" title="All 2 branches covered.">                        if (field == null) {</span>
<span class="fc bfc" id="L360" title="All 2 branches covered.">                            if (lookupParameterNames == null) {</span>
<span class="fc bfc" id="L361" title="All 2 branches covered.">                                if (kotlin) {</span>
<span class="fc" id="L362">                                    lookupParameterNames = TypeUtils.getKoltinConstructorParameters(clazz);</span>
<span class="fc" id="L363">                                } else {</span>
<span class="fc" id="L364">                                    lookupParameterNames = ASMUtils.lookupParameterNames(creatorConstructor);</span>
                                }
                            }

<span class="pc bpc" id="L368" title="1 of 2 branches missed.">                            if (lookupParameterNames.length &gt; i) {</span>
<span class="fc" id="L369">                                String parameterName = lookupParameterNames[i];</span>
<span class="fc" id="L370">                                field = TypeUtils.getField(clazz, parameterName, declaredFields);</span>
                            }
                        }

<span class="fc" id="L374">                        FieldInfo fieldInfo = new FieldInfo(fieldName, clazz, fieldClass, fieldType, field,</span>
<span class="fc" id="L375">                                ordinal, serialzeFeatures, parserFeatures);</span>
<span class="fc" id="L376">                        add(fieldList, fieldInfo);</span>
                    }
                }

                //return new JavaBeanInfo(clazz, builderClass, null, creatorConstructor, null, null, jsonType, fieldList);
<span class="pc bfc" id="L381" title="All 2 branches covered.">            } else if ((factoryMethod = getFactoryMethod(clazz, methods, jacksonCompatible)) != null) {</span>
<span class="fc" id="L382">                TypeUtils.setAccessible(factoryMethod);</span>

<span class="fc" id="L384">                String[] lookupParameterNames = null;</span>
<span class="fc" id="L385">                Class&lt;?&gt;[] types = factoryMethod.getParameterTypes();</span>
<span class="fc bfc" id="L386" title="All 2 branches covered.">                if (types.length &gt; 0) {</span>
<span class="fc" id="L387">                    Annotation[][] paramAnnotationArrays = TypeUtils.getParameterAnnotations(factoryMethod);</span>
<span class="fc bfc" id="L388" title="All 2 branches covered.">                    for (int i = 0; i &lt; types.length; ++i) {</span>
<span class="fc" id="L389">                        Annotation[] paramAnnotations = paramAnnotationArrays[i];</span>
<span class="fc" id="L390">                        JSONField fieldAnnotation = null;</span>
<span class="pc bfc" id="L391" title="All 2 branches covered.">                        for (Annotation paramAnnotation : paramAnnotations) {</span>
<span class="pc bpc" id="L392" title="1 of 2 branches missed.">                            if (paramAnnotation instanceof JSONField) {</span>
<span class="fc" id="L393">                                fieldAnnotation = (JSONField) paramAnnotation;</span>
<span class="fc" id="L394">                                break;</span>
                            }
                        }
<span class="pc bpc" id="L397" title="1 of 6 branches missed.">                        if (fieldAnnotation == null &amp;&amp; !(jacksonCompatible &amp;&amp; TypeUtils.isJacksonCreator(factoryMethod))) {</span>
<span class="fc" id="L398">                            throw new JSONException(&quot;illegal json creator&quot;);</span>
                        }

<span class="fc" id="L401">                        String fieldName = null;</span>
<span class="fc" id="L402">                        int ordinal = 0, serialzeFeatures = 0, parserFeatures = 0;</span>

<span class="fc bfc" id="L404" title="All 2 branches covered.">                        if (fieldAnnotation != null) {</span>
<span class="fc" id="L405">                            fieldName = fieldAnnotation.name();</span>
<span class="fc" id="L406">                            ordinal = fieldAnnotation.ordinal();</span>
<span class="fc" id="L407">                            serialzeFeatures = SerializerFeature.of(fieldAnnotation.serialzeFeatures());</span>
<span class="fc" id="L408">                            parserFeatures = Feature.of(fieldAnnotation.parseFeatures());</span>
                        }

<span class="pc bpc" id="L411" title="1 of 4 branches missed.">                        if (fieldName == null || fieldName.length() == 0) {</span>
<span class="pc bpc" id="L412" title="1 of 2 branches missed.">                            if (lookupParameterNames == null) {</span>
<span class="fc" id="L413">                                lookupParameterNames = ASMUtils.lookupParameterNames(factoryMethod);</span>
                            }
<span class="fc" id="L415">                            fieldName = lookupParameterNames[i];</span>
                        }

<span class="fc" id="L418">                        Class&lt;?&gt; fieldClass = types[i];</span>
<span class="fc" id="L419">                        Type fieldType = factoryMethod.getGenericParameterTypes()[i];</span>

<span class="fc" id="L421">                        Field field = TypeUtils.getField(clazz, fieldName, declaredFields);</span>
<span class="fc" id="L422">                        FieldInfo fieldInfo = new FieldInfo(fieldName, clazz, fieldClass, fieldType, field,</span>
<span class="fc" id="L423">                                ordinal, serialzeFeatures, parserFeatures);</span>
<span class="fc" id="L424">                        add(fieldList, fieldInfo);</span>
                    }

<span class="fc" id="L427">                    return new JavaBeanInfo(clazz, builderClass, null, null, factoryMethod, null, jsonType, fieldList);</span>
                }
<span class="fc bfc" id="L429" title="All 2 branches covered.">            } else if (!isInterfaceOrAbstract) {</span>
<span class="fc" id="L430">                String className = clazz.getName();</span>

<span class="fc" id="L432">                String[] paramNames = null;</span>
<span class="pc bpc" id="L433" title="1 of 4 branches missed.">                if (kotlin &amp;&amp; constructors.length &gt; 0) {</span>
<span class="fc" id="L434">                    paramNames = TypeUtils.getKoltinConstructorParameters(clazz);</span>
<span class="fc" id="L435">                    creatorConstructor = TypeUtils.getKoltinConstructor(constructors, paramNames);</span>
<span class="fc" id="L436">                    TypeUtils.setAccessible(creatorConstructor);</span>
<span class="fc" id="L437">                } else {</span>

<span class="fc bfc" id="L439" title="All 2 branches covered.">                    for (Constructor constructor : constructors) {</span>
<span class="fc" id="L440">                        Class&lt;?&gt;[] parameterTypes = constructor.getParameterTypes();</span>

<span class="fc bfc" id="L442" title="All 2 branches covered.">                        if (className.equals(&quot;org.springframework.security.web.authentication.WebAuthenticationDetails&quot;)) {</span>
<span class="pc bpc" id="L443" title="2 of 6 branches missed.">                            if (parameterTypes.length == 2 &amp;&amp; parameterTypes[0] == String.class &amp;&amp; parameterTypes[1] == String.class) {</span>
<span class="fc" id="L444">                                creatorConstructor = constructor;</span>
<span class="fc" id="L445">                                creatorConstructor.setAccessible(true);</span>
<span class="fc" id="L446">                                paramNames = ASMUtils.lookupParameterNames(constructor);</span>
<span class="fc" id="L447">                                break;</span>
                            } else {
                                continue;
                            }
                        }

<span class="fc bfc" id="L453" title="All 2 branches covered.">                        if (className.equals(&quot;org.springframework.security.web.authentication.preauth.PreAuthenticatedAuthenticationToken&quot;)) {</span>
<span class="fc bfc" id="L454" title="All 2 branches covered.">                            if (parameterTypes.length == 3</span>
<span class="pc bpc" id="L455" title="1 of 2 branches missed.">                                    &amp;&amp; parameterTypes[0] == Object.class</span>
<span class="pc bpc" id="L456" title="1 of 2 branches missed.">                                    &amp;&amp; parameterTypes[1] == Object.class</span>
<span class="pc bpc" id="L457" title="1 of 2 branches missed.">                                    &amp;&amp; parameterTypes[2] == Collection.class) {</span>
<span class="fc" id="L458">                                creatorConstructor = constructor;</span>
<span class="fc" id="L459">                                creatorConstructor.setAccessible(true);</span>
<span class="fc" id="L460">                                paramNames = new String[] {&quot;principal&quot;, &quot;credentials&quot;, &quot;authorities&quot;};</span>
<span class="fc" id="L461">                                break;</span>
                            } else {
                                continue;
                            }
                        }

<span class="fc bfc" id="L467" title="All 2 branches covered.">                        if (className.equals(&quot;org.springframework.security.core.authority.SimpleGrantedAuthority&quot;)) {</span>
<span class="pc bpc" id="L468" title="1 of 2 branches missed.">                            if (parameterTypes.length == 1</span>
<span class="pc bpc" id="L469" title="1 of 2 branches missed.">                                    &amp;&amp; parameterTypes[0] == String.class) {</span>
<span class="fc" id="L470">                                creatorConstructor = constructor;</span>
<span class="fc" id="L471">                                paramNames = new String[] {&quot;authority&quot;};</span>
<span class="fc" id="L472">                                break;</span>
                            } else {
                                continue;
                            }
                        }

                        //


<span class="pc bpc" id="L481" title="1 of 2 branches missed.">                        boolean is_public = (constructor.getModifiers() &amp; Modifier.PUBLIC) != 0;</span>
<span class="pc bpc" id="L482" title="1 of 2 branches missed.">                        if (!is_public) {</span>
<span class="nc" id="L483">                            continue;</span>
                        }
<span class="fc" id="L485">                        String[] lookupParameterNames = ASMUtils.lookupParameterNames(constructor);</span>
<span class="pc bpc" id="L486" title="2 of 4 branches missed.">                        if (lookupParameterNames == null || lookupParameterNames.length == 0) {</span>
<span class="nc" id="L487">                            continue;</span>
                        }

<span class="fc bfc" id="L490" title="All 2 branches covered.">                        if (creatorConstructor != null</span>
<span class="pc bpc" id="L491" title="1 of 4 branches missed.">                                &amp;&amp; paramNames != null &amp;&amp; lookupParameterNames.length &lt;= paramNames.length) {</span>
<span class="fc" id="L492">                            continue;</span>
                        }

<span class="fc" id="L495">                        paramNames = lookupParameterNames;</span>
<span class="fc" id="L496">                        creatorConstructor = constructor;</span>
                    }
                }

<span class="fc" id="L500">                Class&lt;?&gt;[] types = null;</span>
<span class="pc bpc" id="L501" title="1 of 2 branches missed.">                if (paramNames != null) {</span>
<span class="fc" id="L502">                    types = creatorConstructor.getParameterTypes();</span>
                }

<span class="pc bpc" id="L505" title="1 of 2 branches missed.">                if (paramNames != null</span>
<span class="fc bfc" id="L506" title="All 2 branches covered.">                        &amp;&amp; types.length == paramNames.length) {</span>
<span class="fc" id="L507">                    Annotation[][] paramAnnotationArrays = TypeUtils.getParameterAnnotations(creatorConstructor);</span>
<span class="fc bfc" id="L508" title="All 2 branches covered.">                    for (int i = 0; i &lt; types.length; ++i) {</span>
<span class="fc" id="L509">                        Annotation[] paramAnnotations = paramAnnotationArrays[i];</span>
<span class="fc" id="L510">                        String paramName = paramNames[i];</span>

<span class="fc" id="L512">                        JSONField fieldAnnotation = null;</span>
<span class="pc bpc" id="L513" title="1 of 2 branches missed.">                        for (Annotation paramAnnotation : paramAnnotations) {</span>
<span class="nc bnc" id="L514" title="All 2 branches missed.">                            if (paramAnnotation instanceof JSONField) {</span>
<span class="nc" id="L515">                                fieldAnnotation = (JSONField) paramAnnotation;</span>
<span class="nc" id="L516">                                break;</span>
                            }
                        }

<span class="fc" id="L520">                        Class&lt;?&gt; fieldClass = types[i];</span>
<span class="fc" id="L521">                        Type fieldType = creatorConstructor.getGenericParameterTypes()[i];</span>
<span class="fc" id="L522">                        Field field = TypeUtils.getField(clazz, paramName, declaredFields);</span>
<span class="fc bfc" id="L523" title="All 2 branches covered.">                        if (field != null) {</span>
<span class="pc bpc" id="L524" title="1 of 2 branches missed.">                            if (fieldAnnotation == null) {</span>
<span class="fc" id="L525">                                fieldAnnotation = TypeUtils.getAnnotation(field, JSONField.class);</span>
                            }
                        }
                        final int ordinal, serialzeFeatures, parserFeatures;
<span class="fc bfc" id="L529" title="All 2 branches covered.">                        if (fieldAnnotation == null) {</span>
<span class="fc" id="L530">                            ordinal = 0;</span>
<span class="fc" id="L531">                            serialzeFeatures = 0;</span>

<span class="fc bfc" id="L533" title="All 2 branches covered.">                            if (&quot;org.springframework.security.core.userdetails.User&quot;.equals(className)</span>
<span class="fc bfc" id="L534" title="All 2 branches covered.">                                    &amp;&amp; &quot;password&quot;.equals(paramName)) {</span>
<span class="fc" id="L535">                                parserFeatures = Feature.InitStringFieldAsEmpty.mask;</span>
<span class="fc" id="L536">                            } else {</span>
<span class="fc" id="L537">                                parserFeatures = 0;</span>
                            }
<span class="fc" id="L539">                        } else {</span>
<span class="fc" id="L540">                            String nameAnnotated = fieldAnnotation.name();</span>
<span class="pc bpc" id="L541" title="1 of 2 branches missed.">                            if (nameAnnotated.length() != 0) {</span>
<span class="fc" id="L542">                                paramName = nameAnnotated;</span>
                            }
<span class="fc" id="L544">                            ordinal = fieldAnnotation.ordinal();</span>
<span class="fc" id="L545">                            serialzeFeatures = SerializerFeature.of(fieldAnnotation.serialzeFeatures());</span>
<span class="fc" id="L546">                            parserFeatures = Feature.of(fieldAnnotation.parseFeatures());</span>
                        }
<span class="fc" id="L548">                        FieldInfo fieldInfo = new FieldInfo(paramName, clazz, fieldClass, fieldType, field,</span>
<span class="fc" id="L549">                                ordinal, serialzeFeatures, parserFeatures);</span>
<span class="fc" id="L550">                        add(fieldList, fieldInfo);</span>
                    }

<span class="fc bfc" id="L553" title="All 2 branches covered.">                    if ((!kotlin)</span>
<span class="fc bfc" id="L554" title="All 2 branches covered.">                            &amp;&amp; !clazz.getName().equals(&quot;javax.servlet.http.Cookie&quot;)) {</span>
<span class="fc" id="L555">                        return new JavaBeanInfo(clazz, builderClass, null, creatorConstructor, null, null, jsonType, fieldList);</span>
                    }
                } else {
<span class="fc" id="L558">                    throw new JSONException(&quot;default constructor not found. &quot; + clazz);</span>
                }
            }
        }

<span class="fc bfc" id="L563" title="All 2 branches covered.">        if (defaultConstructor != null) {</span>
<span class="fc" id="L564">            TypeUtils.setAccessible(defaultConstructor);</span>
        }

<span class="fc bfc" id="L567" title="All 2 branches covered.">        if (builderClass != null) {</span>
<span class="fc" id="L568">            String withPrefix = null;</span>

<span class="fc" id="L570">            JSONPOJOBuilder builderAnno = TypeUtils.getAnnotation(builderClass, JSONPOJOBuilder.class);</span>
<span class="fc bfc" id="L571" title="All 2 branches covered.">            if (builderAnno != null) {</span>
<span class="fc" id="L572">                withPrefix = builderAnno.withPrefix();</span>
            }

<span class="fc bfc" id="L575" title="All 2 branches covered.">            if (withPrefix == null) {</span>
<span class="fc" id="L576">                withPrefix = &quot;with&quot;;</span>
            }

<span class="fc bfc" id="L579" title="All 2 branches covered.">            for (Method method : builderClass.getMethods()) {</span>
<span class="pc bpc" id="L580" title="1 of 2 branches missed.">                if (Modifier.isStatic(method.getModifiers())) {</span>
<span class="nc" id="L581">                    continue;</span>
                }

<span class="fc bfc" id="L584" title="All 2 branches covered.">                if (!(method.getReturnType().equals(builderClass))) {</span>
<span class="fc" id="L585">                    continue;</span>
                }

<span class="fc" id="L588">                int ordinal = 0, serialzeFeatures = 0, parserFeatures = 0;</span>

<span class="fc" id="L590">                JSONField annotation = TypeUtils.getAnnotation(method, JSONField.class);</span>

<span class="fc bfc" id="L592" title="All 2 branches covered.">                if (annotation == null) {</span>
<span class="fc" id="L593">                    annotation = TypeUtils.getSuperMethodAnnotation(clazz, method);</span>
                }

<span class="fc bfc" id="L596" title="All 2 branches covered.">                if (annotation != null) {</span>
<span class="pc bpc" id="L597" title="1 of 2 branches missed.">                    if (!annotation.deserialize()) {</span>
<span class="nc" id="L598">                        continue;</span>
                    }

<span class="fc" id="L601">                    ordinal = annotation.ordinal();</span>
<span class="fc" id="L602">                    serialzeFeatures = SerializerFeature.of(annotation.serialzeFeatures());</span>
<span class="fc" id="L603">                    parserFeatures = Feature.of(annotation.parseFeatures());</span>

<span class="pc bpc" id="L605" title="1 of 2 branches missed.">                    if (annotation.name().length() != 0) {</span>
<span class="fc" id="L606">                        String propertyName = annotation.name();</span>
<span class="fc" id="L607">                        add(fieldList, new FieldInfo(propertyName, method, null, clazz, type, ordinal, serialzeFeatures, parserFeatures,</span>
<span class="fc" id="L608">                                annotation, null, null, genericInfo));</span>
<span class="fc" id="L609">                        continue;</span>
                    }
                }

<span class="fc" id="L613">                String methodName = method.getName();</span>
                StringBuilder properNameBuilder;
<span class="pc bpc" id="L615" title="1 of 4 branches missed.">                if (methodName.startsWith(&quot;set&quot;) &amp;&amp; methodName.length() &gt; 3) {</span>
<span class="fc" id="L616">                    properNameBuilder = new StringBuilder(methodName.substring(3));</span>
<span class="fc" id="L617">                } else {</span>
<span class="fc bfc" id="L618" title="All 2 branches covered.">                    if (withPrefix.length() == 0){</span>
<span class="fc" id="L619">                        properNameBuilder = new StringBuilder(methodName);</span>
<span class="fc" id="L620">                    } else {</span>
<span class="pc bpc" id="L621" title="1 of 2 branches missed.">                        if (!methodName.startsWith(withPrefix)) {</span>
<span class="nc" id="L622">                            continue;</span>
                        }

<span class="pc bpc" id="L625" title="1 of 2 branches missed.">                        if (methodName.length() &lt;= withPrefix.length()) {</span>
<span class="nc" id="L626">                            continue;</span>
                        }
                        
<span class="fc" id="L629">                        properNameBuilder = new StringBuilder(methodName.substring(withPrefix.length()));</span>
                    }
                }

<span class="fc" id="L633">                char c0 = properNameBuilder.charAt(0);</span>
<span class="pc bpc" id="L634" title="1 of 4 branches missed.">                if (withPrefix.length() != 0 &amp;&amp; !Character.isUpperCase(c0)) {</span>
<span class="nc" id="L635">                    continue;</span>
                }

<span class="fc" id="L638">                properNameBuilder.setCharAt(0, Character.toLowerCase(c0));</span>

<span class="fc" id="L640">                String propertyName = properNameBuilder.toString();</span>

<span class="fc" id="L642">                add(fieldList, new FieldInfo(propertyName, method, null, clazz, type, ordinal, serialzeFeatures, parserFeatures,</span>
<span class="fc" id="L643">                        annotation, null, null, genericInfo));</span>
            }

<span class="pc bpc" id="L646" title="1 of 2 branches missed.">            if (builderClass != null) {</span>
<span class="fc" id="L647">                JSONPOJOBuilder builderAnnotation = TypeUtils.getAnnotation(builderClass, JSONPOJOBuilder.class);</span>

<span class="fc" id="L649">                String buildMethodName = null;</span>
<span class="fc bfc" id="L650" title="All 2 branches covered.">                if (builderAnnotation != null) {</span>
<span class="fc" id="L651">                    buildMethodName = builderAnnotation.buildMethod();</span>
                }

<span class="pc bpc" id="L654" title="1 of 4 branches missed.">                if (buildMethodName == null || buildMethodName.length() == 0) {</span>
<span class="fc" id="L655">                    buildMethodName = &quot;build&quot;;</span>
                }

                try {
<span class="fc" id="L659">                    buildMethod = builderClass.getMethod(buildMethodName);</span>
<span class="fc" id="L660">                } catch (NoSuchMethodException e) {</span>
                    // skip
<span class="nc" id="L662">                } catch (SecurityException e) {</span>
                    // skip
                }

<span class="fc bfc" id="L666" title="All 2 branches covered.">                if (buildMethod == null) {</span>
                    try {
<span class="fc" id="L668">                        buildMethod = builderClass.getMethod(&quot;create&quot;);</span>
<span class="pc" id="L669">                    } catch (NoSuchMethodException e) {</span>
                        // skip
<span class="nc" id="L671">                    } catch (SecurityException e) {</span>
                        // skip
                    }
                }

<span class="pc bpc" id="L676" title="1 of 2 branches missed.">                if (buildMethod == null) {</span>
<span class="nc" id="L677">                    throw new JSONException(&quot;buildMethod not found.&quot;);</span>
                }

<span class="fc" id="L680">                TypeUtils.setAccessible(buildMethod);</span>
            }
        }

<span class="fc bfc" id="L684" title="All 2 branches covered.">        for (Method method : methods) { //</span>
<span class="fc" id="L685">            int ordinal = 0, serialzeFeatures = 0, parserFeatures = 0;</span>
<span class="fc" id="L686">            String methodName = method.getName();</span>

<span class="fc bfc" id="L688" title="All 2 branches covered.">            if (Modifier.isStatic(method.getModifiers())) {</span>
<span class="fc" id="L689">                continue;</span>
            }

            // support builder set
<span class="fc" id="L693">            Class&lt;?&gt; returnType = method.getReturnType();</span>
<span class="fc bfc" id="L694" title="All 4 branches covered.">            if (!(returnType.equals(Void.TYPE) || returnType.equals(method.getDeclaringClass()))) {</span>
<span class="fc" id="L695">                continue;</span>
            }

<span class="fc bfc" id="L698" title="All 2 branches covered.">            if (method.getDeclaringClass() == Object.class) {</span>
<span class="fc" id="L699">                continue;</span>
            }

<span class="fc" id="L702">            Class&lt;?&gt;[] types = method.getParameterTypes();</span>

<span class="fc bfc" id="L704" title="All 4 branches covered.">            if (types.length == 0 || types.length &gt; 2) {</span>
<span class="fc" id="L705">                continue;</span>
            }

<span class="fc" id="L708">            JSONField annotation = TypeUtils.getAnnotation(method, JSONField.class);</span>
<span class="fc bfc" id="L709" title="All 2 branches covered.">            if (annotation != null</span>
<span class="fc bfc" id="L710" title="All 2 branches covered.">                    &amp;&amp; types.length == 2</span>
<span class="pc bpc" id="L711" title="1 of 2 branches missed.">                    &amp;&amp; types[0] == String.class</span>
<span class="pc bpc" id="L712" title="1 of 2 branches missed.">                    &amp;&amp; types[1] == Object.class) {</span>
<span class="fc" id="L713">                add(fieldList, new FieldInfo(&quot;&quot;, method, null, clazz, type, ordinal,</span>
<span class="fc" id="L714">                        serialzeFeatures, parserFeatures, annotation, null, null, genericInfo));</span>
<span class="fc" id="L715">                continue;</span>
            }

<span class="fc bfc" id="L718" title="All 2 branches covered.">            if (types.length != 1) {</span>
<span class="fc" id="L719">                continue;</span>
            }

<span class="fc bfc" id="L722" title="All 2 branches covered.">            if (annotation == null) {</span>
<span class="fc" id="L723">                annotation = TypeUtils.getSuperMethodAnnotation(clazz, method);</span>
            }

<span class="fc bfc" id="L726" title="All 4 branches covered.">            if (annotation == null &amp;&amp; methodName.length() &lt; 4) {</span>
<span class="fc" id="L727">                continue;</span>
            }

<span class="fc bfc" id="L730" title="All 2 branches covered.">            if (annotation != null) {</span>
<span class="fc bfc" id="L731" title="All 2 branches covered.">                if (!annotation.deserialize()) {</span>
<span class="fc" id="L732">                    continue;</span>
                }

<span class="fc" id="L735">                ordinal = annotation.ordinal();</span>
<span class="fc" id="L736">                serialzeFeatures = SerializerFeature.of(annotation.serialzeFeatures());</span>
<span class="fc" id="L737">                parserFeatures = Feature.of(annotation.parseFeatures());</span>

<span class="fc bfc" id="L739" title="All 2 branches covered.">                if (annotation.name().length() != 0) {</span>
<span class="fc" id="L740">                    String propertyName = annotation.name();</span>
<span class="fc" id="L741">                    add(fieldList, new FieldInfo(propertyName, method, null, clazz, type, ordinal, serialzeFeatures, parserFeatures,</span>
<span class="fc" id="L742">                            annotation, null, null, genericInfo));</span>
<span class="fc" id="L743">                    continue;</span>
                }
            }

<span class="fc bfc" id="L747" title="All 6 branches covered.">            if (annotation == null &amp;&amp; !methodName.startsWith(&quot;set&quot;) || builderClass != null) { // TODO &quot;set&quot;的判断放在 JSONField 注解后面，意思是允许非 setter 方法标记 JSONField 注解？</span>
<span class="fc" id="L748">                continue;</span>
            }

<span class="fc" id="L751">            char c3 = methodName.charAt(3);</span>

            String propertyName;
<span class="fc" id="L754">            Field field = null;</span>
<span class="fc bfc" id="L755" title="All 2 branches covered.">            if (Character.isUpperCase(c3) //</span>
<span class="fc bfc" id="L756" title="All 2 branches covered.">                    || c3 &gt; 512 // for unicode method name</span>
                    ) {
<span class="fc bfc" id="L758" title="All 2 branches covered.">                if (TypeUtils.compatibleWithJavaBean) {</span>
<span class="fc" id="L759">                    propertyName = TypeUtils.decapitalize(methodName.substring(3));</span>
<span class="fc" id="L760">                } else {</span>
<span class="fc" id="L761">                    propertyName = Character.toLowerCase(methodName.charAt(3)) + methodName.substring(4);</span>
                }
<span class="fc bfc" id="L763" title="All 2 branches covered.">            } else if (c3 == '_') {</span>
<span class="fc" id="L764">                propertyName = methodName.substring(4);</span>
<span class="fc" id="L765">                field = TypeUtils.getField(clazz, propertyName, declaredFields);</span>
<span class="fc bfc" id="L766" title="All 2 branches covered.">                if (field == null) {</span>
<span class="fc" id="L767">                    String temp = propertyName;</span>
<span class="fc" id="L768">                    propertyName = methodName.substring(3);</span>
<span class="fc" id="L769">                    field = TypeUtils.getField(clazz, propertyName, declaredFields);</span>
<span class="pc bpc" id="L770" title="1 of 2 branches missed.">                    if (field == null) {</span>
<span class="nc" id="L771">                        propertyName = temp; //减少修改代码带来的影响</span>
                    }
                }
<span class="pc bfc" id="L774" title="All 2 branches covered.">            } else if (c3 == 'f') {</span>
<span class="fc" id="L775">                propertyName = methodName.substring(3);</span>
<span class="pc bpc" id="L776" title="1 of 4 branches missed.">            } else if (methodName.length() &gt;= 5 &amp;&amp; Character.isUpperCase(methodName.charAt(4))) {</span>
<span class="fc" id="L777">                propertyName = TypeUtils.decapitalize(methodName.substring(3));</span>
<span class="fc" id="L778">            } else {</span>
<span class="fc" id="L779">                propertyName = methodName.substring(3);</span>
<span class="fc" id="L780">                field = TypeUtils.getField(clazz, propertyName, declaredFields);</span>
<span class="pc bpc" id="L781" title="1 of 2 branches missed.">                if (field == null) {</span>
<span class="nc" id="L782">                    continue;</span>
                }
            }

<span class="fc bfc" id="L786" title="All 2 branches covered.">            if (field == null) {</span>
<span class="fc" id="L787">                field = TypeUtils.getField(clazz, propertyName, declaredFields);</span>
            }

<span class="fc bfc" id="L790" title="All 4 branches covered.">            if (field == null &amp;&amp; types[0] == boolean.class) {</span>
<span class="fc" id="L791">                String isFieldName = &quot;is&quot; + Character.toUpperCase(propertyName.charAt(0)) + propertyName.substring(1);</span>
<span class="fc" id="L792">                field = TypeUtils.getField(clazz, isFieldName, declaredFields);</span>
            }

<span class="fc" id="L795">            JSONField fieldAnnotation = null;</span>
<span class="fc bfc" id="L796" title="All 2 branches covered.">            if (field != null) {</span>
<span class="fc" id="L797">                fieldAnnotation = TypeUtils.getAnnotation(field, JSONField.class);</span>

<span class="fc bfc" id="L799" title="All 2 branches covered.">                if (fieldAnnotation != null) {</span>
<span class="fc bfc" id="L800" title="All 2 branches covered.">                    if (!fieldAnnotation.deserialize()) {</span>
<span class="fc" id="L801">                        continue;</span>
                    }

<span class="fc" id="L804">                    ordinal = fieldAnnotation.ordinal();</span>
<span class="fc" id="L805">                    serialzeFeatures = SerializerFeature.of(fieldAnnotation.serialzeFeatures());</span>
<span class="fc" id="L806">                    parserFeatures = Feature.of(fieldAnnotation.parseFeatures());</span>

<span class="fc bfc" id="L808" title="All 2 branches covered.">                    if (fieldAnnotation.name().length() != 0) {</span>
<span class="fc" id="L809">                        propertyName = fieldAnnotation.name();</span>
<span class="fc" id="L810">                        add(fieldList, new FieldInfo(propertyName, method, field, clazz, type, ordinal,</span>
<span class="fc" id="L811">                                serialzeFeatures, parserFeatures, annotation, fieldAnnotation, null, genericInfo));</span>
<span class="fc" id="L812">                        continue;</span>
                    }
                }

            }

<span class="fc bfc" id="L818" title="All 2 branches covered.">            if (propertyNamingStrategy != null) {</span>
<span class="fc" id="L819">                propertyName = propertyNamingStrategy.translate(propertyName);</span>
            }

<span class="fc" id="L822">            add(fieldList, new FieldInfo(propertyName, method, field, clazz, type, ordinal, serialzeFeatures, parserFeatures,</span>
<span class="fc" id="L823">                    annotation, fieldAnnotation, null, genericInfo));</span>
        }

<span class="fc" id="L826">        Field[] fields = clazz.getFields();</span>
<span class="fc" id="L827">        computeFields(clazz, type, propertyNamingStrategy, fieldList, fields);</span>

<span class="fc bfc" id="L829" title="All 2 branches covered.">        for (Method method : clazz.getMethods()) { // getter methods</span>
<span class="fc" id="L830">            String methodName = method.getName();</span>
<span class="fc bfc" id="L831" title="All 2 branches covered.">            if (methodName.length() &lt; 4) {</span>
<span class="fc" id="L832">                continue;</span>
            }

<span class="fc bfc" id="L835" title="All 2 branches covered.">            if (Modifier.isStatic(method.getModifiers())) {</span>
<span class="fc" id="L836">                continue;</span>
            }

<span class="fc bfc" id="L839" title="All 6 branches covered.">            if (builderClass == null &amp;&amp; methodName.startsWith(&quot;get&quot;) &amp;&amp; Character.isUpperCase(methodName.charAt(3))) {</span>
<span class="fc bfc" id="L840" title="All 2 branches covered.">                if (method.getParameterTypes().length != 0) {</span>
<span class="fc" id="L841">                    continue;</span>
                }

<span class="fc bfc" id="L844" title="All 2 branches covered.">                if (Collection.class.isAssignableFrom(method.getReturnType()) //</span>
<span class="fc bfc" id="L845" title="All 2 branches covered.">                        || Map.class.isAssignableFrom(method.getReturnType()) //</span>
<span class="fc bfc" id="L846" title="All 2 branches covered.">                        || AtomicBoolean.class == method.getReturnType() //</span>
<span class="fc bfc" id="L847" title="All 2 branches covered.">                        || AtomicInteger.class == method.getReturnType() //</span>
<span class="fc bfc" id="L848" title="All 2 branches covered.">                        || AtomicLong.class == method.getReturnType() //</span>
                        ) {
                    String propertyName;

<span class="fc" id="L852">                    JSONField annotation = TypeUtils.getAnnotation(method, JSONField.class);</span>
<span class="pc bpc" id="L853" title="1 of 4 branches missed.">                    if (annotation != null &amp;&amp; annotation.deserialize()) {</span>
<span class="fc" id="L854">                        continue;</span>
                    }

<span class="pc bpc" id="L857" title="3 of 4 branches missed.">                    if (annotation != null &amp;&amp; annotation.name().length() &gt; 0) {</span>
<span class="nc" id="L858">                        propertyName = annotation.name();</span>
<span class="nc" id="L859">                    } else {</span>
<span class="fc" id="L860">                        propertyName = Character.toLowerCase(methodName.charAt(3)) + methodName.substring(4);</span>

<span class="fc" id="L862">                        Field field = TypeUtils.getField(clazz, propertyName, declaredFields);</span>
<span class="fc bfc" id="L863" title="All 2 branches covered.">                        if (field != null) {</span>
<span class="fc" id="L864">                            JSONField fieldAnnotation = TypeUtils.getAnnotation(field, JSONField.class);</span>
<span class="fc bfc" id="L865" title="All 4 branches covered.">                            if (fieldAnnotation != null &amp;&amp; !fieldAnnotation.deserialize()) {</span>
<span class="fc" id="L866">                                continue;</span>
                            }
                        }
                    }

<span class="fc bfc" id="L871" title="All 2 branches covered.">                    if (propertyNamingStrategy != null) {</span>
<span class="fc" id="L872">                        propertyName = propertyNamingStrategy.translate(propertyName);</span>
                    }

<span class="fc" id="L875">                    FieldInfo fieldInfo = getField(fieldList, propertyName);</span>
<span class="fc bfc" id="L876" title="All 2 branches covered.">                    if (fieldInfo != null) {</span>
<span class="fc" id="L877">                        continue;</span>
                    }

<span class="fc" id="L880">                    add(fieldList, new FieldInfo(propertyName, method, null, clazz, type, 0, 0, 0, annotation, null, null, genericInfo));</span>
                }
            }
        }

<span class="fc bfc" id="L885" title="All 2 branches covered.">        if (fieldList.size() == 0) {</span>
<span class="fc bfc" id="L886" title="All 2 branches covered.">            if (TypeUtils.isXmlField(clazz)) {</span>
<span class="fc" id="L887">                fieldBased = true;</span>
            }

<span class="fc bfc" id="L890" title="All 2 branches covered.">            if (fieldBased) {</span>
<span class="fc bfc" id="L891" title="All 2 branches covered.">                for (Class&lt;?&gt; currentClass = clazz; currentClass != null; currentClass = currentClass.getSuperclass()) {</span>
<span class="fc" id="L892">                    computeFields(clazz, type, propertyNamingStrategy, fieldList, declaredFields);</span>
                }
            }
        }

<span class="fc" id="L897">        return new JavaBeanInfo(clazz, builderClass, defaultConstructor, creatorConstructor, factoryMethod, buildMethod, jsonType, fieldList);</span>
    }

    private static void computeFields(Class&lt;?&gt; clazz, Type type, PropertyNamingStrategy propertyNamingStrategy, List&lt;FieldInfo&gt; fieldList, Field[] fields) {
<span class="fc" id="L901">        Map&lt;TypeVariable, Type&gt; genericInfo = buildGenericInfo(clazz);</span>

<span class="fc bfc" id="L903" title="All 2 branches covered.">        for (Field field : fields) { // public static fields</span>
<span class="fc" id="L904">            int modifiers = field.getModifiers();</span>
<span class="fc bfc" id="L905" title="All 2 branches covered.">            if ((modifiers &amp; Modifier.STATIC) != 0) {</span>
<span class="fc" id="L906">                continue;</span>
            }

<span class="fc bfc" id="L909" title="All 2 branches covered.">            if ((modifiers &amp; Modifier.FINAL) != 0) {</span>
<span class="fc" id="L910">                Class&lt;?&gt; fieldType = field.getType();</span>
<span class="fc bfc" id="L911" title="All 2 branches covered.">                boolean supportReadOnly = Map.class.isAssignableFrom(fieldType)</span>
<span class="fc bfc" id="L912" title="All 2 branches covered.">                        || Collection.class.isAssignableFrom(fieldType)</span>
<span class="fc bfc" id="L913" title="All 2 branches covered.">                        || AtomicLong.class.equals(fieldType) //</span>
<span class="fc bfc" id="L914" title="All 2 branches covered.">                        || AtomicInteger.class.equals(fieldType) //</span>
<span class="fc bfc" id="L915" title="All 2 branches covered.">                        || AtomicBoolean.class.equals(fieldType);</span>
<span class="fc bfc" id="L916" title="All 2 branches covered.">                if (!supportReadOnly) {</span>
<span class="fc" id="L917">                    continue;</span>
                }
            }

<span class="fc" id="L921">            boolean contains = false;</span>
<span class="fc bfc" id="L922" title="All 2 branches covered.">            for (FieldInfo item : fieldList) {</span>
<span class="fc bfc" id="L923" title="All 2 branches covered.">                if (item.name.equals(field.getName())) {</span>
<span class="fc" id="L924">                    contains = true;</span>
<span class="fc" id="L925">                    break; // 已经是 contains = true，无需继续遍历</span>
                }
            }

<span class="fc bfc" id="L929" title="All 2 branches covered.">            if (contains) {</span>
<span class="fc" id="L930">                continue;</span>
            }

<span class="fc" id="L933">            int ordinal = 0, serialzeFeatures = 0, parserFeatures = 0;</span>
<span class="fc" id="L934">            String propertyName = field.getName();</span>

<span class="fc" id="L936">            JSONField fieldAnnotation = TypeUtils.getAnnotation(field, JSONField.class);</span>

<span class="fc bfc" id="L938" title="All 2 branches covered.">            if (fieldAnnotation != null) {</span>
<span class="fc bfc" id="L939" title="All 2 branches covered.">                if (!fieldAnnotation.deserialize()) {</span>
<span class="fc" id="L940">                    continue;</span>
                }

<span class="fc" id="L943">                ordinal = fieldAnnotation.ordinal();</span>
<span class="fc" id="L944">                serialzeFeatures = SerializerFeature.of(fieldAnnotation.serialzeFeatures());</span>
<span class="fc" id="L945">                parserFeatures = Feature.of(fieldAnnotation.parseFeatures());</span>

<span class="fc bfc" id="L947" title="All 2 branches covered.">                if (fieldAnnotation.name().length() != 0) {</span>
<span class="fc" id="L948">                    propertyName = fieldAnnotation.name();</span>
                }
            }

<span class="fc bfc" id="L952" title="All 2 branches covered.">            if (propertyNamingStrategy != null) {</span>
<span class="fc" id="L953">                propertyName = propertyNamingStrategy.translate(propertyName);</span>
            }

<span class="fc" id="L956">            add(fieldList, new FieldInfo(propertyName, null, field, clazz, type, ordinal, serialzeFeatures, parserFeatures, null,</span>
<span class="fc" id="L957">                    fieldAnnotation, null, genericInfo));</span>
        }
<span class="fc" id="L959">    }</span>

    static Constructor&lt;?&gt; getDefaultConstructor(Class&lt;?&gt; clazz, final Constructor&lt;?&gt;[] constructors) {
<span class="fc bfc" id="L962" title="All 2 branches covered.">        if (Modifier.isAbstract(clazz.getModifiers())) {</span>
<span class="fc" id="L963">            return null;</span>
        }

<span class="fc" id="L966">        Constructor&lt;?&gt; defaultConstructor = null;</span>

<span class="fc bfc" id="L968" title="All 2 branches covered.">        for (Constructor&lt;?&gt; constructor : constructors) {</span>
<span class="fc bfc" id="L969" title="All 2 branches covered.">            if (constructor.getParameterTypes().length == 0) {</span>
<span class="fc" id="L970">                defaultConstructor = constructor;</span>
<span class="fc" id="L971">                break;</span>
            }
        }

<span class="fc bfc" id="L975" title="All 2 branches covered.">        if (defaultConstructor == null) {</span>
<span class="fc bfc" id="L976" title="All 4 branches covered.">            if (clazz.isMemberClass() &amp;&amp; !Modifier.isStatic(clazz.getModifiers())) {</span>
                Class&lt;?&gt;[] types;
<span class="fc bfc" id="L978" title="All 2 branches covered.">                for (Constructor&lt;?&gt; constructor : constructors) {</span>
<span class="fc bfc" id="L979" title="All 2 branches covered.">                    if ((types = constructor.getParameterTypes()).length == 1</span>
<span class="pc bpc" id="L980" title="1 of 2 branches missed.">                            &amp;&amp; types[0].equals(clazz.getDeclaringClass())) {</span>
<span class="fc" id="L981">                        defaultConstructor = constructor;</span>
<span class="fc" id="L982">                        break;</span>
                    }
                }
            }
        }

<span class="fc" id="L988">        return defaultConstructor;</span>
    }

    public static Constructor&lt;?&gt; getCreatorConstructor(Constructor[] constructors) {
<span class="fc" id="L992">        Constructor&lt;?&gt; creatorConstructor = null;</span>

<span class="fc bfc" id="L994" title="All 2 branches covered.">        for (Constructor&lt;?&gt; constructor : constructors) {</span>
<span class="fc" id="L995">            JSONCreator annotation = constructor.getAnnotation(JSONCreator.class);</span>
<span class="fc bfc" id="L996" title="All 2 branches covered.">            if (annotation != null) {</span>
<span class="pc bpc" id="L997" title="1 of 2 branches missed.">                if (creatorConstructor != null) {</span>
<span class="nc" id="L998">                    throw new JSONException(&quot;multi-JSONCreator&quot;);</span>
                }

<span class="fc" id="L1001">                creatorConstructor = constructor;</span>
                // 不应该break，否则多个构造方法上存在 JSONCreator 注解时，并不会触发上述异常抛出
            }
        }
<span class="fc bfc" id="L1005" title="All 2 branches covered.">        if (creatorConstructor != null) {</span>
<span class="fc" id="L1006">            return creatorConstructor;</span>
        }

<span class="fc bfc" id="L1009" title="All 2 branches covered.">        for (Constructor constructor : constructors) {</span>
<span class="fc" id="L1010">            Annotation[][] paramAnnotationArrays = TypeUtils.getParameterAnnotations(constructor);</span>

<span class="fc bfc" id="L1012" title="All 2 branches covered.">            if (paramAnnotationArrays.length == 0) {</span>
<span class="fc" id="L1013">                continue;</span>
            }
<span class="fc" id="L1015">            boolean match = true;</span>
<span class="fc bfc" id="L1016" title="All 2 branches covered.">            for (Annotation[] paramAnnotationArray : paramAnnotationArrays) {</span>
<span class="fc" id="L1017">                boolean paramMatch = false;</span>
<span class="pc bfc" id="L1018" title="All 2 branches covered.">                for (Annotation paramAnnotation : paramAnnotationArray) {</span>
<span class="pc bpc" id="L1019" title="1 of 2 branches missed.">                    if (paramAnnotation instanceof JSONField) {</span>
<span class="fc" id="L1020">                        paramMatch = true;</span>
<span class="fc" id="L1021">                        break;</span>
                    }
                }
<span class="fc bfc" id="L1024" title="All 2 branches covered.">                if (!paramMatch) {</span>
<span class="fc" id="L1025">                    match = false;</span>
<span class="fc" id="L1026">                    break;</span>
                }
            }

<span class="fc bfc" id="L1030" title="All 2 branches covered.">            if (match) {</span>
<span class="pc bpc" id="L1031" title="1 of 2 branches missed.">                if (creatorConstructor != null) {</span>
<span class="nc" id="L1032">                    throw new JSONException(&quot;multi-JSONCreator&quot;);</span>
                }

<span class="fc" id="L1035">                creatorConstructor = constructor;</span>
            }
        }

<span class="fc bfc" id="L1039" title="All 2 branches covered.">        if (creatorConstructor != null) {</span>
<span class="fc" id="L1040">            return creatorConstructor;</span>
        }

<span class="fc" id="L1043">        return creatorConstructor;</span>
    }

    private static Method getFactoryMethod(Class&lt;?&gt; clazz, Method[] methods, boolean jacksonCompatible) {
<span class="fc" id="L1047">        Method factoryMethod = null;</span>

<span class="fc bfc" id="L1049" title="All 2 branches covered.">        for (Method method : methods) {</span>
<span class="fc bfc" id="L1050" title="All 2 branches covered.">            if (!Modifier.isStatic(method.getModifiers())) {</span>
<span class="fc" id="L1051">                continue;</span>
            }

<span class="fc bfc" id="L1054" title="All 2 branches covered.">            if (!clazz.isAssignableFrom(method.getReturnType())) {</span>
<span class="fc" id="L1055">                continue;</span>
            }

<span class="fc" id="L1058">            JSONCreator annotation = TypeUtils.getAnnotation(method, JSONCreator.class);</span>
<span class="fc bfc" id="L1059" title="All 2 branches covered.">            if (annotation != null) {</span>
<span class="fc bfc" id="L1060" title="All 2 branches covered.">                if (factoryMethod != null) {</span>
<span class="fc" id="L1061">                    throw new JSONException(&quot;multi-JSONCreator&quot;);</span>
                }

<span class="fc" id="L1064">                factoryMethod = method;</span>
                // 不应该break，否则多个静态工厂方法上存在 JSONCreator 注解时，并不会触发上述异常抛出
            }
        }

<span class="fc bfc" id="L1069" title="All 4 branches covered.">        if (factoryMethod == null &amp;&amp; jacksonCompatible) {</span>
<span class="pc bpc" id="L1070" title="1 of 2 branches missed.">            for (Method method : methods) {</span>
<span class="fc bfc" id="L1071" title="All 2 branches covered.">                if (TypeUtils.isJacksonCreator(method)) {</span>
<span class="fc" id="L1072">                    factoryMethod = method;</span>
<span class="fc" id="L1073">                    break;</span>
                }
            }
        }
<span class="fc" id="L1077">        return factoryMethod;</span>
    }

    /**
     * @deprecated
     */
    public static Class&lt;?&gt; getBuilderClass(JSONType type) {
<span class="fc" id="L1084">        return getBuilderClass(null, type);</span>
    }

    public static Class&lt;?&gt; getBuilderClass(Class&lt;?&gt; clazz, JSONType type) {
<span class="fc bfc" id="L1088" title="All 4 branches covered.">        if (clazz != null &amp;&amp; clazz.getName().equals(&quot;org.springframework.security.web.savedrequest.DefaultSavedRequest&quot;)) {</span>
<span class="fc" id="L1089">            return TypeUtils.loadClass(&quot;org.springframework.security.web.savedrequest.DefaultSavedRequest$Builder&quot;);</span>
        }

<span class="fc bfc" id="L1092" title="All 2 branches covered.">        if (type == null) {</span>
<span class="fc" id="L1093">            return null;</span>
        }

<span class="fc" id="L1096">        Class&lt;?&gt; builderClass = type.builder();</span>

<span class="fc bfc" id="L1098" title="All 2 branches covered.">        if (builderClass == Void.class) {</span>
<span class="fc" id="L1099">            return null;</span>
        }

<span class="fc" id="L1102">        return builderClass;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.5.201910111838</span></div></body></html>