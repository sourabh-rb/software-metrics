<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>JSONPath.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">fastjson</a> &gt; <a href="index.source.html" class="el_package">com.alibaba.fastjson</a> &gt; <span class="el_source">JSONPath.java</span></div><h1>JSONPath.java</h1><pre class="source lang-java linenums">package com.alibaba.fastjson;

import java.lang.reflect.Array;
import java.lang.reflect.InvocationTargetException;
import java.math.BigDecimal;
import java.math.BigInteger;
import java.util.ArrayList;
import java.util.Calendar;
import java.util.Collection;
import java.util.HashMap;
import java.util.IdentityHashMap;
import java.util.Iterator;
import java.util.List;
import java.util.Map;
import java.util.concurrent.ConcurrentHashMap;
import java.util.concurrent.ConcurrentMap;
import java.util.regex.Matcher;
import java.util.regex.Pattern;

import com.alibaba.fastjson.parser.ParserConfig;
import com.alibaba.fastjson.parser.deserializer.FieldDeserializer;
import com.alibaba.fastjson.parser.deserializer.JavaBeanDeserializer;
import com.alibaba.fastjson.parser.deserializer.ObjectDeserializer;
import com.alibaba.fastjson.serializer.FieldSerializer;
import com.alibaba.fastjson.serializer.JavaBeanSerializer;
import com.alibaba.fastjson.serializer.ObjectSerializer;
import com.alibaba.fastjson.serializer.SerializeConfig;
import com.alibaba.fastjson.util.IOUtils;
import com.alibaba.fastjson.util.TypeUtils;

/**
 * @author wenshao[szujobs@hotmail.com]
 * @since 1.2.0
 */
public class JSONPath implements JSONAware {
<span class="fc" id="L36">    private static ConcurrentMap&lt;String, JSONPath&gt; pathCache  = new ConcurrentHashMap&lt;String, JSONPath&gt;(128, 0.75f, 1);</span>

    private final String                           path;
    private Segement[]                             segments;

    private SerializeConfig                        serializeConfig;
    private ParserConfig                           parserConfig;

    public JSONPath(String path){
<span class="fc" id="L45">        this(path, SerializeConfig.getGlobalInstance(), ParserConfig.getGlobalInstance());</span>
<span class="fc" id="L46">    }</span>

<span class="fc" id="L48">    public JSONPath(String path, SerializeConfig serializeConfig, ParserConfig parserConfig){</span>
<span class="fc bfc" id="L49" title="All 4 branches covered.">        if (path == null || path.length() == 0) {</span>
<span class="fc" id="L50">            throw new JSONPathException(&quot;json-path can not be null or empty&quot;);</span>
        }

<span class="fc" id="L53">        this.path = path;</span>
<span class="fc" id="L54">        this.serializeConfig = serializeConfig;</span>
<span class="fc" id="L55">        this.parserConfig = parserConfig;</span>
<span class="fc" id="L56">    }</span>

    protected void init() {
<span class="fc bfc" id="L59" title="All 2 branches covered.">        if (segments != null) {</span>
<span class="fc" id="L60">            return;</span>
        }

<span class="fc bfc" id="L63" title="All 2 branches covered.">        if (&quot;*&quot;.equals(path)) {</span>
<span class="fc" id="L64">            this.segments = new Segement[] { WildCardSegement.instance };</span>
        } else {
<span class="fc" id="L66">            JSONPathParser parser = new JSONPathParser(path);</span>
<span class="fc" id="L67">            this.segments = parser.explain();</span>
        }
<span class="fc" id="L69">    }</span>

    public Object eval(Object rootObject) {
<span class="fc bfc" id="L72" title="All 2 branches covered.">        if (rootObject == null) {</span>
<span class="fc" id="L73">            return null;</span>
        }

<span class="fc" id="L76">        init();</span>

<span class="fc" id="L78">        Object currentObject = rootObject;</span>
<span class="fc bfc" id="L79" title="All 2 branches covered.">        for (int i = 0; i &lt; segments.length; ++i) {</span>
<span class="fc" id="L80">            Segement segement = segments[i];</span>
<span class="fc" id="L81">            currentObject = segement.eval(this, rootObject, currentObject);</span>
        }
<span class="fc" id="L83">        return currentObject;</span>
    }

    public boolean contains(Object rootObject) {
<span class="fc bfc" id="L87" title="All 2 branches covered.">        if (rootObject == null) {</span>
<span class="fc" id="L88">            return false;</span>
        }

<span class="fc" id="L91">        init();</span>

<span class="fc" id="L93">        Object currentObject = rootObject;</span>
<span class="fc bfc" id="L94" title="All 2 branches covered.">        for (int i = 0; i &lt; segments.length; ++i) {</span>
<span class="fc" id="L95">            currentObject = segments[i].eval(this, rootObject, currentObject);</span>
<span class="fc bfc" id="L96" title="All 2 branches covered.">            if (currentObject == null) {</span>
<span class="fc" id="L97">                return false;</span>
            }
        }

<span class="fc" id="L101">        return true;</span>
    }

    @SuppressWarnings(&quot;rawtypes&quot;)
    public boolean containsValue(Object rootObject, Object value) {
<span class="fc" id="L106">        Object currentObject = eval(rootObject);</span>

<span class="fc bfc" id="L108" title="All 2 branches covered.">        if (currentObject == value) {</span>
<span class="fc" id="L109">            return true;</span>
        }

<span class="fc bfc" id="L112" title="All 2 branches covered.">        if (currentObject == null) {</span>
<span class="fc" id="L113">            return false;</span>
        }

<span class="fc bfc" id="L116" title="All 2 branches covered.">        if (currentObject instanceof Iterable) {</span>
<span class="fc" id="L117">            Iterator it = ((Iterable) currentObject).iterator();</span>
<span class="fc bfc" id="L118" title="All 2 branches covered.">            while (it.hasNext()) {</span>
<span class="fc" id="L119">                Object item = it.next();</span>
<span class="fc bfc" id="L120" title="All 2 branches covered.">                if (eq(item, value)) {</span>
<span class="fc" id="L121">                    return true;</span>
                }
<span class="fc" id="L123">            }</span>

<span class="fc" id="L125">            return false;</span>
        }

<span class="fc" id="L128">        return eq(currentObject, value);</span>
    }

    public int size(Object rootObject) {
<span class="fc bfc" id="L132" title="All 2 branches covered.">        if (rootObject == null) {</span>
<span class="fc" id="L133">            return -1;</span>
        }

<span class="fc" id="L136">        init();</span>

<span class="fc" id="L138">        Object currentObject = rootObject;</span>
<span class="fc bfc" id="L139" title="All 2 branches covered.">        for (int i = 0; i &lt; segments.length; ++i) {</span>
<span class="fc" id="L140">            currentObject = segments[i].eval(this, rootObject, currentObject);</span>
        }

<span class="fc" id="L143">        return evalSize(currentObject);</span>
    }

    @SuppressWarnings({ &quot;rawtypes&quot;, &quot;unchecked&quot; })
    public void arrayAdd(Object rootObject, Object... values) {
<span class="fc bfc" id="L148" title="All 4 branches covered.">        if (values == null || values.length == 0) {</span>
<span class="fc" id="L149">            return;</span>
        }

<span class="fc bfc" id="L152" title="All 2 branches covered.">        if (rootObject == null) {</span>
<span class="fc" id="L153">            return;</span>
        }

<span class="fc" id="L156">        init();</span>

<span class="fc" id="L158">        Object currentObject = rootObject;</span>
<span class="fc" id="L159">        Object parentObject = null;</span>
<span class="fc bfc" id="L160" title="All 2 branches covered.">        for (int i = 0; i &lt; segments.length; ++i) {</span>
<span class="pc bpc" id="L161" title="1 of 2 branches missed.">            if (i == segments.length - 1) {</span>
<span class="fc" id="L162">                parentObject = currentObject;</span>
            }
<span class="fc" id="L164">            currentObject = segments[i].eval(this, rootObject, currentObject);</span>
        }

<span class="fc" id="L167">        Object result = currentObject;</span>

<span class="fc bfc" id="L169" title="All 2 branches covered.">        if (result == null) {</span>
<span class="fc" id="L170">            throw new JSONPathException(&quot;value not found in path &quot; + path);</span>
        }

<span class="fc bfc" id="L173" title="All 2 branches covered.">        if (result instanceof Collection) {</span>
<span class="fc" id="L174">            Collection collection = (Collection) result;</span>
<span class="fc bfc" id="L175" title="All 2 branches covered.">            for (Object value : values) {</span>
<span class="fc" id="L176">                collection.add(value);</span>
            }
<span class="fc" id="L178">            return;</span>
        }

<span class="fc" id="L181">        Class&lt;?&gt; resultClass = result.getClass();</span>

        Object newResult;
<span class="fc bfc" id="L184" title="All 2 branches covered.">        if (resultClass.isArray()) {</span>
<span class="fc" id="L185">            int length = Array.getLength(result);</span>
<span class="fc" id="L186">            Object descArray = Array.newInstance(resultClass.getComponentType(), length + values.length);</span>

<span class="fc" id="L188">            System.arraycopy(result, 0, descArray, 0, length);</span>
<span class="fc bfc" id="L189" title="All 2 branches covered.">            for (int i = 0; i &lt; values.length; ++i) {</span>
<span class="fc" id="L190">                Array.set(descArray, length + i, values[i]);</span>

            }
<span class="fc" id="L193">            newResult = descArray;</span>
<span class="fc" id="L194">        } else {</span>
<span class="fc" id="L195">            throw new JSONException(&quot;unsupported array put operation. &quot; + resultClass);</span>
        }

<span class="fc" id="L198">        Segement lastSegement = segments[segments.length - 1];</span>
<span class="fc bfc" id="L199" title="All 2 branches covered.">        if (lastSegement instanceof PropertySegement) {</span>
<span class="fc" id="L200">            PropertySegement propertySegement = (PropertySegement) lastSegement;</span>
<span class="fc" id="L201">            propertySegement.setValue(this, parentObject, newResult);</span>
<span class="fc" id="L202">            return;</span>
        }

<span class="pc bpc" id="L205" title="1 of 2 branches missed.">        if (lastSegement instanceof ArrayAccessSegement) {</span>
<span class="fc" id="L206">            ((ArrayAccessSegement) lastSegement).setValue(this, parentObject, newResult);</span>
<span class="fc" id="L207">            return;</span>
        }

<span class="nc" id="L210">        throw new UnsupportedOperationException();</span>
    }
    
    public boolean remove(Object rootObject) {
<span class="pc bpc" id="L214" title="1 of 2 branches missed.">        if (rootObject == null) {</span>
<span class="nc" id="L215">            return false;</span>
        }

<span class="fc" id="L218">        init();</span>

<span class="fc" id="L220">        Object currentObject = rootObject;</span>
<span class="fc" id="L221">        Object parentObject = null;</span>
<span class="pc bpc" id="L222" title="1 of 2 branches missed.">        for (int i = 0; i &lt; segments.length; ++i) {</span>
<span class="fc bfc" id="L223" title="All 2 branches covered.">            if (i == segments.length - 1) {</span>
<span class="fc" id="L224">                parentObject = currentObject;</span>
<span class="fc" id="L225">                break;</span>
            }
<span class="fc" id="L227">            currentObject = segments[i].eval(this, rootObject, currentObject);</span>
<span class="pc bpc" id="L228" title="1 of 2 branches missed.">            if (currentObject == null) {</span>
<span class="nc" id="L229">                break;</span>
            }
        }

<span class="pc bpc" id="L233" title="1 of 2 branches missed.">        if (parentObject == null) {</span>
<span class="nc" id="L234">            return false;</span>
        }

<span class="fc" id="L237">        Segement lastSegement = segments[segments.length - 1];</span>
<span class="fc bfc" id="L238" title="All 2 branches covered.">        if (lastSegement instanceof PropertySegement) {</span>
<span class="fc" id="L239">            PropertySegement propertySegement = (PropertySegement) lastSegement;</span>

<span class="fc bfc" id="L241" title="All 2 branches covered.">            if (parentObject instanceof Collection) {</span>
<span class="pc bpc" id="L242" title="1 of 2 branches missed.">                if (segments.length &gt; 1) {</span>
<span class="fc" id="L243">                    Segement parentSegement = segments[segments.length - 2];</span>
<span class="pc bpc" id="L244" title="1 of 4 branches missed.">                    if (parentSegement instanceof RangeSegement || parentSegement instanceof MultiIndexSegement) {</span>
<span class="fc" id="L245">                        Collection collection = (Collection) parentObject;</span>
<span class="fc" id="L246">                        boolean removedOnce = false;</span>
<span class="fc bfc" id="L247" title="All 2 branches covered.">                        for (Object item : collection) {</span>
<span class="fc" id="L248">                            boolean removed = propertySegement.remove(this, item);</span>
<span class="fc bfc" id="L249" title="All 2 branches covered.">                            if (removed) {</span>
<span class="fc" id="L250">                                removedOnce = true;</span>
                            }
<span class="fc" id="L252">                        }</span>
<span class="fc" id="L253">                        return removedOnce;</span>
                    }
                }
            }
<span class="fc" id="L257">            return propertySegement.remove(this, parentObject);</span>
        }

<span class="pc bpc" id="L260" title="1 of 2 branches missed.">        if (lastSegement instanceof ArrayAccessSegement) {</span>
<span class="fc" id="L261">            return ((ArrayAccessSegement) lastSegement).remove(this, parentObject);</span>
        }

<span class="nc" id="L264">        throw new UnsupportedOperationException();</span>
    }

    public boolean set(Object rootObject, Object value) {
<span class="fc" id="L268">        return set(rootObject, value, true);</span>
    }

    public boolean set(Object rootObject, Object value, boolean p) {
<span class="fc bfc" id="L272" title="All 2 branches covered.">        if (rootObject == null) {</span>
<span class="fc" id="L273">            return false;</span>
        }

<span class="fc" id="L276">        init();</span>

<span class="fc" id="L278">        Object currentObject = rootObject;</span>
<span class="fc" id="L279">        Object parentObject = null;</span>
<span class="fc bfc" id="L280" title="All 2 branches covered.">        for (int i = 0; i &lt; segments.length; ++i) {</span>
//            if (i == segments.length - 1) {
//                parentObject = currentObject;
//                break;
//            }
//            
<span class="fc" id="L286">            parentObject = currentObject;</span>
<span class="fc" id="L287">            Segement segment = segments[i];</span>
<span class="fc" id="L288">            currentObject = segment.eval(this, rootObject, currentObject);</span>
<span class="fc bfc" id="L289" title="All 2 branches covered.">            if (currentObject == null) {</span>
<span class="fc" id="L290">                Segement nextSegement = null;</span>
<span class="fc bfc" id="L291" title="All 2 branches covered.">                if (i &lt; segments.length - 1) {</span>
<span class="fc" id="L292">                    nextSegement = segments[i + 1];</span>
                }

<span class="fc" id="L295">                Object newObj = null;</span>
<span class="fc bfc" id="L296" title="All 2 branches covered.">                if (nextSegement instanceof PropertySegement) {</span>
<span class="fc" id="L297">                    JavaBeanDeserializer beanDeserializer = null;</span>
<span class="fc" id="L298">                    Class&lt;?&gt; fieldClass = null;</span>
<span class="fc bfc" id="L299" title="All 2 branches covered.">                    if (segment instanceof PropertySegement) {</span>
<span class="fc" id="L300">                        String propertyName = ((PropertySegement) segment).propertyName;</span>
<span class="fc" id="L301">                        Class&lt;?&gt; parentClass = parentObject.getClass();</span>
<span class="fc" id="L302">                        JavaBeanDeserializer parentBeanDeserializer = getJavaBeanDeserializer(parentClass);</span>
<span class="fc bfc" id="L303" title="All 2 branches covered.">                        if (parentBeanDeserializer != null) {</span>
<span class="fc" id="L304">                            FieldDeserializer fieldDeserializer = parentBeanDeserializer.getFieldDeserializer(propertyName);</span>
<span class="fc" id="L305">                            fieldClass = fieldDeserializer.fieldInfo.fieldClass;</span>
<span class="fc" id="L306">                            beanDeserializer = getJavaBeanDeserializer(fieldClass);</span>
                        }
                    }

<span class="fc bfc" id="L310" title="All 2 branches covered.">                    if (beanDeserializer != null) {</span>

<span class="pc bpc" id="L312" title="1 of 2 branches missed.">                        if (beanDeserializer.beanInfo.defaultConstructor != null) {</span>
<span class="fc" id="L313">                            newObj = beanDeserializer.createInstance(null, fieldClass);</span>
                        } else {
<span class="nc" id="L315">                            return false;</span>
                        }
                    } else {
<span class="fc" id="L318">                        newObj = new JSONObject();</span>
                    }
<span class="fc bfc" id="L320" title="All 2 branches covered.">                } else if (nextSegement instanceof ArrayAccessSegement) {</span>
<span class="fc" id="L321">                    newObj = new JSONArray();</span>
                }
                
<span class="fc bfc" id="L324" title="All 2 branches covered.">                if (newObj != null) {</span>
<span class="fc bfc" id="L325" title="All 2 branches covered.">                    if (segment instanceof PropertySegement) {</span>
<span class="fc" id="L326">                        PropertySegement propSegement = (PropertySegement) segment;</span>
<span class="fc" id="L327">                        propSegement.setValue(this, parentObject, newObj);</span>
<span class="fc" id="L328">                        currentObject = newObj;</span>
<span class="fc" id="L329">                        continue;</span>
<span class="pc bpc" id="L330" title="1 of 2 branches missed.">                    } else if (segment instanceof ArrayAccessSegement) {</span>
<span class="fc" id="L331">                        ArrayAccessSegement arrayAccessSegement = (ArrayAccessSegement) segment;</span>
<span class="fc" id="L332">                        arrayAccessSegement.setValue(this, parentObject, newObj);</span>
<span class="fc" id="L333">                        currentObject = newObj;</span>
<span class="fc" id="L334">                        continue;</span>
                    }
                }
                
                break;
            }
        }

<span class="pc bpc" id="L342" title="1 of 2 branches missed.">        if (parentObject == null) {</span>
<span class="nc" id="L343">            return false;</span>
        }

<span class="fc" id="L346">        Segement lastSegement = segments[segments.length - 1];</span>
<span class="fc bfc" id="L347" title="All 2 branches covered.">        if (lastSegement instanceof PropertySegement) {</span>
<span class="fc" id="L348">            PropertySegement propertySegement = (PropertySegement) lastSegement;</span>
<span class="fc" id="L349">            propertySegement.setValue(this, parentObject, value);</span>
<span class="fc" id="L350">            return true;</span>
        }

<span class="pc bpc" id="L353" title="1 of 2 branches missed.">        if (lastSegement instanceof ArrayAccessSegement) {</span>
<span class="fc" id="L354">            return ((ArrayAccessSegement) lastSegement).setValue(this, parentObject, value);</span>
        }

<span class="nc" id="L357">        throw new UnsupportedOperationException();</span>
    }

    public static Object eval(Object rootObject, String path) {
<span class="fc" id="L361">        JSONPath jsonpath = compile(path);</span>
<span class="fc" id="L362">        return jsonpath.eval(rootObject);</span>
    }

    public static int size(Object rootObject, String path) {
<span class="fc" id="L366">        JSONPath jsonpath = compile(path);</span>
<span class="fc" id="L367">        Object result = jsonpath.eval(rootObject);</span>
<span class="fc" id="L368">        return jsonpath.evalSize(result);</span>
    }

    public static boolean contains(Object rootObject, String path) {
<span class="fc bfc" id="L372" title="All 2 branches covered.">        if (rootObject == null) {</span>
<span class="fc" id="L373">            return false;</span>
        }

<span class="fc" id="L376">        JSONPath jsonpath = compile(path);</span>
<span class="fc" id="L377">        return jsonpath.contains(rootObject);</span>
    }

    public static boolean containsValue(Object rootObject, String path, Object value) {
<span class="fc" id="L381">        JSONPath jsonpath = compile(path);</span>
<span class="fc" id="L382">        return jsonpath.containsValue(rootObject, value);</span>
    }

    public static void arrayAdd(Object rootObject, String path, Object... values) {
<span class="fc" id="L386">        JSONPath jsonpath = compile(path);</span>
<span class="fc" id="L387">        jsonpath.arrayAdd(rootObject, values);</span>
<span class="fc" id="L388">    }</span>

    public static boolean set(Object rootObject, String path, Object value) {
<span class="fc" id="L391">        JSONPath jsonpath = compile(path);</span>
<span class="fc" id="L392">        return jsonpath.set(rootObject, value);</span>
    }
    
    public static boolean remove(Object root, String path) {
<span class="fc" id="L396">        JSONPath jsonpath = compile(path);</span>
<span class="fc" id="L397">        return jsonpath.remove(root);</span>
    }

    public static JSONPath compile(String path) {
<span class="fc bfc" id="L401" title="All 2 branches covered.">        if (path == null) {</span>
<span class="fc" id="L402">            throw new JSONPathException(&quot;jsonpath can not be null&quot;);</span>
        }
        
<span class="fc" id="L405">        JSONPath jsonpath = pathCache.get(path);</span>
<span class="fc bfc" id="L406" title="All 2 branches covered.">        if (jsonpath == null) {</span>
<span class="fc" id="L407">            jsonpath = new JSONPath(path);</span>
<span class="pc bpc" id="L408" title="1 of 2 branches missed.">            if (pathCache.size() &lt; 1024) {</span>
<span class="fc" id="L409">                pathCache.putIfAbsent(path, jsonpath);</span>
<span class="fc" id="L410">                jsonpath = pathCache.get(path);</span>
            }
        }
<span class="fc" id="L413">        return jsonpath;</span>
    }
    
    /**
     * @since 1.2.9
     * @param json
     * @param path
     * @return
     */
    public static Object read(String json, String path) {
<span class="fc" id="L423">        Object object = JSON.parse(json);</span>
<span class="fc" id="L424">        JSONPath jsonpath = compile(path);</span>
<span class="fc" id="L425">        return jsonpath.eval(object);</span>
    }
    
    public static Map&lt;String, Object&gt; paths(Object javaObject) {
<span class="fc" id="L429">        return paths(javaObject, SerializeConfig.globalInstance);</span>
    }
    
    public static Map&lt;String, Object&gt; paths(Object javaObject, SerializeConfig config) {
<span class="fc" id="L433">        Map&lt;Object, String&gt; values = new IdentityHashMap&lt;Object, String&gt;();</span>
<span class="fc" id="L434">        paths(values, &quot;/&quot;, javaObject, config);</span>
        
<span class="fc" id="L436">        Map&lt;String, Object&gt; paths = new HashMap&lt;String, Object&gt;();</span>
<span class="fc bfc" id="L437" title="All 2 branches covered.">        for (Map.Entry&lt;Object, String&gt; entry : values.entrySet()) {</span>
<span class="fc" id="L438">            paths.put(entry.getValue(), entry.getKey());</span>
<span class="fc" id="L439">        }</span>
<span class="fc" id="L440">        return paths;</span>
    }

    @SuppressWarnings(&quot;rawtypes&quot;)
    private static void paths(Map&lt;Object, String&gt; paths, String parent, Object javaObject, SerializeConfig config) {
<span class="pc bpc" id="L445" title="1 of 2 branches missed.">        if (javaObject == null) {</span>
<span class="nc" id="L446">            return;</span>
        }
        
<span class="pc bpc" id="L449" title="1 of 2 branches missed.">        if (paths.containsKey(javaObject)) {</span>
<span class="nc" id="L450">            return;</span>
        }
        
<span class="fc" id="L453">        paths.put(javaObject, parent);</span>
        
<span class="fc bfc" id="L455" title="All 2 branches covered.">        if (javaObject instanceof Map) {</span>
<span class="fc" id="L456">            Map map = (Map) javaObject;</span>

<span class="fc bfc" id="L458" title="All 2 branches covered.">            for (Object entryObj : map.entrySet()) {</span>
<span class="fc" id="L459">                Map.Entry entry = (Map.Entry) entryObj;</span>
<span class="fc" id="L460">                Object key = entry.getKey();</span>
                
<span class="pc bpc" id="L462" title="1 of 2 branches missed.">                if (key instanceof String) {</span>
<span class="fc bfc" id="L463" title="All 2 branches covered.">                    String path = parent.equals(&quot;/&quot;) ?  &quot;/&quot; + key : parent + &quot;/&quot; + key;</span>
<span class="fc" id="L464">                    paths(paths, path, entry.getValue(), config);</span>
                }
<span class="fc" id="L466">            }</span>
<span class="fc" id="L467">            return;</span>
        }

<span class="fc bfc" id="L470" title="All 2 branches covered.">        if (javaObject instanceof Collection) {</span>
<span class="fc" id="L471">            Collection collection = (Collection) javaObject;</span>

<span class="fc" id="L473">            int i = 0;</span>
<span class="fc bfc" id="L474" title="All 2 branches covered.">            for (Object item : collection) {</span>
<span class="pc bpc" id="L475" title="1 of 2 branches missed.">                String path = parent.equals(&quot;/&quot;) ?  &quot;/&quot; + i : parent + &quot;/&quot; + i;</span>
<span class="fc" id="L476">                paths(paths, path, item, config);</span>
<span class="fc" id="L477">                ++i;</span>
<span class="fc" id="L478">            }</span>
            
<span class="fc" id="L480">            return;</span>
        }

<span class="fc" id="L483">        Class&lt;?&gt; clazz = javaObject.getClass();</span>

<span class="fc bfc" id="L485" title="All 2 branches covered.">        if (clazz.isArray()) {</span>
<span class="fc" id="L486">            int len = Array.getLength(javaObject);</span>

<span class="fc bfc" id="L488" title="All 2 branches covered.">            for (int i = 0; i &lt; len; ++i) {</span>
<span class="fc" id="L489">                Object item = Array.get(javaObject, i);</span>
                
<span class="pc bpc" id="L491" title="1 of 2 branches missed.">                String path = parent.equals(&quot;/&quot;) ?  &quot;/&quot; + i : parent + &quot;/&quot; + i;</span>
<span class="fc" id="L492">                paths(paths, path, item, config);</span>
            }
            
<span class="fc" id="L495">            return;</span>
        }

<span class="pc bpc" id="L498" title="1 of 4 branches missed.">        if (ParserConfig.isPrimitive2(clazz) || clazz.isEnum()) {</span>
<span class="fc" id="L499">            return;</span>
        }

<span class="fc" id="L502">        ObjectSerializer serializer = config.getObjectWriter(clazz);</span>
<span class="pc bpc" id="L503" title="1 of 2 branches missed.">        if (serializer instanceof JavaBeanSerializer) {</span>
<span class="fc" id="L504">            JavaBeanSerializer javaBeanSerializer = (JavaBeanSerializer) serializer;</span>
            
            try {
<span class="fc" id="L507">                Map&lt;String, Object&gt; fieldValues = javaBeanSerializer.getFieldValuesMap(javaObject);</span>
<span class="fc bfc" id="L508" title="All 2 branches covered.">                for (Map.Entry&lt;String, Object&gt; entry : fieldValues.entrySet()) {</span>
<span class="fc" id="L509">                    String key = entry.getKey();</span>
                    
<span class="pc bpc" id="L511" title="1 of 2 branches missed.">                    if (key instanceof String) {</span>
<span class="pc bpc" id="L512" title="1 of 2 branches missed.">                        String path = parent.equals(&quot;/&quot;) ?  &quot;/&quot; + key : parent + &quot;/&quot; + key;</span>
<span class="fc" id="L513">                        paths(paths, path, entry.getValue(), config);</span>
                    }
<span class="fc" id="L515">                }</span>
<span class="nc" id="L516">            } catch (Exception e) {</span>
<span class="nc" id="L517">                throw new JSONException(&quot;toJSON error&quot;, e);</span>
<span class="fc" id="L518">            }</span>
<span class="fc" id="L519">            return;</span>
        }
        
<span class="nc" id="L522">        return;</span>
    }

    public String getPath() {
<span class="nc" id="L526">        return path;</span>
    }

    static class JSONPathParser {

        private final String path;
        private int          pos;
        private char         ch;
        private int          level;

<span class="fc" id="L536">        public JSONPathParser(String path){</span>
<span class="fc" id="L537">            this.path = path;</span>
<span class="fc" id="L538">            next();</span>
<span class="fc" id="L539">        }</span>

        void next() {
<span class="fc" id="L542">            ch = path.charAt(pos++);</span>
<span class="fc" id="L543">        }</span>

        boolean isEOF() {
<span class="fc bfc" id="L546" title="All 2 branches covered.">            return pos &gt;= path.length();</span>
        }

        Segement readSegement() {
<span class="fc bfc" id="L550" title="All 4 branches covered.">            if (level == 0 &amp;&amp; path.length() == 1) {</span>
<span class="pc bpc" id="L551" title="1 of 2 branches missed.">                if (isDigitFirst(ch)) {</span>
<span class="nc" id="L552">                    int index = ch - '0';</span>
<span class="nc" id="L553">                    return new ArrayAccessSegement(index);</span>
<span class="pc bpc" id="L554" title="6 of 8 branches missed.">                } else if ((ch &gt;= 'a' &amp;&amp; ch &lt;= 'z') || ((ch &gt;= 'A' &amp;&amp; ch &lt;= 'Z'))) {</span>
<span class="nc" id="L555">                    return new PropertySegement(Character.toString(ch), false);</span>
                }
            }
<span class="fc bfc" id="L558" title="All 2 branches covered.">            while (!isEOF()) {</span>
<span class="fc" id="L559">                skipWhitespace();</span>

<span class="fc bfc" id="L561" title="All 2 branches covered.">                if (ch == '$') {</span>
<span class="fc" id="L562">                    next();</span>
<span class="fc" id="L563">                    continue;</span>
                }

<span class="fc bfc" id="L566" title="All 4 branches covered.">                if (ch == '.' || ch == '/') {</span>
<span class="fc" id="L567">                    int c0 = ch;</span>
<span class="fc" id="L568">                    boolean deep = false;</span>
<span class="fc" id="L569">                    next();</span>
<span class="fc bfc" id="L570" title="All 4 branches covered.">                    if (c0 == '.' &amp;&amp; ch == '.') {</span>
<span class="fc" id="L571">                        next();</span>
<span class="fc" id="L572">                        deep = true;</span>
<span class="fc bfc" id="L573" title="All 4 branches covered.">                        if (path.length() &gt; pos + 3</span>
                                &amp;&amp; ch == '['
<span class="pc bpc" id="L575" title="1 of 2 branches missed.">                                &amp;&amp; path.charAt(pos) == '*'</span>
<span class="pc bpc" id="L576" title="1 of 2 branches missed.">                                &amp;&amp; path.charAt(pos + 1) == ']'</span>
<span class="pc bpc" id="L577" title="1 of 2 branches missed.">                                &amp;&amp; path.charAt(pos + 2) == '.') {</span>
<span class="fc" id="L578">                            next();</span>
<span class="fc" id="L579">                            next();</span>
<span class="fc" id="L580">                            next();</span>
<span class="fc" id="L581">                            next();</span>
                        }
                    }
<span class="fc bfc" id="L584" title="All 2 branches covered.">                    if (ch == '*') {</span>
<span class="pc bpc" id="L585" title="1 of 2 branches missed.">                        if (!isEOF()) {</span>
<span class="nc" id="L586">                            next();</span>
                        }

<span class="fc" id="L589">                        return WildCardSegement.instance;</span>
                    }
                    
<span class="fc bfc" id="L592" title="All 2 branches covered.">                    if (isDigitFirst(ch)) {</span>
<span class="fc" id="L593">                        return parseArrayAccess(false);</span>
                    }

<span class="fc" id="L596">                    String propertyName = readName();</span>
<span class="fc bfc" id="L597" title="All 2 branches covered.">                    if (ch == '(') {</span>
<span class="fc" id="L598">                        next();</span>
<span class="pc bpc" id="L599" title="1 of 2 branches missed.">                        if (ch == ')') {</span>
<span class="pc bpc" id="L600" title="1 of 2 branches missed.">                            if (!isEOF()) {</span>
<span class="nc" id="L601">                                next();</span>
                            }

<span class="pc bpc" id="L604" title="1 of 2 branches missed.">                            if (&quot;size&quot;.equals(propertyName)) {</span>
<span class="fc" id="L605">                                return SizeSegement.instance;</span>
                            }

<span class="nc" id="L608">                            throw new JSONPathException(&quot;not support jsonpath : &quot; + path);</span>
                        }

<span class="nc" id="L611">                        throw new JSONPathException(&quot;not support jsonpath : &quot; + path);</span>
                    }

<span class="fc" id="L614">                    return new PropertySegement(propertyName, deep);</span>
                }

<span class="fc bfc" id="L617" title="All 2 branches covered.">                if (ch == '[') {</span>
<span class="fc" id="L618">                    return parseArrayAccess(true);</span>
                }

<span class="fc bfc" id="L621" title="All 2 branches covered.">                if (level == 0) {</span>
<span class="fc" id="L622">                    String propertyName = readName();</span>

<span class="fc" id="L624">                    return new PropertySegement(propertyName, false);</span>
                }

<span class="fc" id="L627">                throw new JSONPathException(&quot;not support jsonpath : &quot; + path);</span>
            }

<span class="fc" id="L630">            return null;</span>
        }

        public final void skipWhitespace() {
            for (;;) {
<span class="pc bpc" id="L635" title="11 of 14 branches missed.">                if (ch &lt;= ' ' &amp;&amp; (ch == ' ' || ch == '\r' || ch == '\n' || ch == '\t' || ch == '\f' || ch == '\b')) {</span>
<span class="fc" id="L636">                    next();</span>
<span class="fc" id="L637">                    continue;</span>
                } else {
                    break;
                }
            }
<span class="fc" id="L642">        }</span>

        Segement parseArrayAccess(boolean acceptBracket) {
<span class="fc bfc" id="L645" title="All 2 branches covered.">            if (acceptBracket) {</span>
<span class="fc" id="L646">                accept('[');</span>
            }

<span class="fc" id="L649">            boolean predicateFlag = false;</span>

<span class="fc bfc" id="L651" title="All 2 branches covered.">            if (ch == '?') {</span>
<span class="fc" id="L652">                next();</span>
<span class="fc" id="L653">                accept('(');</span>
<span class="fc bfc" id="L654" title="All 2 branches covered.">                if (ch == '@') {</span>
<span class="fc" id="L655">                    next();</span>
<span class="fc" id="L656">                    accept('.');</span>
                }

<span class="fc" id="L659">                predicateFlag = true;</span>
            }

<span class="fc bfc" id="L662" title="All 4 branches covered.">            if (predicateFlag || IOUtils.firstIdentifier(ch)) {</span>
<span class="fc" id="L663">                String propertyName = readName();</span>

<span class="fc" id="L665">                skipWhitespace();</span>

<span class="fc bfc" id="L667" title="All 4 branches covered.">                if (predicateFlag &amp;&amp; ch == ')') {</span>
<span class="fc" id="L668">                    next();</span>
<span class="pc bpc" id="L669" title="1 of 2 branches missed.">                    if (acceptBracket) {</span>
<span class="fc" id="L670">                        accept(']');</span>
                    }

<span class="fc" id="L673">                    return new FilterSegement(new NotNullSegement(propertyName));</span>
                }

<span class="pc bpc" id="L676" title="2 of 4 branches missed.">                if (acceptBracket &amp;&amp; ch == ']') {</span>
<span class="nc" id="L677">                    next();</span>
<span class="nc" id="L678">                    return new FilterSegement(new NotNullSegement(propertyName));</span>
                }

<span class="fc" id="L681">                Operator op = readOp();</span>

<span class="fc" id="L683">                skipWhitespace();</span>

<span class="fc bfc" id="L685" title="All 4 branches covered.">                if (op == Operator.BETWEEN || op == Operator.NOT_BETWEEN) {</span>
<span class="fc bfc" id="L686" title="All 2 branches covered.">                    final boolean not = (op == Operator.NOT_BETWEEN);</span>

<span class="fc" id="L688">                    Object startValue = readValue();</span>

<span class="fc" id="L690">                    String name = readName();</span>

<span class="pc bpc" id="L692" title="1 of 2 branches missed.">                    if (!&quot;and&quot;.equalsIgnoreCase(name)) {</span>
<span class="nc" id="L693">                        throw new JSONPathException(path);</span>
                    }

<span class="fc" id="L696">                    Object endValue = readValue();</span>

<span class="pc bpc" id="L698" title="2 of 4 branches missed.">                    if (startValue == null || endValue == null) {</span>
<span class="nc" id="L699">                        throw new JSONPathException(path);</span>
                    }

<span class="pc bpc" id="L702" title="2 of 4 branches missed.">                    if (isInt(startValue.getClass()) &amp;&amp; isInt(endValue.getClass())) {</span>
<span class="fc" id="L703">                        Filter filter = new IntBetweenSegement(propertyName, ((Number) startValue).longValue(),</span>
<span class="fc" id="L704">                                                               ((Number) endValue).longValue(), not);</span>
<span class="fc" id="L705">                        return new FilterSegement(filter);</span>
                    }

<span class="nc" id="L708">                    throw new JSONPathException(path);</span>
                }

<span class="fc bfc" id="L711" title="All 4 branches covered.">                if (op == Operator.IN || op == Operator.NOT_IN) {</span>
<span class="fc bfc" id="L712" title="All 2 branches covered.">                    final boolean not = (op == Operator.NOT_IN);</span>
<span class="fc" id="L713">                    accept('(');</span>

<span class="fc" id="L715">                    List&lt;Object&gt; valueList = new JSONArray();</span>
                    {
<span class="fc" id="L717">                        Object value = readValue();</span>
<span class="fc" id="L718">                        valueList.add(value);</span>

                        for (;;) {
<span class="fc" id="L721">                            skipWhitespace();</span>
<span class="fc bfc" id="L722" title="All 2 branches covered.">                            if (ch != ',') {</span>
<span class="fc" id="L723">                                break;</span>
                            }
<span class="fc" id="L725">                            next();</span>

<span class="fc" id="L727">                            value = readValue();</span>
<span class="fc" id="L728">                            valueList.add(value);</span>
                        }

<span class="fc" id="L731">                        accept(')');</span>
<span class="pc bpc" id="L732" title="1 of 2 branches missed.">                        if (predicateFlag) {</span>
<span class="nc" id="L733">                            accept(')');</span>
                        }

<span class="pc bpc" id="L736" title="1 of 2 branches missed.">                        if (acceptBracket) {</span>
<span class="fc" id="L737">                            accept(']');</span>
                        }
                    }

<span class="fc" id="L741">                    boolean isInt = true;</span>
<span class="fc" id="L742">                    boolean isIntObj = true;</span>
<span class="fc" id="L743">                    boolean isString = true;</span>
<span class="fc bfc" id="L744" title="All 2 branches covered.">                    for (Object item : valueList) {</span>
<span class="fc bfc" id="L745" title="All 2 branches covered.">                        if (item == null) {</span>
<span class="fc bfc" id="L746" title="All 2 branches covered.">                            if (isInt) {</span>
<span class="fc" id="L747">                                isInt = false;</span>
                            }
                            continue;
                        }

<span class="fc" id="L752">                        Class&lt;?&gt; clazz = item.getClass();</span>
<span class="pc bpc" id="L753" title="3 of 10 branches missed.">                        if (isInt &amp;&amp; !(clazz == Byte.class || clazz == Short.class || clazz == Integer.class</span>
                                       || clazz == Long.class)) {
<span class="fc" id="L755">                            isInt = false;</span>
<span class="fc" id="L756">                            isIntObj = false;</span>
                        }

<span class="fc bfc" id="L759" title="All 4 branches covered.">                        if (isString &amp;&amp; clazz != String.class) {</span>
<span class="fc" id="L760">                            isString = false;</span>
                        }
<span class="fc" id="L762">                    }</span>

<span class="fc bfc" id="L764" title="All 4 branches covered.">                    if (valueList.size() == 1 &amp;&amp; valueList.get(0) == null) {</span>
<span class="pc bpc" id="L765" title="1 of 2 branches missed.">                        if (not) {</span>
<span class="fc" id="L766">                            return new FilterSegement(new NotNullSegement(propertyName));</span>
                        } else {
<span class="nc" id="L768">                            return new FilterSegement(new NullSegement(propertyName));</span>
                        }
                    }

<span class="fc bfc" id="L772" title="All 2 branches covered.">                    if (isInt) {</span>
<span class="fc bfc" id="L773" title="All 2 branches covered.">                        if (valueList.size() == 1) {</span>
<span class="fc" id="L774">                            long value = ((Number) valueList.get(0)).longValue();</span>
<span class="fc bfc" id="L775" title="All 2 branches covered.">                            Operator intOp = not ? Operator.NE : Operator.EQ;</span>
<span class="fc" id="L776">                            return new FilterSegement(new IntOpSegement(propertyName, value, intOp));</span>
                        }

<span class="fc" id="L779">                        long[] values = new long[valueList.size()];</span>
<span class="fc bfc" id="L780" title="All 2 branches covered.">                        for (int i = 0; i &lt; values.length; ++i) {</span>
<span class="fc" id="L781">                            values[i] = ((Number) valueList.get(i)).longValue();</span>
                        }

<span class="fc" id="L784">                        return new FilterSegement(new IntInSegement(propertyName, values, not));</span>
                    }

<span class="fc bfc" id="L787" title="All 2 branches covered.">                    if (isString) {</span>
<span class="fc bfc" id="L788" title="All 2 branches covered.">                        if (valueList.size() == 1) {</span>
<span class="fc" id="L789">                            String value = (String) valueList.get(0);</span>

<span class="fc bfc" id="L791" title="All 2 branches covered.">                            Operator intOp = not ? Operator.NE : Operator.EQ;</span>
<span class="fc" id="L792">                            return new FilterSegement(new StringOpSegement(propertyName, value, intOp));</span>
                        }

<span class="fc" id="L795">                        String[] values = new String[valueList.size()];</span>
<span class="fc" id="L796">                        valueList.toArray(values);</span>

<span class="fc" id="L798">                        return new FilterSegement(new StringInSegement(propertyName, values, not));</span>
                    }

<span class="pc bpc" id="L801" title="1 of 2 branches missed.">                    if (isIntObj) {</span>
<span class="fc" id="L802">                        Long[] values = new Long[valueList.size()];</span>
<span class="fc bfc" id="L803" title="All 2 branches covered.">                        for (int i = 0; i &lt; values.length; ++i) {</span>
<span class="fc" id="L804">                            Number item = (Number) valueList.get(i);</span>
<span class="fc bfc" id="L805" title="All 2 branches covered.">                            if (item != null) {</span>
<span class="fc" id="L806">                                values[i] = item.longValue();</span>
                            }
                        }

<span class="fc" id="L810">                        return new FilterSegement(new IntObjInSegement(propertyName, values, not));</span>
                    }

<span class="nc" id="L813">                    throw new UnsupportedOperationException();</span>
                }

<span class="pc bpc" id="L816" title="1 of 4 branches missed.">                if (ch == '\'' || ch == '&quot;') {</span>
<span class="fc" id="L817">                    String strValue = readString();</span>
<span class="fc bfc" id="L818" title="All 2 branches covered.">                    if (predicateFlag) {</span>
<span class="fc" id="L819">                        accept(')');</span>
                    }
                    
<span class="pc bpc" id="L822" title="1 of 2 branches missed.">                    if (acceptBracket) {</span>
<span class="fc" id="L823">                        accept(']');</span>
                    }

<span class="fc bfc" id="L826" title="All 2 branches covered.">                    if (op == Operator.RLIKE) {</span>
<span class="fc" id="L827">                        return new FilterSegement(new RlikeSegement(propertyName, strValue, false));</span>
                    }

<span class="fc bfc" id="L830" title="All 2 branches covered.">                    if (op == Operator.NOT_RLIKE) {</span>
<span class="fc" id="L831">                        return new FilterSegement(new RlikeSegement(propertyName, strValue, true));</span>
                    }

<span class="fc bfc" id="L834" title="All 4 branches covered.">                    if (op == Operator.LIKE || op == Operator.NOT_LIKE) {</span>
<span class="pc bpc" id="L835" title="1 of 2 branches missed.">                        while (strValue.indexOf(&quot;%%&quot;) != -1) {</span>
<span class="nc" id="L836">                            strValue = strValue.replaceAll(&quot;%%&quot;, &quot;%&quot;);</span>
                        }

<span class="fc bfc" id="L839" title="All 2 branches covered.">                        final boolean not = (op == Operator.NOT_LIKE);</span>

<span class="fc" id="L841">                        int p0 = strValue.indexOf('%');</span>
<span class="fc bfc" id="L842" title="All 2 branches covered.">                        if (p0 == -1) {</span>
<span class="fc bfc" id="L843" title="All 2 branches covered.">                            if (op == Operator.LIKE) {</span>
<span class="fc" id="L844">                                op = Operator.EQ;</span>
                            } else {
<span class="fc" id="L846">                                op = Operator.NE;</span>
                            }
                        } else {
<span class="fc" id="L849">                            String[] items = strValue.split(&quot;%&quot;);</span>

<span class="fc" id="L851">                            String startsWithValue = null;</span>
<span class="fc" id="L852">                            String endsWithValue = null;</span>
<span class="fc" id="L853">                            String[] containsValues = null;</span>
<span class="fc bfc" id="L854" title="All 2 branches covered.">                            if (p0 == 0) {</span>
<span class="fc bfc" id="L855" title="All 2 branches covered.">                                if (strValue.charAt(strValue.length() - 1) == '%') {</span>
<span class="fc" id="L856">                                    containsValues = new String[items.length - 1];</span>
<span class="fc" id="L857">                                    System.arraycopy(items, 1, containsValues, 0, containsValues.length);</span>
                                } else {
<span class="fc" id="L859">                                    endsWithValue = items[items.length - 1];</span>
<span class="pc bpc" id="L860" title="1 of 2 branches missed.">                                    if (items.length &gt; 2) {</span>
<span class="nc" id="L861">                                        containsValues = new String[items.length - 2];</span>
<span class="nc" id="L862">                                        System.arraycopy(items, 1, containsValues, 0, containsValues.length);</span>
                                    }
                                }
<span class="fc bfc" id="L865" title="All 2 branches covered.">                            } else if (strValue.charAt(strValue.length() - 1) == '%') {</span>
<span class="fc" id="L866">                                containsValues = items;</span>
                            } else {
<span class="pc bpc" id="L868" title="1 of 2 branches missed.">                                if (items.length == 1) {</span>
<span class="nc" id="L869">                                    startsWithValue = items[0];</span>
<span class="fc bfc" id="L870" title="All 2 branches covered.">                                } else if (items.length == 2) {</span>
<span class="fc" id="L871">                                    startsWithValue = items[0];</span>
<span class="fc" id="L872">                                    endsWithValue = items[1];</span>
                                } else {
<span class="fc" id="L874">                                    startsWithValue = items[0];</span>
<span class="fc" id="L875">                                    endsWithValue = items[items.length - 1];</span>
<span class="fc" id="L876">                                    containsValues = new String[items.length - 2];</span>
<span class="fc" id="L877">                                    System.arraycopy(items, 1, containsValues, 0, containsValues.length);</span>
                                }
                            }

<span class="fc" id="L881">                            return new FilterSegement(new MatchSegement(propertyName, startsWithValue, endsWithValue,</span>
                                                                        containsValues, not));

                        }
                    }

<span class="fc" id="L887">                    return new FilterSegement(new StringOpSegement(propertyName, strValue, op));</span>
                }

<span class="fc bfc" id="L890" title="All 2 branches covered.">                if (isDigitFirst(ch)) {</span>
<span class="fc" id="L891">                    long value = readLongValue();</span>
<span class="fc" id="L892">                    double doubleValue = 0D;</span>
<span class="fc bfc" id="L893" title="All 2 branches covered.">                    if (ch == '.') {</span>
<span class="fc" id="L894">                        doubleValue = readDoubleValue(value);</span>
                        
                    }

<span class="fc bfc" id="L898" title="All 2 branches covered.">                    if (predicateFlag) {</span>
<span class="fc" id="L899">                        accept(')');</span>
                    }
                    
<span class="pc bpc" id="L902" title="1 of 2 branches missed.">                    if (acceptBracket) {</span>
<span class="fc" id="L903">                        accept(']');</span>
                    }

<span class="fc bfc" id="L906" title="All 2 branches covered.">                    if (doubleValue == 0) {</span>
<span class="fc" id="L907">                        return new FilterSegement(new IntOpSegement(propertyName, value, op));</span>
                    } else {
<span class="fc" id="L909">                        return new FilterSegement(new DoubleOpSegement(propertyName, doubleValue, op));    </span>
                    }
                }

<span class="fc bfc" id="L913" title="All 2 branches covered.">                if (ch == 'n') {</span>
<span class="fc" id="L914">                    String name = readName();</span>
<span class="pc bpc" id="L915" title="1 of 2 branches missed.">                    if (&quot;null&quot;.equals(name)) {</span>
<span class="fc bfc" id="L916" title="All 2 branches covered.">                        if (predicateFlag) {</span>
<span class="fc" id="L917">                            accept(')');</span>
                        }
<span class="fc" id="L919">                        accept(']');</span>

<span class="fc bfc" id="L921" title="All 2 branches covered.">                        if (op == Operator.EQ) {</span>
<span class="fc" id="L922">                            return new FilterSegement(new NullSegement(propertyName));</span>
                        }

<span class="pc bpc" id="L925" title="1 of 2 branches missed.">                        if (op == Operator.NE) {</span>
<span class="fc" id="L926">                            return new FilterSegement(new NotNullSegement(propertyName));</span>
                        }

<span class="nc" id="L929">                        throw new UnsupportedOperationException();</span>
                    }
<span class="pc bfc" id="L931" title="All 2 branches covered.">                } else if (ch == 't') {</span>
<span class="fc" id="L932">                    String name = readName();</span>
                    
<span class="pc bpc" id="L934" title="1 of 2 branches missed.">                    if (&quot;true&quot;.equals(name)) {</span>
<span class="pc bpc" id="L935" title="1 of 2 branches missed.">                        if (predicateFlag) {</span>
<span class="nc" id="L936">                            accept(')');</span>
                        }
<span class="fc" id="L938">                        accept(']');</span>

<span class="pc bpc" id="L940" title="1 of 2 branches missed.">                        if (op == Operator.EQ) {</span>
<span class="fc" id="L941">                            return new FilterSegement(new ValueSegment(propertyName, Boolean.TRUE, true));</span>
                        }

<span class="nc bnc" id="L944" title="All 2 branches missed.">                        if (op == Operator.NE) {</span>
<span class="nc" id="L945">                            return new FilterSegement(new ValueSegment(propertyName, Boolean.TRUE, false));</span>
                        }

<span class="nc" id="L948">                        throw new UnsupportedOperationException();</span>
                    }
<span class="pc bpc" id="L950" title="1 of 2 branches missed.">                } else if (ch == 'f') {</span>
<span class="fc" id="L951">                    String name = readName();</span>
                    
<span class="pc bpc" id="L953" title="1 of 2 branches missed.">                    if (&quot;false&quot;.equals(name)) {</span>
<span class="pc bpc" id="L954" title="1 of 2 branches missed.">                        if (predicateFlag) {</span>
<span class="nc" id="L955">                            accept(')');</span>
                        }
<span class="fc" id="L957">                        accept(']');</span>

<span class="pc bpc" id="L959" title="1 of 2 branches missed.">                        if (op == Operator.EQ) {</span>
<span class="fc" id="L960">                            return new FilterSegement(new ValueSegment(propertyName, Boolean.FALSE, true));</span>
                        }

<span class="nc bnc" id="L963" title="All 2 branches missed.">                        if (op == Operator.NE) {</span>
<span class="nc" id="L964">                            return new FilterSegement(new ValueSegment(propertyName, Boolean.FALSE, false));</span>
                        }

<span class="nc" id="L967">                        throw new UnsupportedOperationException();</span>
                    }
                }

<span class="nc" id="L971">                throw new UnsupportedOperationException();</span>
                // accept(')');
            }

<span class="fc" id="L975">            int start = pos - 1;</span>
<span class="fc bfc" id="L976" title="All 6 branches covered.">            while (ch != ']' &amp;&amp; ch != '/' &amp;&amp; !isEOF()) {</span>
<span class="pc bpc" id="L977" title="2 of 6 branches missed.">                if (ch == '.' //</span>
                        &amp;&amp; (!predicateFlag) // 
                        &amp;&amp; !predicateFlag) {
<span class="fc" id="L980">                    break;</span>
                }
                
<span class="fc bfc" id="L983" title="All 2 branches covered.">                if (ch == '\\') {</span>
<span class="fc" id="L984">                    next();</span>
                }
<span class="fc" id="L986">                next();</span>
            }
            
            int end;
<span class="fc bfc" id="L990" title="All 2 branches covered.">            if (acceptBracket) {</span>
<span class="fc" id="L991">                end = pos - 1;</span>
            } else {
<span class="fc bfc" id="L993" title="All 4 branches covered.">                if (ch == '/' || ch == '.') {</span>
<span class="fc" id="L994">                    end = pos - 1;</span>
                } else {
<span class="fc" id="L996">                    end = pos;</span>
                }
            }
            
<span class="fc" id="L1000">            String text = path.substring(start, end);</span>
            
<span class="fc bfc" id="L1002" title="All 2 branches covered.">            if (text.indexOf(&quot;\\.&quot;) != -1) {</span>
<span class="fc" id="L1003">                String propName = text.replaceAll(&quot;\\\\\\.&quot;,&quot;\\.&quot;);</span>
<span class="fc" id="L1004">                return new PropertySegement(propName, false);</span>
            }

<span class="fc" id="L1007">            Segement segment = buildArraySegement(text);</span>

<span class="fc bfc" id="L1009" title="All 4 branches covered.">            if (acceptBracket &amp;&amp; !isEOF()) {</span>
<span class="fc" id="L1010">                accept(']');</span>
            }

<span class="fc" id="L1013">            return segment;</span>
        }

        protected long readLongValue() {
<span class="fc" id="L1017">            int beginIndex = pos - 1;</span>
<span class="pc bpc" id="L1018" title="2 of 4 branches missed.">            if (ch == '+' || ch == '-') {</span>
<span class="nc" id="L1019">                next();</span>
            }

<span class="fc bfc" id="L1022" title="All 4 branches covered.">            while (ch &gt;= '0' &amp;&amp; ch &lt;= '9') {</span>
<span class="fc" id="L1023">                next();</span>
            }

<span class="fc" id="L1026">            int endIndex = pos - 1;</span>
<span class="fc" id="L1027">            String text = path.substring(beginIndex, endIndex);</span>
<span class="fc" id="L1028">            long value = Long.parseLong(text);</span>
<span class="fc" id="L1029">            return value;</span>
        }
        
        protected double readDoubleValue(long longValue) {
<span class="fc" id="L1033">            int beginIndex = pos - 1;</span>

<span class="fc" id="L1035">            next();</span>
<span class="pc bpc" id="L1036" title="1 of 4 branches missed.">            while (ch &gt;= '0' &amp;&amp; ch &lt;= '9') {</span>
<span class="fc" id="L1037">                next();</span>
            }

<span class="fc" id="L1040">            int endIndex = pos - 1;</span>
<span class="fc" id="L1041">            String text = path.substring(beginIndex, endIndex);</span>
<span class="fc" id="L1042">            double value = Double.parseDouble(text);</span>
<span class="fc" id="L1043">            value += longValue;</span>
<span class="fc" id="L1044">            return value;</span>
        }

        protected Object readValue() {
<span class="fc" id="L1048">            skipWhitespace();</span>

<span class="fc bfc" id="L1050" title="All 2 branches covered.">            if (isDigitFirst(ch)) {</span>
<span class="fc" id="L1051">                return readLongValue();</span>
            }

<span class="pc bpc" id="L1054" title="1 of 4 branches missed.">            if (ch == '&quot;' || ch == '\'') {</span>
<span class="fc" id="L1055">                return readString();</span>
            }

<span class="pc bpc" id="L1058" title="1 of 2 branches missed.">            if (ch == 'n') {</span>
<span class="fc" id="L1059">                String name = readName();</span>

<span class="pc bpc" id="L1061" title="1 of 2 branches missed.">                if (&quot;null&quot;.equals(name)) {</span>
<span class="fc" id="L1062">                    return null;</span>
                } else {
<span class="nc" id="L1064">                    throw new JSONPathException(path);</span>
                }
            }

<span class="nc" id="L1068">            throw new UnsupportedOperationException();</span>
        }

        static boolean isDigitFirst(char ch) {
<span class="pc bpc" id="L1072" title="2 of 8 branches missed.">            return ch == '-' || ch == '+' || (ch &gt;= '0' &amp;&amp; ch &lt;= '9');</span>
        }

        protected Operator readOp() {
<span class="fc" id="L1076">            Operator op = null;</span>
<span class="fc bfc" id="L1077" title="All 2 branches covered.">            if (ch == '=') {</span>
<span class="fc" id="L1078">                next();</span>
<span class="fc" id="L1079">                op = Operator.EQ;</span>
<span class="fc bfc" id="L1080" title="All 2 branches covered.">            } else if (ch == '!') {</span>
<span class="fc" id="L1081">                next();</span>
<span class="fc" id="L1082">                accept('=');</span>
<span class="fc" id="L1083">                op = Operator.NE;</span>
<span class="fc bfc" id="L1084" title="All 2 branches covered.">            } else if (ch == '&lt;') {</span>
<span class="fc" id="L1085">                next();</span>
<span class="fc bfc" id="L1086" title="All 2 branches covered.">                if (ch == '=') {</span>
<span class="fc" id="L1087">                    next();</span>
<span class="fc" id="L1088">                    op = Operator.LE;</span>
                } else {
<span class="fc" id="L1090">                    op = Operator.LT;</span>
                }
<span class="fc bfc" id="L1092" title="All 2 branches covered.">            } else if (ch == '&gt;') {</span>
<span class="fc" id="L1093">                next();</span>
<span class="fc bfc" id="L1094" title="All 2 branches covered.">                if (ch == '=') {</span>
<span class="fc" id="L1095">                    next();</span>
<span class="fc" id="L1096">                    op = Operator.GE;</span>
                } else {
<span class="fc" id="L1098">                    op = Operator.GT;</span>
                }
            }

<span class="fc bfc" id="L1102" title="All 2 branches covered.">            if (op == null) {</span>
<span class="fc" id="L1103">                String name = readName();</span>

<span class="fc bfc" id="L1105" title="All 2 branches covered.">                if (&quot;not&quot;.equalsIgnoreCase(name)) {</span>
<span class="fc" id="L1106">                    skipWhitespace();</span>

<span class="fc" id="L1108">                    name = readName();</span>

<span class="fc bfc" id="L1110" title="All 2 branches covered.">                    if (&quot;like&quot;.equalsIgnoreCase(name)) {</span>
<span class="fc" id="L1111">                        op = Operator.NOT_LIKE;</span>
<span class="fc bfc" id="L1112" title="All 2 branches covered.">                    } else if (&quot;rlike&quot;.equalsIgnoreCase(name)) {</span>
<span class="fc" id="L1113">                        op = Operator.NOT_RLIKE;</span>
<span class="fc bfc" id="L1114" title="All 2 branches covered.">                    } else if (&quot;in&quot;.equalsIgnoreCase(name)) {</span>
<span class="fc" id="L1115">                        op = Operator.NOT_IN;</span>
<span class="pc bpc" id="L1116" title="1 of 2 branches missed.">                    } else if (&quot;between&quot;.equalsIgnoreCase(name)) {</span>
<span class="fc" id="L1117">                        op = Operator.NOT_BETWEEN;</span>
                    } else {
<span class="nc" id="L1119">                        throw new UnsupportedOperationException();</span>
                    }
                } else {
<span class="fc bfc" id="L1122" title="All 2 branches covered.">                    if (&quot;like&quot;.equalsIgnoreCase(name)) {</span>
<span class="fc" id="L1123">                        op = Operator.LIKE;</span>
<span class="fc bfc" id="L1124" title="All 2 branches covered.">                    } else if (&quot;rlike&quot;.equalsIgnoreCase(name)) {</span>
<span class="fc" id="L1125">                        op = Operator.RLIKE;</span>
<span class="fc bfc" id="L1126" title="All 2 branches covered.">                    } else if (&quot;in&quot;.equalsIgnoreCase(name)) {</span>
<span class="fc" id="L1127">                        op = Operator.IN;</span>
<span class="pc bpc" id="L1128" title="1 of 2 branches missed.">                    } else if (&quot;between&quot;.equalsIgnoreCase(name)) {</span>
<span class="fc" id="L1129">                        op = Operator.BETWEEN;</span>
                    } else {
<span class="nc" id="L1131">                        throw new UnsupportedOperationException();</span>
                    }
                }
            }
<span class="fc" id="L1135">            return op;</span>
        }

        String readName() {
<span class="fc" id="L1139">            skipWhitespace();</span>

<span class="pc bpc" id="L1141" title="1 of 4 branches missed.">            if (ch != '\\' &amp;&amp; !IOUtils.firstIdentifier(ch)) {</span>
<span class="nc" id="L1142">                throw new JSONPathException(&quot;illeal jsonpath syntax. &quot; + path);</span>
            }

<span class="fc" id="L1145">            StringBuilder buf = new StringBuilder();</span>
<span class="fc bfc" id="L1146" title="All 2 branches covered.">            while (!isEOF()) {</span>
<span class="fc bfc" id="L1147" title="All 2 branches covered.">                if (ch == '\\') {</span>
<span class="fc" id="L1148">                    next();</span>
<span class="fc" id="L1149">                    buf.append(ch);</span>
<span class="fc bfc" id="L1150" title="All 2 branches covered.">                    if (isEOF()) {</span>
<span class="fc" id="L1151">                        break;</span>
                    }
<span class="fc" id="L1153">                    next();</span>
<span class="fc" id="L1154">                    continue;</span>
                }

<span class="fc" id="L1157">                boolean identifierFlag = IOUtils.isIdent(ch);</span>
<span class="fc bfc" id="L1158" title="All 2 branches covered.">                if (!identifierFlag) {</span>
<span class="fc" id="L1159">                    break;</span>
                }
<span class="fc" id="L1161">                buf.append(ch);</span>
<span class="fc" id="L1162">                next();</span>
<span class="fc" id="L1163">            }</span>

<span class="fc bfc" id="L1165" title="All 4 branches covered.">            if (isEOF() &amp;&amp; IOUtils.isIdent(ch)) {</span>
<span class="fc" id="L1166">                buf.append(ch);</span>
            }

<span class="fc" id="L1169">            String propertyName = buf.toString();</span>

<span class="fc" id="L1171">            return propertyName;</span>
        }

        String readString() {
<span class="fc" id="L1175">            char quoate = ch;</span>
<span class="fc" id="L1176">            next();</span>

<span class="fc" id="L1178">            int beginIndex = pos - 1;</span>
<span class="pc bpc" id="L1179" title="1 of 4 branches missed.">            while (ch != quoate &amp;&amp; !isEOF()) {</span>
<span class="fc" id="L1180">                next();</span>
            }

<span class="pc bpc" id="L1183" title="1 of 2 branches missed.">            String strValue = path.substring(beginIndex, isEOF() ? pos : pos - 1);</span>

<span class="fc" id="L1185">            accept(quoate);</span>

<span class="fc" id="L1187">            return strValue;</span>
        }

        void accept(char expect) {
<span class="pc bpc" id="L1191" title="1 of 2 branches missed.">            if (ch != expect) {</span>
<span class="nc" id="L1192">                throw new JSONPathException(&quot;expect '&quot; + expect + &quot;, but '&quot; + ch + &quot;'&quot;);</span>
            }

<span class="fc bfc" id="L1195" title="All 2 branches covered.">            if (!isEOF()) {</span>
<span class="fc" id="L1196">                next();</span>
            }
<span class="fc" id="L1198">        }</span>

        public Segement[] explain() {
<span class="pc bpc" id="L1201" title="2 of 4 branches missed.">            if (path == null || path.length() == 0) {</span>
<span class="nc" id="L1202">                throw new IllegalArgumentException();</span>
            }

<span class="fc" id="L1205">            Segement[] segements = new Segement[8];</span>

            for (;;) {
<span class="fc" id="L1208">                Segement segment = readSegement();</span>
<span class="fc bfc" id="L1209" title="All 2 branches covered.">                if (segment == null) {</span>
<span class="fc" id="L1210">                    break;</span>
                }
                
<span class="fc bfc" id="L1213" title="All 2 branches covered.">                if (level == segements.length) {</span>
<span class="fc" id="L1214">                    Segement[] t = new Segement[level * 3 / 2];</span>
<span class="fc" id="L1215">                    System.arraycopy(segements, 0, t, 0, level);</span>
<span class="fc" id="L1216">                    segements = t;</span>
                }
<span class="fc" id="L1218">                segements[level++] = segment;</span>
<span class="fc" id="L1219">            }</span>

<span class="pc bpc" id="L1221" title="1 of 2 branches missed.">            if (level == segements.length) {</span>
<span class="nc" id="L1222">                return segements;</span>
            }

<span class="fc" id="L1225">            Segement[] result = new Segement[level];</span>
<span class="fc" id="L1226">            System.arraycopy(segements, 0, result, 0, level);</span>
<span class="fc" id="L1227">            return result;</span>
        }

        Segement buildArraySegement(String indexText) {
<span class="fc" id="L1231">            final int indexTextLen = indexText.length();</span>
<span class="fc" id="L1232">            final char firstChar = indexText.charAt(0);</span>
<span class="fc" id="L1233">            final char lastChar = indexText.charAt(indexTextLen - 1);</span>

<span class="fc" id="L1235">            int commaIndex = indexText.indexOf(',');</span>

<span class="pc bpc" id="L1237" title="1 of 6 branches missed.">            if (indexText.length() &gt; 2 &amp;&amp; firstChar == '\'' &amp;&amp; lastChar == '\'') {</span>

<span class="fc bfc" id="L1239" title="All 2 branches covered.">                if (commaIndex == -1) {</span>
<span class="fc" id="L1240">                    String propertyName = indexText.substring(1, indexTextLen - 1);</span>
<span class="fc" id="L1241">                    return new PropertySegement(propertyName, false);</span>
                }

<span class="fc" id="L1244">                String[] indexesText = indexText.split(&quot;,&quot;);</span>
<span class="fc" id="L1245">                String[] propertyNames = new String[indexesText.length];</span>
<span class="fc bfc" id="L1246" title="All 2 branches covered.">                for (int i = 0; i &lt; indexesText.length; ++i) {</span>
<span class="fc" id="L1247">                    String indexesTextItem = indexesText[i];</span>
<span class="fc" id="L1248">                    propertyNames[i] = indexesTextItem.substring(1, indexesTextItem.length() - 1);</span>
                }

<span class="fc" id="L1251">                return new MultiPropertySegement(propertyNames);</span>
            }

<span class="fc" id="L1254">            int colonIndex = indexText.indexOf(':');</span>

<span class="fc bfc" id="L1256" title="All 4 branches covered.">            if (commaIndex == -1 &amp;&amp; colonIndex == -1) {</span>
<span class="fc bfc" id="L1257" title="All 2 branches covered.">                if (TypeUtils.isNumber(indexText)) {</span>
                    try {
<span class="fc" id="L1259">                        int index = Integer.parseInt(indexText);</span>
<span class="fc" id="L1260">                        return new ArrayAccessSegement(index);</span>
<span class="fc" id="L1261">                    }catch (NumberFormatException ex){</span>
<span class="fc" id="L1262">                        return new PropertySegement(indexText, false); // fix ISSUE-1208</span>
                    }
                } else {
<span class="fc" id="L1265">                    return new PropertySegement(indexText, false);</span>
                }
            }

<span class="fc bfc" id="L1269" title="All 2 branches covered.">            if (commaIndex != -1) {</span>
<span class="fc" id="L1270">                String[] indexesText = indexText.split(&quot;,&quot;);</span>
<span class="fc" id="L1271">                int[] indexes = new int[indexesText.length];</span>
<span class="fc bfc" id="L1272" title="All 2 branches covered.">                for (int i = 0; i &lt; indexesText.length; ++i) {</span>
<span class="fc" id="L1273">                    indexes[i] = Integer.parseInt(indexesText[i]);</span>
                }
<span class="fc" id="L1275">                return new MultiIndexSegement(indexes);</span>
            }

<span class="pc bpc" id="L1278" title="1 of 2 branches missed.">            if (colonIndex != -1) {</span>
<span class="fc" id="L1279">                String[] indexesText = indexText.split(&quot;:&quot;);</span>
<span class="fc" id="L1280">                int[] indexes = new int[indexesText.length];</span>
<span class="fc bfc" id="L1281" title="All 2 branches covered.">                for (int i = 0; i &lt; indexesText.length; ++i) {</span>
<span class="fc" id="L1282">                    String str = indexesText[i];</span>
<span class="fc bfc" id="L1283" title="All 2 branches covered.">                    if (str.length() == 0) {</span>
<span class="pc bpc" id="L1284" title="1 of 2 branches missed.">                        if (i == 0) {</span>
<span class="fc" id="L1285">                            indexes[i] = 0;</span>
                        } else {
<span class="nc" id="L1287">                            throw new UnsupportedOperationException();</span>
                        }
                    } else {
<span class="fc" id="L1290">                        indexes[i] = Integer.parseInt(str);</span>
                    }
                }

<span class="fc" id="L1294">                int start = indexes[0];</span>
                int end;
<span class="fc bfc" id="L1296" title="All 2 branches covered.">                if (indexes.length &gt; 1) {</span>
<span class="fc" id="L1297">                    end = indexes[1];</span>
                } else {
<span class="fc" id="L1299">                    end = -1;</span>
                }
                int step;
<span class="fc bfc" id="L1302" title="All 2 branches covered.">                if (indexes.length == 3) {</span>
<span class="fc" id="L1303">                    step = indexes[2];</span>
                } else {
<span class="fc" id="L1305">                    step = 1;</span>
                }

<span class="pc bpc" id="L1308" title="1 of 4 branches missed.">                if (end &gt;= 0 &amp;&amp; end &lt; start) {</span>
<span class="nc" id="L1309">                    throw new UnsupportedOperationException(&quot;end must greater than or equals start. start &quot; + start</span>
                                                            + &quot;,  end &quot; + end);
                }

<span class="pc bpc" id="L1313" title="1 of 2 branches missed.">                if (step &lt;= 0) {</span>
<span class="nc" id="L1314">                    throw new UnsupportedOperationException(&quot;step must greater than zero : &quot; + step);</span>
                }
<span class="fc" id="L1316">                return new RangeSegement(start, end, step);</span>
            }

<span class="nc" id="L1319">            throw new UnsupportedOperationException();</span>
        }
    }

    interface Segement {

        Object eval(JSONPath path, Object rootObject, Object currentObject);
    }


<span class="fc" id="L1329">    static class SizeSegement implements Segement {</span>

<span class="fc" id="L1331">        public final static SizeSegement instance = new SizeSegement();</span>

        public Integer eval(JSONPath path, Object rootObject, Object currentObject) {
<span class="fc" id="L1334">            return path.evalSize(currentObject);</span>
        }
    }

    static class PropertySegement implements Segement {

        private final String  propertyName;
        private final long    propertyNameHash;
        private final boolean deep;

<span class="fc" id="L1344">        public PropertySegement(String propertyName, boolean deep){</span>
<span class="fc" id="L1345">            this.propertyName = propertyName;</span>
<span class="fc" id="L1346">            this.propertyNameHash = TypeUtils.fnv1a_64(propertyName);</span>
<span class="fc" id="L1347">            this.deep = deep;</span>
<span class="fc" id="L1348">        }</span>

        public Object eval(JSONPath path, Object rootObject, Object currentObject) {
<span class="fc bfc" id="L1351" title="All 2 branches covered.">            if (deep) {</span>
<span class="fc" id="L1352">                List&lt;Object&gt; results = new ArrayList&lt;Object&gt;();</span>
<span class="fc" id="L1353">                path.deepScan(currentObject, propertyName, results);</span>
<span class="fc" id="L1354">                return results;</span>
            } else {
                // return path.getPropertyValue(currentObject, propertyName, true);
<span class="fc" id="L1357">                return path.getPropertyValue(currentObject, propertyName, propertyNameHash);</span>
            }
        }

        public void setValue(JSONPath path, Object parent, Object value) {
<span class="fc bfc" id="L1362" title="All 2 branches covered.">            if (deep) {</span>
<span class="fc" id="L1363">                path.deepSet(parent, propertyName, propertyNameHash, value);</span>
            } else {
<span class="fc" id="L1365">                path.setPropertyValue(parent, propertyName, propertyNameHash, value);</span>
            }
<span class="fc" id="L1367">        }</span>
        
        public boolean remove(JSONPath path, Object parent) {
<span class="fc" id="L1370">            return path.removePropertyValue(parent, propertyName);</span>
        }
    }

    static class MultiPropertySegement implements Segement {

        private final String[] propertyNames;
        private final long[]   propertyNamesHash;

<span class="fc" id="L1379">        public MultiPropertySegement(String[] propertyNames){</span>
<span class="fc" id="L1380">            this.propertyNames = propertyNames;</span>
<span class="fc" id="L1381">            this.propertyNamesHash = new long[propertyNames.length];</span>
<span class="fc bfc" id="L1382" title="All 2 branches covered.">            for (int i = 0; i &lt; propertyNamesHash.length; i++) {</span>
<span class="fc" id="L1383">                propertyNamesHash[i] = TypeUtils.fnv1a_64(propertyNames[i]);</span>
            }
<span class="fc" id="L1385">        }</span>

        public Object eval(JSONPath path, Object rootObject, Object currentObject) {
<span class="fc" id="L1388">            List&lt;Object&gt; fieldValues = new ArrayList&lt;Object&gt;(propertyNames.length);</span>

<span class="fc bfc" id="L1390" title="All 2 branches covered.">            for (int i = 0; i &lt; propertyNames.length; i++) {</span>
<span class="fc" id="L1391">                Object fieldValue = path.getPropertyValue(currentObject, propertyNames[i], propertyNamesHash[i]);</span>
<span class="fc" id="L1392">                fieldValues.add(fieldValue);</span>
            }

<span class="fc" id="L1395">            return fieldValues;</span>
        }
    }

<span class="fc" id="L1399">    static class WildCardSegement implements Segement {</span>

<span class="fc" id="L1401">        public static WildCardSegement instance = new WildCardSegement();</span>

        public Object eval(JSONPath path, Object rootObject, Object currentObject) {
<span class="fc" id="L1404">            return path.getPropertyValues(currentObject);</span>
        }

    }

    static class ArrayAccessSegement implements Segement {

        private final int index;

<span class="fc" id="L1413">        public ArrayAccessSegement(int index){</span>
<span class="fc" id="L1414">            this.index = index;</span>
<span class="fc" id="L1415">        }</span>

        public Object eval(JSONPath path, Object rootObject, Object currentObject) {
<span class="fc" id="L1418">            return path.getArrayItem(currentObject, index);</span>
        }

        public boolean setValue(JSONPath path, Object currentObject, Object value) {
<span class="fc" id="L1422">            return path.setArrayItem(path, currentObject, index, value);</span>
        }
        
        public boolean remove(JSONPath path, Object currentObject) {
<span class="fc" id="L1426">            return path.removeArrayItem(path, currentObject, index);</span>
        }
    }

    static class MultiIndexSegement implements Segement {

        private final int[] indexes;

<span class="fc" id="L1434">        public MultiIndexSegement(int[] indexes){</span>
<span class="fc" id="L1435">            this.indexes = indexes;</span>
<span class="fc" id="L1436">        }</span>

        public Object eval(JSONPath path, Object rootObject, Object currentObject) {
<span class="fc" id="L1439">            List&lt;Object&gt; items = new ArrayList&lt;Object&gt;(indexes.length);</span>
<span class="fc bfc" id="L1440" title="All 2 branches covered.">            for (int i = 0; i &lt; indexes.length; ++i) {</span>
<span class="fc" id="L1441">                Object item = path.getArrayItem(currentObject, indexes[i]);</span>
<span class="fc" id="L1442">                items.add(item);</span>
            }
<span class="fc" id="L1444">            return items;</span>
        }
    }

    static class RangeSegement implements Segement {

        private final int start;
        private final int end;
        private final int step;

<span class="fc" id="L1454">        public RangeSegement(int start, int end, int step){</span>
<span class="fc" id="L1455">            this.start = start;</span>
<span class="fc" id="L1456">            this.end = end;</span>
<span class="fc" id="L1457">            this.step = step;</span>
<span class="fc" id="L1458">        }</span>

        public Object eval(JSONPath path, Object rootObject, Object currentObject) {
<span class="fc" id="L1461">            int size = SizeSegement.instance.eval(path, rootObject, currentObject);</span>
<span class="pc bpc" id="L1462" title="1 of 2 branches missed.">            int start = this.start &gt;= 0 ? this.start : this.start + size;</span>
<span class="fc bfc" id="L1463" title="All 2 branches covered.">            int end = this.end &gt;= 0 ? this.end : this.end + size;</span>

<span class="fc" id="L1465">            int array_size = (end - start) / step + 1;</span>
<span class="fc bfc" id="L1466" title="All 2 branches covered.">            if (array_size == -1) {</span>
<span class="fc" id="L1467">                return null;</span>
            }

<span class="fc" id="L1470">            List&lt;Object&gt; items = new ArrayList&lt;Object&gt;(array_size);</span>
<span class="fc bfc" id="L1471" title="All 4 branches covered.">            for (int i = start; i &lt;= end &amp;&amp; i &lt; size; i += step) {</span>
<span class="fc" id="L1472">                Object item = path.getArrayItem(currentObject, i);</span>
<span class="fc" id="L1473">                items.add(item);</span>
            }
<span class="fc" id="L1475">            return items;</span>
        }
    }

    static class NotNullSegement implements Filter {

        private final String propertyName;
        private final long   propertyNameHash;


<span class="fc" id="L1485">        public NotNullSegement(String propertyName){</span>
<span class="fc" id="L1486">            this.propertyName = propertyName;</span>
<span class="fc" id="L1487">            this.propertyNameHash = TypeUtils.fnv1a_64(propertyName);</span>
<span class="fc" id="L1488">        }</span>

        public boolean apply(JSONPath path, Object rootObject, Object currentObject, Object item) {
<span class="fc" id="L1491">            Object propertyValue = path.getPropertyValue(item, propertyName, propertyNameHash);</span>

<span class="fc bfc" id="L1493" title="All 2 branches covered.">            return propertyValue != null;</span>
        }
    }

    static class NullSegement implements Filter {

        private final String propertyName;
        private final long   propertyNameHash;

<span class="fc" id="L1502">        public NullSegement(String propertyName){</span>
<span class="fc" id="L1503">            this.propertyName = propertyName;</span>
<span class="fc" id="L1504">            this.propertyNameHash = TypeUtils.fnv1a_64(propertyName);</span>
<span class="fc" id="L1505">        }</span>

        public boolean apply(JSONPath path, Object rootObject, Object currentObject, Object item) {
<span class="fc" id="L1508">            Object propertyValue = path.getPropertyValue(item, propertyName, propertyNameHash);</span>

<span class="fc bfc" id="L1510" title="All 2 branches covered.">            return propertyValue == null;</span>
        }
    }
    
    static class ValueSegment implements Filter {
        private final String propertyName;
        private final long   propertyNameHash;
        private final Object value;
<span class="fc" id="L1518">        private boolean eq = true;</span>
        
<span class="fc" id="L1520">        public ValueSegment(String propertyName, Object value, boolean eq){</span>
<span class="pc bpc" id="L1521" title="1 of 2 branches missed.">            if (value == null) {</span>
<span class="nc" id="L1522">                throw new IllegalArgumentException(&quot;value is null&quot;);</span>
            }
<span class="fc" id="L1524">            this.propertyName = propertyName;</span>
<span class="fc" id="L1525">            this.propertyNameHash = TypeUtils.fnv1a_64(propertyName);</span>
<span class="fc" id="L1526">            this.value = value;</span>
<span class="fc" id="L1527">            this.eq = eq;</span>
<span class="fc" id="L1528">        }</span>

        public boolean apply(JSONPath path, Object rootObject, Object currentObject, Object item) {
<span class="fc" id="L1531">            Object propertyValue = path.getPropertyValue(item, propertyName, propertyNameHash);</span>
<span class="fc" id="L1532">            boolean result = value.equals(propertyValue);</span>
<span class="pc bpc" id="L1533" title="1 of 2 branches missed.">            if (!eq) {</span>
<span class="nc bnc" id="L1534" title="All 2 branches missed.">                result = !result;</span>
            }
<span class="fc" id="L1536">            return result;</span>
        }
        
    }

    static class IntInSegement implements Filter {

        private final String  propertyName;
        private final long    propertyNameHash;
        private final long[]  values;
        private final boolean not;

<span class="fc" id="L1548">        public IntInSegement(String propertyName, long[] values, boolean not){</span>
<span class="fc" id="L1549">            this.propertyName = propertyName;</span>
<span class="fc" id="L1550">            this.propertyNameHash = TypeUtils.fnv1a_64(propertyName);</span>
<span class="fc" id="L1551">            this.values = values;</span>
<span class="fc" id="L1552">            this.not = not;</span>
<span class="fc" id="L1553">        }</span>

        public boolean apply(JSONPath path, Object rootObject, Object currentObject, Object item) {
<span class="fc" id="L1556">            Object propertyValue = path.getPropertyValue(item, propertyName, propertyNameHash);</span>

<span class="pc bpc" id="L1558" title="1 of 2 branches missed.">            if (propertyValue == null) {</span>
<span class="nc" id="L1559">                return false;</span>
            }

<span class="pc bpc" id="L1562" title="1 of 2 branches missed.">            if (propertyValue instanceof Number) {</span>
<span class="fc" id="L1563">                long longPropertyValue = ((Number) propertyValue).longValue();</span>
<span class="fc bfc" id="L1564" title="All 2 branches covered.">                for (long value : values) {</span>
<span class="fc bfc" id="L1565" title="All 2 branches covered.">                    if (value == longPropertyValue) {</span>
<span class="pc bpc" id="L1566" title="1 of 2 branches missed.">                        return !not;</span>
                    }
                }
            }

<span class="fc" id="L1571">            return not;</span>
        }
    }

    static class IntBetweenSegement implements Filter {

        private final String  propertyName;
        private final long    propertyNameHash;
        private final long    startValue;
        private final long    endValue;
        private final boolean not;

<span class="fc" id="L1583">        public IntBetweenSegement(String propertyName, long startValue, long endValue, boolean not){</span>
<span class="fc" id="L1584">            this.propertyName = propertyName;</span>
<span class="fc" id="L1585">            this.propertyNameHash = TypeUtils.fnv1a_64(propertyName);</span>
<span class="fc" id="L1586">            this.startValue = startValue;</span>
<span class="fc" id="L1587">            this.endValue = endValue;</span>
<span class="fc" id="L1588">            this.not = not;</span>
<span class="fc" id="L1589">        }</span>

        public boolean apply(JSONPath path, Object rootObject, Object currentObject, Object item) {
<span class="fc" id="L1592">            Object propertyValue = path.getPropertyValue(item, propertyName, propertyNameHash);</span>

<span class="pc bpc" id="L1594" title="1 of 2 branches missed.">            if (propertyValue == null) {</span>
<span class="nc" id="L1595">                return false;</span>
            }

<span class="pc bpc" id="L1598" title="1 of 2 branches missed.">            if (propertyValue instanceof Number) {</span>
<span class="fc" id="L1599">                long longPropertyValue = ((Number) propertyValue).longValue();</span>
<span class="pc bpc" id="L1600" title="1 of 4 branches missed.">                if (longPropertyValue &gt;= startValue &amp;&amp; longPropertyValue &lt;= endValue) {</span>
<span class="fc bfc" id="L1601" title="All 2 branches covered.">                    return !not;</span>
                }
            }

<span class="fc" id="L1605">            return not;</span>
        }
    }

    static class IntObjInSegement implements Filter {

        private final String  propertyName;
        private final long    propertyNameHash;
        private final Long[]  values;
        private final boolean not;

<span class="fc" id="L1616">        public IntObjInSegement(String propertyName, Long[] values, boolean not){</span>
<span class="fc" id="L1617">            this.propertyName = propertyName;</span>
<span class="fc" id="L1618">            this.propertyNameHash = TypeUtils.fnv1a_64(propertyName);</span>
<span class="fc" id="L1619">            this.values = values;</span>
<span class="fc" id="L1620">            this.not = not;</span>
<span class="fc" id="L1621">        }</span>

        public boolean apply(JSONPath path, Object rootObject, Object currentObject, Object item) {
<span class="fc" id="L1624">            Object propertyValue = path.getPropertyValue(item, propertyName, propertyNameHash);</span>

<span class="fc bfc" id="L1626" title="All 2 branches covered.">            if (propertyValue == null) {</span>
<span class="pc bpc" id="L1627" title="1 of 2 branches missed.">                for (Long value : values) {</span>
<span class="fc bfc" id="L1628" title="All 2 branches covered.">                    if (value == null) {</span>
<span class="pc bpc" id="L1629" title="1 of 2 branches missed.">                        return !not;</span>
                    }
                }

<span class="nc" id="L1633">                return not;</span>
            }

<span class="pc bpc" id="L1636" title="1 of 2 branches missed.">            if (propertyValue instanceof Number) {</span>
<span class="fc" id="L1637">                long longPropertyValue = ((Number) propertyValue).longValue();</span>
<span class="fc bfc" id="L1638" title="All 2 branches covered.">                for (Long value : values) {</span>
<span class="fc bfc" id="L1639" title="All 2 branches covered.">                    if (value == null) {</span>
<span class="fc" id="L1640">                        continue;</span>
                    }

<span class="fc bfc" id="L1643" title="All 2 branches covered.">                    if (value.longValue() == longPropertyValue) {</span>
<span class="pc bpc" id="L1644" title="1 of 2 branches missed.">                        return !not;</span>
                    }
                }
            }

<span class="fc" id="L1649">            return not;</span>
        }
    }

    static class StringInSegement implements Filter {

        private final String   propertyName;
        private final long     propertyNameHash;
        private final String[] values;
        private final boolean  not;

<span class="fc" id="L1660">        public StringInSegement(String propertyName, String[] values, boolean not){</span>
<span class="fc" id="L1661">            this.propertyName = propertyName;</span>
<span class="fc" id="L1662">            this.propertyNameHash = TypeUtils.fnv1a_64(propertyName);</span>
<span class="fc" id="L1663">            this.values = values;</span>
<span class="fc" id="L1664">            this.not = not;</span>
<span class="fc" id="L1665">        }</span>

        public boolean apply(JSONPath path, Object rootObject, Object currentObject, Object item) {
<span class="fc" id="L1668">            Object propertyValue = path.getPropertyValue(item, propertyName, propertyNameHash);</span>

<span class="fc bfc" id="L1670" title="All 2 branches covered.">            for (String value : values) {</span>
<span class="fc bfc" id="L1671" title="All 2 branches covered.">                if (value == propertyValue) {</span>
<span class="pc bpc" id="L1672" title="1 of 2 branches missed.">                    return !not;</span>
<span class="fc bfc" id="L1673" title="All 4 branches covered.">                } else if (value != null &amp;&amp; value.equals(propertyValue)) {</span>
<span class="pc bpc" id="L1674" title="1 of 2 branches missed.">                    return !not;</span>
                }
            }

<span class="fc" id="L1678">            return not;</span>
        }
    }

    static class IntOpSegement implements Filter {

        private final String   propertyName;
        private final long     propertyNameHash;
        private final long     value;
        private final Operator op;

<span class="fc" id="L1689">        public IntOpSegement(String propertyName, long value, Operator op){</span>
<span class="fc" id="L1690">            this.propertyName = propertyName;</span>
<span class="fc" id="L1691">            this.propertyNameHash = TypeUtils.fnv1a_64(propertyName);</span>
<span class="fc" id="L1692">            this.value = value;</span>
<span class="fc" id="L1693">            this.op = op;</span>
<span class="fc" id="L1694">        }</span>

        public boolean apply(JSONPath path, Object rootObject, Object currentObject, Object item) {
<span class="fc" id="L1697">            Object propertyValue = path.getPropertyValue(item, propertyName, propertyNameHash);</span>

<span class="fc bfc" id="L1699" title="All 2 branches covered.">            if (propertyValue == null) {</span>
<span class="fc" id="L1700">                return false;</span>
            }

<span class="pc bpc" id="L1703" title="1 of 2 branches missed.">            if (!(propertyValue instanceof Number)) {</span>
<span class="nc" id="L1704">                return false;</span>
            }

<span class="fc" id="L1707">            long longValue = ((Number) propertyValue).longValue();</span>

<span class="fc bfc" id="L1709" title="All 2 branches covered.">            if (op == Operator.EQ) {</span>
<span class="fc bfc" id="L1710" title="All 2 branches covered.">                return longValue == value;</span>
<span class="fc bfc" id="L1711" title="All 2 branches covered.">            } else if (op == Operator.NE) {</span>
<span class="fc bfc" id="L1712" title="All 2 branches covered.">                return longValue != value;</span>
<span class="fc bfc" id="L1713" title="All 2 branches covered.">            } else if (op == Operator.GE) {</span>
<span class="fc bfc" id="L1714" title="All 2 branches covered.">                return longValue &gt;= value;</span>
<span class="fc bfc" id="L1715" title="All 2 branches covered.">            } else if (op == Operator.GT) {</span>
<span class="fc bfc" id="L1716" title="All 2 branches covered.">                return longValue &gt; value;</span>
<span class="fc bfc" id="L1717" title="All 2 branches covered.">            } else if (op == Operator.LE) {</span>
<span class="fc bfc" id="L1718" title="All 2 branches covered.">                return longValue &lt;= value;</span>
<span class="pc bpc" id="L1719" title="1 of 2 branches missed.">            } else if (op == Operator.LT) {</span>
<span class="fc bfc" id="L1720" title="All 2 branches covered.">                return longValue &lt; value;</span>
            }

<span class="nc" id="L1723">            return false;</span>
        }
    }
    
    static class DoubleOpSegement implements Filter {

        private final String   propertyName;
        private final double   value;
        private final Operator op;

        private final long     propertyNameHash;

<span class="fc" id="L1735">        public DoubleOpSegement(String propertyName, double value, Operator op){</span>
<span class="fc" id="L1736">            this.propertyName = propertyName;</span>
<span class="fc" id="L1737">            this.value = value;</span>
<span class="fc" id="L1738">            this.op = op;</span>
<span class="fc" id="L1739">            propertyNameHash = TypeUtils.fnv1a_64(propertyName);</span>
<span class="fc" id="L1740">        }</span>

        public boolean apply(JSONPath path, Object rootObject, Object currentObject, Object item) {
<span class="fc" id="L1743">            Object propertyValue = path.getPropertyValue(item, propertyName, propertyNameHash);</span>

<span class="pc bpc" id="L1745" title="1 of 2 branches missed.">            if (propertyValue == null) {</span>
<span class="nc" id="L1746">                return false;</span>
            }

<span class="pc bpc" id="L1749" title="1 of 2 branches missed.">            if (!(propertyValue instanceof Number)) {</span>
<span class="nc" id="L1750">                return false;</span>
            }

<span class="fc" id="L1753">            double doubleValue = ((Number) propertyValue).doubleValue();</span>

<span class="pc bpc" id="L1755" title="1 of 2 branches missed.">            if (op == Operator.EQ) {</span>
<span class="fc bfc" id="L1756" title="All 2 branches covered.">                return doubleValue == value;</span>
<span class="nc bnc" id="L1757" title="All 2 branches missed.">            } else if (op == Operator.NE) {</span>
<span class="nc bnc" id="L1758" title="All 2 branches missed.">                return doubleValue != value;</span>
<span class="nc bnc" id="L1759" title="All 2 branches missed.">            } else if (op == Operator.GE) {</span>
<span class="nc bnc" id="L1760" title="All 2 branches missed.">                return doubleValue &gt;= value;</span>
<span class="nc bnc" id="L1761" title="All 2 branches missed.">            } else if (op == Operator.GT) {</span>
<span class="nc bnc" id="L1762" title="All 2 branches missed.">                return doubleValue &gt; value;</span>
<span class="nc bnc" id="L1763" title="All 2 branches missed.">            } else if (op == Operator.LE) {</span>
<span class="nc bnc" id="L1764" title="All 2 branches missed.">                return doubleValue &lt;= value;</span>
<span class="nc bnc" id="L1765" title="All 2 branches missed.">            } else if (op == Operator.LT) {</span>
<span class="nc bnc" id="L1766" title="All 2 branches missed.">                return doubleValue &lt; value;</span>
            }

<span class="nc" id="L1769">            return false;</span>
        }
    }

    static class MatchSegement implements Filter {

        private final String   propertyName;
        private final long     propertyNameHash;
        private final String   startsWithValue;
        private final String   endsWithValue;
        private final String[] containsValues;
        private final int      minLength;
        private final boolean  not;

        public MatchSegement(String propertyName, String startsWithValue, String endsWithValue, String[] containsValues,
<span class="fc" id="L1784">                             boolean not){</span>
<span class="fc" id="L1785">            this.propertyName = propertyName;</span>
<span class="fc" id="L1786">            this.propertyNameHash = TypeUtils.fnv1a_64(propertyName);</span>
<span class="fc" id="L1787">            this.startsWithValue = startsWithValue;</span>
<span class="fc" id="L1788">            this.endsWithValue = endsWithValue;</span>
<span class="fc" id="L1789">            this.containsValues = containsValues;</span>
<span class="fc" id="L1790">            this.not = not;</span>

<span class="fc" id="L1792">            int len = 0;</span>
<span class="fc bfc" id="L1793" title="All 2 branches covered.">            if (startsWithValue != null) {</span>
<span class="fc" id="L1794">                len += startsWithValue.length();</span>
            }

<span class="fc bfc" id="L1797" title="All 2 branches covered.">            if (endsWithValue != null) {</span>
<span class="fc" id="L1798">                len += endsWithValue.length();</span>
            }

<span class="fc bfc" id="L1801" title="All 2 branches covered.">            if (containsValues != null) {</span>
<span class="fc bfc" id="L1802" title="All 2 branches covered.">                for (String item : containsValues) {</span>
<span class="fc" id="L1803">                    len += item.length();</span>
                }
            }

<span class="fc" id="L1807">            this.minLength = len;</span>
<span class="fc" id="L1808">        }</span>

        public boolean apply(JSONPath path, Object rootObject, Object currentObject, Object item) {
<span class="fc" id="L1811">            Object propertyValue = path.getPropertyValue(item, propertyName, propertyNameHash);</span>

<span class="fc bfc" id="L1813" title="All 2 branches covered.">            if (propertyValue == null) {</span>
<span class="fc" id="L1814">                return false;</span>
            }

<span class="fc" id="L1817">            final String strPropertyValue = propertyValue.toString();</span>

<span class="fc bfc" id="L1819" title="All 2 branches covered.">            if (strPropertyValue.length() &lt; minLength) {</span>
<span class="fc" id="L1820">                return not;</span>
            }

<span class="fc" id="L1823">            int start = 0;</span>
<span class="fc bfc" id="L1824" title="All 2 branches covered.">            if (startsWithValue != null) {</span>
<span class="fc bfc" id="L1825" title="All 2 branches covered.">                if (!strPropertyValue.startsWith(startsWithValue)) {</span>
<span class="fc" id="L1826">                    return not;</span>
                }
<span class="fc" id="L1828">                start += startsWithValue.length();</span>
            }

<span class="fc bfc" id="L1831" title="All 2 branches covered.">            if (containsValues != null) {</span>
<span class="fc bfc" id="L1832" title="All 2 branches covered.">                for (String containsValue : containsValues) {</span>
<span class="fc" id="L1833">                    int index = strPropertyValue.indexOf(containsValue, start);</span>
<span class="fc bfc" id="L1834" title="All 2 branches covered.">                    if (index == -1) {</span>
<span class="fc" id="L1835">                        return not;</span>
                    }
<span class="fc" id="L1837">                    start = index + containsValue.length();</span>
                }
            }

<span class="fc bfc" id="L1841" title="All 2 branches covered.">            if (endsWithValue != null) {</span>
<span class="fc bfc" id="L1842" title="All 2 branches covered.">                if (!strPropertyValue.endsWith(endsWithValue)) {</span>
<span class="fc" id="L1843">                    return not;</span>
                }
            }

<span class="fc bfc" id="L1847" title="All 2 branches covered.">            return !not;</span>
        }
    }

    static class RlikeSegement implements Filter {

        private final String  propertyName;
        private final long   propertyNameHash;
        private final Pattern pattern;
        private final boolean not;

<span class="fc" id="L1858">        public RlikeSegement(String propertyName, String pattern, boolean not){</span>
<span class="fc" id="L1859">            this.propertyName = propertyName;</span>
<span class="fc" id="L1860">            this.propertyNameHash = TypeUtils.fnv1a_64(propertyName);</span>
<span class="fc" id="L1861">            this.pattern = Pattern.compile(pattern);</span>
<span class="fc" id="L1862">            this.not = not;</span>
<span class="fc" id="L1863">        }</span>

        public boolean apply(JSONPath path, Object rootObject, Object currentObject, Object item) {
<span class="fc" id="L1866">            Object propertyValue = path.getPropertyValue(item, propertyName, propertyNameHash);</span>

<span class="fc bfc" id="L1868" title="All 2 branches covered.">            if (propertyValue == null) {</span>
<span class="fc" id="L1869">                return false;</span>
            }

<span class="fc" id="L1872">            String strPropertyValue = propertyValue.toString();</span>
<span class="fc" id="L1873">            Matcher m = pattern.matcher(strPropertyValue);</span>
<span class="fc" id="L1874">            boolean match = m.matches();</span>

<span class="fc bfc" id="L1876" title="All 2 branches covered.">            if (not) {</span>
<span class="fc bfc" id="L1877" title="All 2 branches covered.">                match = !match;</span>
            }

<span class="fc" id="L1880">            return match;</span>
        }
    }

    static class StringOpSegement implements Filter {

        private final String   propertyName;
        private final long     propertyNameHash;
        private final String   value;
        private final Operator op;

<span class="fc" id="L1891">        public StringOpSegement(String propertyName, String value, Operator op){</span>
<span class="fc" id="L1892">            this.propertyName = propertyName;</span>
<span class="fc" id="L1893">            this.propertyNameHash = TypeUtils.fnv1a_64(propertyName);</span>
<span class="fc" id="L1894">            this.value = value;</span>
<span class="fc" id="L1895">            this.op = op;</span>
<span class="fc" id="L1896">        }</span>

        public boolean apply(JSONPath path, Object rootObject, Object currentObject, Object item) {
<span class="fc" id="L1899">            Object propertyValue = path.getPropertyValue(item, propertyName, propertyNameHash);</span>

<span class="fc bfc" id="L1901" title="All 2 branches covered.">            if (op == Operator.EQ) {</span>
<span class="fc" id="L1902">                return value.equals(propertyValue);</span>
<span class="fc bfc" id="L1903" title="All 2 branches covered.">            } else if (op == Operator.NE) {</span>
<span class="fc bfc" id="L1904" title="All 2 branches covered.">                return !value.equals(propertyValue);</span>
            }

<span class="fc bfc" id="L1907" title="All 2 branches covered.">            if (propertyValue == null) {</span>
<span class="fc" id="L1908">                return false;</span>
            }

<span class="fc" id="L1911">            int compareResult = value.compareTo(propertyValue.toString());</span>
<span class="fc bfc" id="L1912" title="All 2 branches covered.">            if (op == Operator.GE) {</span>
<span class="pc bpc" id="L1913" title="1 of 2 branches missed.">                return compareResult &lt;= 0;</span>
<span class="fc bfc" id="L1914" title="All 2 branches covered.">            } else if (op == Operator.GT) {</span>
<span class="fc bfc" id="L1915" title="All 2 branches covered.">                return compareResult &lt; 0;</span>
<span class="fc bfc" id="L1916" title="All 2 branches covered.">            } else if (op == Operator.LE) {</span>
<span class="pc bpc" id="L1917" title="1 of 2 branches missed.">                return compareResult &gt;= 0;</span>
<span class="pc bpc" id="L1918" title="1 of 2 branches missed.">            } else if (op == Operator.LT) {</span>
<span class="fc bfc" id="L1919" title="All 2 branches covered.">                return compareResult &gt; 0;</span>
            }

<span class="nc" id="L1922">            return false;</span>
        }
    }

<span class="fc" id="L1926">    enum Operator {</span>
<span class="fc" id="L1927">                   EQ, NE, GT, GE, LT, LE, LIKE, NOT_LIKE, RLIKE, NOT_RLIKE, IN, NOT_IN, BETWEEN, NOT_BETWEEN</span>
    }

    static public class FilterSegement implements Segement {

        private final Filter filter;

        public FilterSegement(Filter filter){
<span class="fc" id="L1935">            super();</span>
<span class="fc" id="L1936">            this.filter = filter;</span>
<span class="fc" id="L1937">        }</span>

        @SuppressWarnings(&quot;rawtypes&quot;)
        public Object eval(JSONPath path, Object rootObject, Object currentObject) {
<span class="pc bpc" id="L1941" title="1 of 2 branches missed.">            if (currentObject == null) {</span>
<span class="nc" id="L1942">                return null;</span>
            }

<span class="fc" id="L1945">            List&lt;Object&gt; items = new JSONArray();</span>

<span class="fc bfc" id="L1947" title="All 2 branches covered.">            if (currentObject instanceof Iterable) {</span>
<span class="fc" id="L1948">                Iterator it = ((Iterable) currentObject).iterator();</span>
<span class="fc bfc" id="L1949" title="All 2 branches covered.">                while (it.hasNext()) {</span>
<span class="fc" id="L1950">                    Object item = it.next();</span>

<span class="fc bfc" id="L1952" title="All 2 branches covered.">                    if (filter.apply(path, rootObject, currentObject, item)) {</span>
<span class="fc" id="L1953">                        items.add(item);</span>
                    }
<span class="fc" id="L1955">                }</span>

<span class="fc" id="L1957">                return items;</span>
            }

<span class="fc bfc" id="L1960" title="All 2 branches covered.">            if (filter.apply(path, rootObject, currentObject, currentObject)) {</span>
<span class="fc" id="L1961">                return currentObject;</span>
            }

<span class="fc" id="L1964">            return null;</span>
        }
    }

    interface Filter {

        boolean apply(JSONPath path, Object rootObject, Object currentObject, Object item);
    }

    @SuppressWarnings(&quot;rawtypes&quot;)
    protected Object getArrayItem(final Object currentObject, int index) {
<span class="pc bpc" id="L1975" title="1 of 2 branches missed.">        if (currentObject == null) {</span>
<span class="nc" id="L1976">            return null;</span>
        }

<span class="fc bfc" id="L1979" title="All 2 branches covered.">        if (currentObject instanceof List) {</span>
<span class="fc" id="L1980">            List list = (List) currentObject;</span>

<span class="fc bfc" id="L1982" title="All 2 branches covered.">            if (index &gt;= 0) {</span>
<span class="fc bfc" id="L1983" title="All 2 branches covered.">                if (index &lt; list.size()) {</span>
<span class="fc" id="L1984">                    return list.get(index);</span>
                }
<span class="fc" id="L1986">                return null;</span>
            } else {
<span class="fc bfc" id="L1988" title="All 2 branches covered.">                if (Math.abs(index) &lt;= list.size()) {</span>
<span class="fc" id="L1989">                    return list.get(list.size() + index);</span>
                }
<span class="fc" id="L1991">                return null;</span>
            }
        }

<span class="fc bfc" id="L1995" title="All 2 branches covered.">        if (currentObject.getClass().isArray()) {</span>
<span class="fc" id="L1996">            int arrayLenth = Array.getLength(currentObject);</span>

<span class="fc bfc" id="L1998" title="All 2 branches covered.">            if (index &gt;= 0) {</span>
<span class="fc bfc" id="L1999" title="All 2 branches covered.">                if (index &lt; arrayLenth) {</span>
<span class="fc" id="L2000">                    return Array.get(currentObject, index);</span>
                }
<span class="fc" id="L2002">                return null;</span>
            } else {
<span class="fc bfc" id="L2004" title="All 2 branches covered.">                if (Math.abs(index) &lt;= arrayLenth) {</span>
<span class="fc" id="L2005">                    return Array.get(currentObject, arrayLenth + index);</span>
                }
<span class="fc" id="L2007">                return null;</span>
            }
        }

<span class="fc bfc" id="L2011" title="All 2 branches covered.">        if (currentObject instanceof Map) {</span>
<span class="fc" id="L2012">            Map map = (Map) currentObject;</span>
<span class="fc" id="L2013">            Object value = map.get(index);</span>
<span class="pc bpc" id="L2014" title="1 of 2 branches missed.">            if (value == null) {</span>
<span class="nc" id="L2015">                value = map.get(Integer.toString(index));</span>
            }
<span class="fc" id="L2017">            return value;</span>
        }

<span class="pc bpc" id="L2020" title="1 of 2 branches missed.">        if (currentObject instanceof Collection) {</span>
<span class="fc" id="L2021">            Collection collection = (Collection) currentObject;</span>
<span class="fc" id="L2022">            int i = 0;</span>
<span class="pc bpc" id="L2023" title="1 of 2 branches missed.">            for (Object item : collection) {</span>
<span class="fc bfc" id="L2024" title="All 2 branches covered.">                if (i == index) {</span>
<span class="fc" id="L2025">                    return item;</span>
                }
<span class="fc" id="L2027">                i++;</span>
<span class="fc" id="L2028">            }</span>
<span class="nc" id="L2029">            return null;</span>
        }

<span class="nc" id="L2032">        throw new UnsupportedOperationException();</span>
    }

    @SuppressWarnings({ &quot;unchecked&quot;, &quot;rawtypes&quot; })
    public boolean setArrayItem(JSONPath path, Object currentObject, int index, Object value) {
<span class="fc bfc" id="L2037" title="All 2 branches covered.">        if (currentObject instanceof List) {</span>
<span class="fc" id="L2038">            List list = (List) currentObject;</span>
<span class="pc bpc" id="L2039" title="1 of 2 branches missed.">            if (index &gt;= 0) {</span>
<span class="fc" id="L2040">                list.set(index, value);</span>
            } else {
<span class="nc" id="L2042">                list.set(list.size() + index, value);</span>
            }
<span class="fc" id="L2044">            return true;</span>
        }

<span class="fc" id="L2047">        Class&lt;?&gt; clazz = currentObject.getClass();</span>
<span class="pc bpc" id="L2048" title="1 of 2 branches missed.">        if (clazz.isArray()) {</span>
<span class="fc" id="L2049">            int arrayLenth = Array.getLength(currentObject);</span>

<span class="pc bpc" id="L2051" title="1 of 2 branches missed.">            if (index &gt;= 0) {</span>
<span class="pc bpc" id="L2052" title="1 of 2 branches missed.">                if (index &lt; arrayLenth) {</span>
<span class="fc" id="L2053">                    Array.set(currentObject, index, value);</span>
                }
            } else {
<span class="nc bnc" id="L2056" title="All 2 branches missed.">                if (Math.abs(index) &lt;= arrayLenth) {</span>
<span class="nc" id="L2057">                    Array.set(currentObject, arrayLenth + index, value);</span>
                }
            }

<span class="fc" id="L2061">            return true;</span>
        }

<span class="nc" id="L2064">        throw new JSONPathException(&quot;unsupported set operation.&quot; + clazz);</span>
    }

    @SuppressWarnings(&quot;rawtypes&quot;)
    public boolean removeArrayItem(JSONPath path, Object currentObject, int index) {
<span class="pc bpc" id="L2069" title="1 of 2 branches missed.">        if (currentObject instanceof List) {</span>
<span class="fc" id="L2070">            List list = (List) currentObject;</span>
<span class="pc bpc" id="L2071" title="1 of 2 branches missed.">            if (index &gt;= 0) {</span>
<span class="fc bfc" id="L2072" title="All 2 branches covered.">                if (index &gt;= list.size()) {</span>
<span class="fc" id="L2073">                    return false;</span>
                }
<span class="fc" id="L2075">                list.remove(index);</span>
            } else {
<span class="nc" id="L2077">                int newIndex = list.size() + index;</span>
                
<span class="nc bnc" id="L2079" title="All 2 branches missed.">                if (newIndex &lt; 0) {</span>
<span class="nc" id="L2080">                    return false;</span>
                }
                
<span class="nc" id="L2083">                list.remove(newIndex);</span>
            }
<span class="fc" id="L2085">            return true;</span>
        }

<span class="nc" id="L2088">        Class&lt;?&gt; clazz = currentObject.getClass();</span>
<span class="nc" id="L2089">        throw new JSONPathException(&quot;unsupported set operation.&quot; + clazz);</span>
    }

    @SuppressWarnings({ &quot;rawtypes&quot;, &quot;unchecked&quot; })
    protected Collection&lt;Object&gt; getPropertyValues(final Object currentObject) {
<span class="fc" id="L2094">        final Class&lt;?&gt; currentClass = currentObject.getClass();</span>

<span class="fc" id="L2096">        JavaBeanSerializer beanSerializer = getJavaBeanSerializer(currentClass);</span>

<span class="fc bfc" id="L2098" title="All 2 branches covered.">        if (beanSerializer != null) {</span>
            try {
<span class="fc" id="L2100">                return beanSerializer.getFieldValues(currentObject);</span>
<span class="nc" id="L2101">            } catch (Exception e) {</span>
<span class="nc" id="L2102">                throw new JSONPathException(&quot;jsonpath error, path &quot; + path, e);</span>
            }
        }

<span class="pc bpc" id="L2106" title="1 of 2 branches missed.">        if (currentObject instanceof Map) {</span>
<span class="fc" id="L2107">            Map map = (Map) currentObject;</span>
<span class="fc" id="L2108">            return map.values();</span>
        }

<span class="nc" id="L2111">        throw new UnsupportedOperationException();</span>
    }

    static boolean eq(Object a, Object b) {
<span class="fc bfc" id="L2115" title="All 2 branches covered.">        if (a == b) {</span>
<span class="fc" id="L2116">            return true;</span>
        }

<span class="pc bpc" id="L2119" title="2 of 4 branches missed.">        if (a == null || b == null) {</span>
<span class="nc" id="L2120">            return false;</span>
        }

<span class="fc bfc" id="L2123" title="All 2 branches covered.">        if (a.getClass() == b.getClass()) {</span>
<span class="fc" id="L2124">            return a.equals(b);</span>
        }

<span class="pc bpc" id="L2127" title="1 of 2 branches missed.">        if (a instanceof Number) {</span>
<span class="pc bpc" id="L2128" title="1 of 2 branches missed.">            if (b instanceof Number) {</span>
<span class="fc" id="L2129">                return eqNotNull((Number) a, (Number) b);</span>
            }

<span class="nc" id="L2132">            return false;</span>
        }

<span class="nc" id="L2135">        return a.equals(b);</span>
    }

    @SuppressWarnings(&quot;rawtypes&quot;)
    static boolean eqNotNull(Number a, Number b) {
<span class="fc" id="L2140">        Class clazzA = a.getClass();</span>
<span class="fc" id="L2141">        boolean isIntA = isInt(clazzA);</span>

<span class="fc" id="L2143">        Class clazzB = b.getClass();</span>
<span class="fc" id="L2144">        boolean isIntB = isInt(clazzB);</span>
        
<span class="fc bfc" id="L2146" title="All 2 branches covered.">        if (a instanceof BigDecimal) {</span>
<span class="fc" id="L2147">            BigDecimal decimalA = (BigDecimal) a;</span>
            
<span class="pc bpc" id="L2149" title="1 of 2 branches missed.">            if (isIntB) {</span>
<span class="fc" id="L2150">                return decimalA.equals(BigDecimal.valueOf(b.longValue()));</span>
            }
        }

<span class="fc bfc" id="L2154" title="All 2 branches covered.">        if (isIntA) {</span>
<span class="fc bfc" id="L2155" title="All 2 branches covered.">            if (isIntB) {</span>
<span class="fc bfc" id="L2156" title="All 2 branches covered.">                return a.longValue() == b.longValue();</span>
            }
            
<span class="pc bpc" id="L2159" title="1 of 2 branches missed.">            if (b instanceof BigInteger) {</span>
<span class="nc" id="L2160">                BigInteger bigIntB = (BigInteger) a;</span>
<span class="nc" id="L2161">                BigInteger bigIntA = BigInteger.valueOf(a.longValue());</span>
                
<span class="nc" id="L2163">                return bigIntA.equals(bigIntB);</span>
            }
        }
        
<span class="fc bfc" id="L2167" title="All 2 branches covered.">        if (isIntB) {</span>
<span class="fc bfc" id="L2168" title="All 2 branches covered.">            if (a instanceof BigInteger) {</span>
<span class="fc" id="L2169">                BigInteger bigIntA = (BigInteger) a;</span>
<span class="fc" id="L2170">                BigInteger bigIntB = BigInteger.valueOf(b.longValue());</span>
                
<span class="fc" id="L2172">                return bigIntA.equals(bigIntB);</span>
            }
        }
        

<span class="fc" id="L2177">        boolean isDoubleA = isDouble(clazzA);</span>
<span class="fc" id="L2178">        boolean isDoubleB = isDouble(clazzB);</span>

<span class="pc bpc" id="L2180" title="3 of 12 branches missed.">        if ((isDoubleA &amp;&amp; isDoubleB) || (isDoubleA &amp;&amp; isIntB) || (isDoubleB &amp;&amp; isIntA)) {</span>
<span class="fc bfc" id="L2181" title="All 2 branches covered.">            return a.doubleValue() == b.doubleValue();</span>
        }
        

<span class="nc" id="L2185">        return false;</span>
    }

    protected static boolean isDouble(Class&lt;?&gt; clazzA) {
<span class="fc bfc" id="L2189" title="All 4 branches covered.">        return clazzA == Float.class || clazzA == Double.class;</span>
    }

    protected static boolean isInt(Class&lt;?&gt; clazzA) {
<span class="pc bpc" id="L2193" title="1 of 8 branches missed.">        return clazzA == Byte.class || clazzA == Short.class || clazzA == Integer.class || clazzA == Long.class;</span>
    }

    final static long SIZE = 0x4dea9618e618ae3cL; // TypeUtils.fnv1a_64(&quot;size&quot;);

    protected Object getPropertyValue(Object currentObject, String propertyName, long propertyNameHash) {
<span class="fc bfc" id="L2199" title="All 2 branches covered.">        if (currentObject == null) {</span>
<span class="fc" id="L2200">            return null;</span>
        }

<span class="fc bfc" id="L2203" title="All 2 branches covered.">        if (currentObject instanceof Map) {</span>
<span class="fc" id="L2204">            Map map = (Map) currentObject;</span>
<span class="fc" id="L2205">            Object val = map.get(propertyName);</span>

<span class="fc bfc" id="L2207" title="All 4 branches covered.">            if (val == null &amp;&amp; SIZE == propertyNameHash) {</span>
<span class="fc" id="L2208">                val = map.size();</span>
            }

<span class="fc" id="L2211">            return val;</span>
        }

<span class="fc" id="L2214">        final Class&lt;?&gt; currentClass = currentObject.getClass();</span>

<span class="fc" id="L2216">        JavaBeanSerializer beanSerializer = getJavaBeanSerializer(currentClass);</span>
<span class="fc bfc" id="L2217" title="All 2 branches covered.">        if (beanSerializer != null) {</span>
            try {
<span class="fc" id="L2219">                return beanSerializer.getFieldValue(currentObject, propertyName, propertyNameHash, false);</span>
<span class="nc" id="L2220">            } catch (Exception e) {</span>
<span class="nc" id="L2221">                throw new JSONPathException(&quot;jsonpath error, path &quot; + path + &quot;, segement &quot; + propertyName, e);</span>
            }
        }

<span class="fc bfc" id="L2225" title="All 2 branches covered.">        if (currentObject instanceof List) {</span>
<span class="fc" id="L2226">            List list = (List) currentObject;</span>

<span class="fc bfc" id="L2228" title="All 2 branches covered.">            if (SIZE == propertyNameHash) {</span>
<span class="fc" id="L2229">                return list.size();</span>
            }

<span class="fc" id="L2232">            List&lt;Object&gt; fieldValues = new JSONArray(list.size());</span>

<span class="fc bfc" id="L2234" title="All 2 branches covered.">            for (int i = 0; i &lt; list.size(); ++i) {</span>
<span class="fc" id="L2235">                Object obj = list.get(i);</span>
<span class="fc" id="L2236">                Object itemValue = getPropertyValue(obj, propertyName, propertyNameHash);</span>
<span class="fc bfc" id="L2237" title="All 2 branches covered.">                if (itemValue instanceof Collection) {</span>
<span class="fc" id="L2238">                    Collection collection = (Collection) itemValue;</span>
<span class="fc" id="L2239">                    fieldValues.addAll(collection);</span>
<span class="fc bfc" id="L2240" title="All 2 branches covered.">                } else if (itemValue != null) {</span>
<span class="fc" id="L2241">                    fieldValues.add(itemValue);</span>
                }
            }

<span class="fc" id="L2245">            return fieldValues;</span>
        }

<span class="fc bfc" id="L2248" title="All 2 branches covered.">        if (currentObject instanceof Enum) {</span>
<span class="fc" id="L2249">            final long NAME = 0xc4bcadba8e631b86L; // TypeUtils.fnv1a_64(&quot;name&quot;);</span>
<span class="fc" id="L2250">            final long ORDINAL = 0xf1ebc7c20322fc22L; //TypeUtils.fnv1a_64(&quot;ordinal&quot;);</span>

<span class="fc" id="L2252">            Enum e = (Enum) currentObject;</span>
<span class="fc bfc" id="L2253" title="All 2 branches covered.">            if (NAME == propertyNameHash) {</span>
<span class="fc" id="L2254">                return e.name();</span>
            }

<span class="pc bpc" id="L2257" title="1 of 2 branches missed.">            if (ORDINAL == propertyNameHash) {</span>
<span class="fc" id="L2258">                return e.ordinal();</span>
            }
        }

<span class="fc bfc" id="L2262" title="All 2 branches covered.">        if (currentObject instanceof Calendar) {</span>
<span class="fc" id="L2263">            final long YEAR = 0x7c64634977425edcL; //TypeUtils.fnv1a_64(&quot;year&quot;);</span>
<span class="fc" id="L2264">            final long MONTH = 0xf4bdc3936faf56a5L; //TypeUtils.fnv1a_64(&quot;month&quot;);</span>
<span class="fc" id="L2265">            final long DAY = 0xca8d3918f4578f1dL; // TypeUtils.fnv1a_64(&quot;day&quot;);</span>
<span class="fc" id="L2266">            final long HOUR = 0x407efecc7eb5764fL; //TypeUtils.fnv1a_64(&quot;hour&quot;);</span>
<span class="fc" id="L2267">            final long MINUTE = 0x5bb2f9bdf2fad1e9L; //TypeUtils.fnv1a_64(&quot;minute&quot;);</span>
<span class="fc" id="L2268">            final long SECOND = 0xa49985ef4cee20bdL; //TypeUtils.fnv1a_64(&quot;second&quot;);</span>

<span class="fc" id="L2270">            Calendar e = (Calendar) currentObject;</span>
<span class="fc bfc" id="L2271" title="All 2 branches covered.">            if (YEAR == propertyNameHash) {</span>
<span class="fc" id="L2272">                return e.get(Calendar.YEAR);</span>
            }
<span class="fc bfc" id="L2274" title="All 2 branches covered.">            if (MONTH == propertyNameHash) {</span>
<span class="fc" id="L2275">                return e.get(Calendar.MONTH);</span>
            }
<span class="fc bfc" id="L2277" title="All 2 branches covered.">            if (DAY == propertyNameHash) {</span>
<span class="fc" id="L2278">                return e.get(Calendar.DAY_OF_MONTH);</span>
            }
<span class="fc bfc" id="L2280" title="All 2 branches covered.">            if (HOUR == propertyNameHash) {</span>
<span class="fc" id="L2281">                return e.get(Calendar.HOUR_OF_DAY);</span>
            }
<span class="fc bfc" id="L2283" title="All 2 branches covered.">            if (MINUTE == propertyNameHash) {</span>
<span class="fc" id="L2284">                return e.get(Calendar.MINUTE);</span>
            }
<span class="pc bpc" id="L2286" title="1 of 2 branches missed.">            if (SECOND == propertyNameHash) {</span>
<span class="fc" id="L2287">                return e.get(Calendar.SECOND);</span>
            }
        }

<span class="fc" id="L2291">        return null;</span>
        //throw new JSONPathException(&quot;jsonpath error, path &quot; + path + &quot;, segement &quot; + propertyName);
    }
    
    @SuppressWarnings(&quot;rawtypes&quot;)
    protected void deepScan(final Object currentObject, final String propertyName, List&lt;Object&gt; results) {
<span class="pc bpc" id="L2297" title="1 of 2 branches missed.">        if (currentObject == null) {</span>
<span class="nc" id="L2298">            return;</span>
        }

<span class="fc bfc" id="L2301" title="All 2 branches covered.">        if (currentObject instanceof Map) {</span>
<span class="fc" id="L2302">            Map&lt;?, ?&gt; map = (Map&lt;?, ?&gt;) currentObject;</span>
            
<span class="fc bfc" id="L2304" title="All 2 branches covered.">            if (map.containsKey(propertyName)) {</span>
<span class="fc" id="L2305">                Object val = map.get(propertyName);</span>
<span class="fc" id="L2306">                results.add(val);</span>
<span class="fc" id="L2307">                return;</span>
            }
            
<span class="fc bfc" id="L2310" title="All 2 branches covered.">            for (Object val : map.values()) {</span>
<span class="fc" id="L2311">                deepScan(val, propertyName, results);</span>
<span class="fc" id="L2312">            }</span>
<span class="fc" id="L2313">            return;</span>
        }

<span class="fc" id="L2316">        final Class&lt;?&gt; currentClass = currentObject.getClass();</span>

<span class="fc" id="L2318">        JavaBeanSerializer beanSerializer = getJavaBeanSerializer(currentClass);</span>
<span class="fc bfc" id="L2319" title="All 2 branches covered.">        if (beanSerializer != null) {</span>
            try {
<span class="fc" id="L2321">                FieldSerializer fieldDeser = beanSerializer.getFieldSerializer(propertyName);</span>
<span class="fc bfc" id="L2322" title="All 2 branches covered.">                if (fieldDeser != null) {</span>
                    try {
<span class="fc" id="L2324">                        Object val = fieldDeser.getPropertyValueDirect(currentObject);</span>
<span class="fc" id="L2325">                        results.add(val);</span>
<span class="nc" id="L2326">                    } catch (InvocationTargetException ex) {</span>
<span class="nc" id="L2327">                        throw new JSONException(&quot;getFieldValue error.&quot; + propertyName, ex);</span>
<span class="nc" id="L2328">                    } catch (IllegalAccessException ex) {</span>
<span class="nc" id="L2329">                        throw new JSONException(&quot;getFieldValue error.&quot; + propertyName, ex);</span>
<span class="fc" id="L2330">                    }</span>
<span class="fc" id="L2331">                    return;</span>
                }
<span class="fc" id="L2333">                List&lt;Object&gt; fieldValues = beanSerializer.getFieldValues(currentObject);</span>
<span class="fc bfc" id="L2334" title="All 2 branches covered.">                for (Object val : fieldValues) {</span>
<span class="fc" id="L2335">                    deepScan(val, propertyName, results);</span>
<span class="fc" id="L2336">                }</span>
<span class="fc" id="L2337">                return;</span>
<span class="nc" id="L2338">            } catch (Exception e) {</span>
<span class="nc" id="L2339">                throw new JSONPathException(&quot;jsonpath error, path &quot; + path + &quot;, segement &quot; + propertyName, e);</span>
            }
        }

<span class="pc bpc" id="L2343" title="1 of 2 branches missed.">        if (currentObject instanceof List) {</span>
<span class="fc" id="L2344">            List list = (List) currentObject;</span>

<span class="fc bfc" id="L2346" title="All 2 branches covered.">            for (int i = 0; i &lt; list.size(); ++i) {</span>
<span class="fc" id="L2347">                Object val = list.get(i);</span>
<span class="fc" id="L2348">                deepScan(val, propertyName, results);</span>
            }
<span class="fc" id="L2350">            return;</span>
        }
<span class="nc" id="L2352">    }</span>

    protected void deepSet(final Object currentObject, final String propertyName, long propertyNameHash, Object value) {
<span class="pc bpc" id="L2355" title="1 of 2 branches missed.">        if (currentObject == null) {</span>
<span class="nc" id="L2356">            return;</span>
        }

<span class="fc bfc" id="L2359" title="All 2 branches covered.">        if (currentObject instanceof Map) {</span>
<span class="fc" id="L2360">            Map map = (Map) currentObject;</span>

<span class="fc bfc" id="L2362" title="All 2 branches covered.">            if (map.containsKey(propertyName)) {</span>
<span class="fc" id="L2363">                Object val = map.get(propertyName);</span>
<span class="fc" id="L2364">                map.put(propertyName, value);</span>
<span class="fc" id="L2365">                return;</span>
            }

<span class="fc bfc" id="L2368" title="All 2 branches covered.">            for (Object val : map.values()) {</span>
<span class="fc" id="L2369">                deepSet(val, propertyName, propertyNameHash, value);</span>
<span class="fc" id="L2370">            }</span>
<span class="fc" id="L2371">            return;</span>
        }

<span class="fc" id="L2374">        final Class&lt;?&gt; currentClass = currentObject.getClass();</span>

<span class="fc" id="L2376">        JavaBeanDeserializer beanDeserializer = getJavaBeanDeserializer(currentClass);</span>
<span class="fc bfc" id="L2377" title="All 2 branches covered.">        if (beanDeserializer != null) {</span>
            try {
<span class="fc" id="L2379">                FieldDeserializer fieldDeser = beanDeserializer.getFieldDeserializer(propertyName);</span>
<span class="fc bfc" id="L2380" title="All 2 branches covered.">                if (fieldDeser != null) {</span>
<span class="fc" id="L2381">                    fieldDeser.setValue(currentObject, value);</span>
<span class="fc" id="L2382">                    return;</span>
                }

<span class="fc" id="L2385">                JavaBeanSerializer beanSerializer = getJavaBeanSerializer(currentClass);</span>
<span class="fc" id="L2386">                List&lt;Object&gt; fieldValues = beanSerializer.getObjectFieldValues(currentObject);</span>
<span class="fc bfc" id="L2387" title="All 2 branches covered.">                for (Object val : fieldValues) {</span>
<span class="fc" id="L2388">                    deepSet(val, propertyName, propertyNameHash, value);</span>
<span class="fc" id="L2389">                }</span>
<span class="fc" id="L2390">                return;</span>
<span class="nc" id="L2391">            } catch (Exception e) {</span>
<span class="nc" id="L2392">                throw new JSONPathException(&quot;jsonpath error, path &quot; + path + &quot;, segement &quot; + propertyName, e);</span>
            }
        }

<span class="pc bpc" id="L2396" title="1 of 2 branches missed.">        if (currentObject instanceof List) {</span>
<span class="fc" id="L2397">            List list = (List) currentObject;</span>

<span class="fc bfc" id="L2399" title="All 2 branches covered.">            for (int i = 0; i &lt; list.size(); ++i) {</span>
<span class="fc" id="L2400">                Object val = list.get(i);</span>
<span class="fc" id="L2401">                deepSet(val, propertyName, propertyNameHash, value);</span>
            }
<span class="fc" id="L2403">            return;</span>
        }
<span class="nc" id="L2405">    }</span>

    @SuppressWarnings({ &quot;unchecked&quot;, &quot;rawtypes&quot; })
    protected boolean setPropertyValue(Object parent, String name, long propertyNameHash, Object value) {
<span class="fc bfc" id="L2409" title="All 2 branches covered.">        if (parent instanceof Map) {</span>
<span class="fc" id="L2410">            ((Map) parent).put(name, value);</span>
<span class="fc" id="L2411">            return true;</span>
        }

<span class="fc bfc" id="L2414" title="All 2 branches covered.">        if (parent instanceof List) {</span>
<span class="fc bfc" id="L2415" title="All 2 branches covered.">            for (Object element : (List) parent) {</span>
<span class="pc bpc" id="L2416" title="1 of 2 branches missed.">                if (element == null) {</span>
<span class="nc" id="L2417">                    continue;</span>
                }
<span class="fc" id="L2419">                setPropertyValue(element, name, propertyNameHash, value);</span>
<span class="fc" id="L2420">            }</span>
<span class="fc" id="L2421">            return true;</span>
        }

<span class="fc" id="L2424">        ObjectDeserializer derializer = parserConfig.getDeserializer(parent.getClass());</span>

<span class="fc" id="L2426">        JavaBeanDeserializer beanDerializer = null;</span>
<span class="pc bpc" id="L2427" title="1 of 2 branches missed.">        if (derializer instanceof JavaBeanDeserializer) {</span>
<span class="fc" id="L2428">            beanDerializer = (JavaBeanDeserializer) derializer;</span>
        }

<span class="pc bpc" id="L2431" title="1 of 2 branches missed.">        if (beanDerializer != null) {</span>
<span class="fc" id="L2432">            FieldDeserializer fieldDeserializer = beanDerializer.getFieldDeserializer(propertyNameHash);</span>
<span class="pc bpc" id="L2433" title="1 of 2 branches missed.">            if (fieldDeserializer == null) {</span>
<span class="nc" id="L2434">                return false;</span>
            }

<span class="fc" id="L2437">            fieldDeserializer.setValue(parent, value);</span>
<span class="fc" id="L2438">            return true;</span>
        }

<span class="nc" id="L2441">        throw new UnsupportedOperationException();</span>
    }
    
    @SuppressWarnings({&quot;rawtypes&quot; })
    protected boolean removePropertyValue(Object parent, String name) {
<span class="pc bpc" id="L2446" title="1 of 2 branches missed.">        if (parent instanceof Map) {</span>
<span class="fc" id="L2447">            Object origin = ((Map) parent).remove(name);</span>
<span class="fc bfc" id="L2448" title="All 2 branches covered.">            return origin != null;</span>
        }

<span class="nc" id="L2451">        ObjectDeserializer derializer = parserConfig.getDeserializer(parent.getClass());</span>

<span class="nc" id="L2453">        JavaBeanDeserializer beanDerializer = null;</span>
<span class="nc bnc" id="L2454" title="All 2 branches missed.">        if (derializer instanceof JavaBeanDeserializer) {</span>
<span class="nc" id="L2455">            beanDerializer = (JavaBeanDeserializer) derializer;</span>
        }

<span class="nc bnc" id="L2458" title="All 2 branches missed.">        if (beanDerializer != null) {</span>
<span class="nc" id="L2459">            FieldDeserializer fieldDeserializer = beanDerializer.getFieldDeserializer(name);</span>
<span class="nc bnc" id="L2460" title="All 2 branches missed.">            if (fieldDeserializer == null) {</span>
<span class="nc" id="L2461">                return false;</span>
            }

<span class="nc" id="L2464">            fieldDeserializer.setValue(parent, null);</span>
<span class="nc" id="L2465">            return true;</span>
        }

<span class="nc" id="L2468">        throw new UnsupportedOperationException();</span>
    }

    protected JavaBeanSerializer getJavaBeanSerializer(final Class&lt;?&gt; currentClass) {
<span class="fc" id="L2472">        JavaBeanSerializer beanSerializer = null;</span>
        {
<span class="fc" id="L2474">            ObjectSerializer serializer = serializeConfig.getObjectWriter(currentClass);</span>
<span class="fc bfc" id="L2475" title="All 2 branches covered.">            if (serializer instanceof JavaBeanSerializer) {</span>
<span class="fc" id="L2476">                beanSerializer = (JavaBeanSerializer) serializer;</span>
            }
        }
<span class="fc" id="L2479">        return beanSerializer;</span>
    }

    protected JavaBeanDeserializer getJavaBeanDeserializer(final Class&lt;?&gt; currentClass) {
<span class="fc" id="L2483">        JavaBeanDeserializer beanDeserializer = null;</span>
        {
<span class="fc" id="L2485">            ObjectDeserializer deserializer = parserConfig.getDeserializer(currentClass);</span>
<span class="fc bfc" id="L2486" title="All 2 branches covered.">            if (deserializer instanceof JavaBeanDeserializer) {</span>
<span class="fc" id="L2487">                beanDeserializer = (JavaBeanDeserializer) deserializer;</span>
            }
        }
<span class="fc" id="L2490">        return beanDeserializer;</span>
    }

    @SuppressWarnings(&quot;rawtypes&quot;)
    int evalSize(Object currentObject) {
<span class="fc bfc" id="L2495" title="All 2 branches covered.">        if (currentObject == null) {</span>
<span class="fc" id="L2496">            return -1;</span>
        }

<span class="fc bfc" id="L2499" title="All 2 branches covered.">        if (currentObject instanceof Collection) {</span>
<span class="fc" id="L2500">            return ((Collection) currentObject).size();</span>
        }

<span class="fc bfc" id="L2503" title="All 2 branches covered.">        if (currentObject instanceof Object[]) {</span>
<span class="fc" id="L2504">            return ((Object[]) currentObject).length;</span>
        }

<span class="fc bfc" id="L2507" title="All 2 branches covered.">        if (currentObject.getClass().isArray()) {</span>
<span class="fc" id="L2508">            return Array.getLength(currentObject);</span>
        }

<span class="fc bfc" id="L2511" title="All 2 branches covered.">        if (currentObject instanceof Map) {</span>
<span class="fc" id="L2512">            int count = 0;</span>

<span class="fc bfc" id="L2514" title="All 2 branches covered.">            for (Object value : ((Map) currentObject).values()) {</span>
<span class="fc bfc" id="L2515" title="All 2 branches covered.">                if (value != null) {</span>
<span class="fc" id="L2516">                    count++;</span>
                }
<span class="fc" id="L2518">            }</span>
<span class="fc" id="L2519">            return count;</span>
        }

<span class="fc" id="L2522">        JavaBeanSerializer beanSerializer = getJavaBeanSerializer(currentObject.getClass());</span>

<span class="pc bpc" id="L2524" title="1 of 2 branches missed.">        if (beanSerializer == null) {</span>
<span class="nc" id="L2525">            return -1;</span>
        }

        try {
<span class="fc" id="L2529">            return beanSerializer.getSize(currentObject);</span>
<span class="fc" id="L2530">        } catch (Exception e) {</span>
<span class="fc" id="L2531">            throw new JSONPathException(&quot;evalSize error : &quot; + path, e);</span>
        }
    }

    public String toJSONString() {
<span class="fc" id="L2536">        return JSON.toJSONString(path);</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.5.201910111838</span></div></body></html>