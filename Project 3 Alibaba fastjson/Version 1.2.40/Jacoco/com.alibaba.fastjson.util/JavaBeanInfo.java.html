<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>JavaBeanInfo.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">fastjson</a> &gt; <a href="index.source.html" class="el_package">com.alibaba.fastjson.util</a> &gt; <span class="el_source">JavaBeanInfo.java</span></div><h1>JavaBeanInfo.java</h1><pre class="source lang-java linenums">package com.alibaba.fastjson.util;

import java.lang.annotation.Annotation;
import java.lang.reflect.Constructor;
import java.lang.reflect.Field;
import java.lang.reflect.Method;
import java.lang.reflect.Modifier;
import java.lang.reflect.Type;
import java.util.*;
import java.util.concurrent.atomic.AtomicBoolean;
import java.util.concurrent.atomic.AtomicInteger;
import java.util.concurrent.atomic.AtomicLong;

import com.alibaba.fastjson.JSONException;
import com.alibaba.fastjson.PropertyNamingStrategy;
import com.alibaba.fastjson.annotation.JSONCreator;
import com.alibaba.fastjson.annotation.JSONField;
import com.alibaba.fastjson.annotation.JSONPOJOBuilder;
import com.alibaba.fastjson.annotation.JSONType;
import com.alibaba.fastjson.parser.Feature;
import com.alibaba.fastjson.serializer.SerializerFeature;

public class JavaBeanInfo {

    public final Class&lt;?&gt; clazz;
    public final Class&lt;?&gt; builderClass;
    public final Constructor&lt;?&gt; defaultConstructor;
    public final Constructor&lt;?&gt; creatorConstructor;
    public final Method factoryMethod;
    public final Method buildMethod;

    public final int defaultConstructorParameterSize;

    public final FieldInfo[] fields;
    public final FieldInfo[] sortedFields;

    public final int parserFeatures;

    public final JSONType jsonType;

    public final String typeName;
    public final String typeKey;

    public String[] orders;

    public Type[] creatorConstructorParameterTypes;
    public String[] creatorConstructorParameters;

    public JavaBeanInfo(Class&lt;?&gt; clazz, //
                        Class&lt;?&gt; builderClass, //
                        Constructor&lt;?&gt; defaultConstructor, //
                        Constructor&lt;?&gt; creatorConstructor, //
                        Method factoryMethod, //
                        Method buildMethod, //
                        JSONType jsonType, //
<span class="fc" id="L56">                        List&lt;FieldInfo&gt; fieldList) {</span>
<span class="fc" id="L57">        this.clazz = clazz;</span>
<span class="fc" id="L58">        this.builderClass = builderClass;</span>
<span class="fc" id="L59">        this.defaultConstructor = defaultConstructor;</span>
<span class="fc" id="L60">        this.creatorConstructor = creatorConstructor;</span>
<span class="fc" id="L61">        this.factoryMethod = factoryMethod;</span>
<span class="fc" id="L62">        this.parserFeatures = TypeUtils.getParserFeatures(clazz);</span>
<span class="fc" id="L63">        this.buildMethod = buildMethod;</span>

<span class="fc" id="L65">        this.jsonType = jsonType;</span>
<span class="fc bfc" id="L66" title="All 2 branches covered.">        if (jsonType != null) {</span>
<span class="fc" id="L67">            String typeName = jsonType.typeName();</span>
<span class="fc" id="L68">            String typeKey = jsonType.typeKey();</span>
<span class="fc bfc" id="L69" title="All 2 branches covered.">            this.typeKey = typeKey.length() &gt; 0 ? typeKey : null;</span>

<span class="fc bfc" id="L71" title="All 2 branches covered.">            if (typeName.length() != 0) {</span>
<span class="fc" id="L72">                this.typeName = typeName;</span>
            } else {
<span class="fc" id="L74">                this.typeName = clazz.getName();</span>
            }
<span class="fc" id="L76">            String[] orders = jsonType.orders();</span>
<span class="fc bfc" id="L77" title="All 2 branches covered.">            this.orders = orders.length == 0 ? null : orders;</span>
<span class="fc" id="L78">        } else {</span>
<span class="fc" id="L79">            this.typeName = clazz.getName();</span>
<span class="fc" id="L80">            this.typeKey = null;</span>
<span class="fc" id="L81">            this.orders = null;</span>
        }

<span class="fc" id="L84">        fields = new FieldInfo[fieldList.size()];</span>
<span class="fc" id="L85">        fieldList.toArray(fields);</span>

<span class="fc" id="L87">        FieldInfo[] sortedFields = new FieldInfo[fields.length];</span>
<span class="fc bfc" id="L88" title="All 2 branches covered.">        if (orders != null) {</span>
<span class="fc" id="L89">            LinkedHashMap&lt;String, FieldInfo&gt; map = new LinkedHashMap&lt;String, FieldInfo&gt;(fieldList.size());</span>
<span class="fc bfc" id="L90" title="All 2 branches covered.">            for (FieldInfo field : fields) {</span>
<span class="fc" id="L91">                map.put(field.name, field);</span>
            }
<span class="fc" id="L93">            int i = 0;</span>
<span class="fc bfc" id="L94" title="All 2 branches covered.">            for (String item : orders) {</span>
<span class="fc" id="L95">                FieldInfo field = map.get(item);</span>
<span class="fc bfc" id="L96" title="All 2 branches covered.">                if (field != null) {</span>
<span class="fc" id="L97">                    sortedFields[i++] = field;</span>
<span class="fc" id="L98">                    map.remove(item);</span>
                }
            }
<span class="fc bfc" id="L101" title="All 2 branches covered.">            for (FieldInfo field : map.values()) {</span>
<span class="fc" id="L102">                sortedFields[i++] = field;</span>
<span class="fc" id="L103">            }</span>
<span class="fc" id="L104">        } else {</span>
<span class="fc" id="L105">            System.arraycopy(fields, 0, sortedFields, 0, fields.length);</span>
<span class="fc" id="L106">            Arrays.sort(sortedFields);</span>
        }

<span class="fc bfc" id="L109" title="All 2 branches covered.">        if (Arrays.equals(fields, sortedFields)) {</span>
<span class="fc" id="L110">            sortedFields = fields;</span>
        }
<span class="fc" id="L112">        this.sortedFields = sortedFields;</span>

<span class="fc bfc" id="L114" title="All 2 branches covered.">        if (defaultConstructor != null) {</span>
<span class="fc" id="L115">            defaultConstructorParameterSize = defaultConstructor.getParameterTypes().length;</span>
<span class="fc bfc" id="L116" title="All 2 branches covered.">        } else if (factoryMethod != null) {</span>
<span class="fc" id="L117">            defaultConstructorParameterSize = factoryMethod.getParameterTypes().length;</span>
        } else {
<span class="fc" id="L119">            defaultConstructorParameterSize = 0;</span>
        }

<span class="fc bfc" id="L122" title="All 2 branches covered.">        if (creatorConstructor != null) {</span>
<span class="fc" id="L123">            this.creatorConstructorParameterTypes = creatorConstructor.getParameterTypes();</span>
            boolean match;
<span class="fc bfc" id="L125" title="All 2 branches covered.">            if (creatorConstructorParameterTypes.length != fields.length) {</span>
<span class="fc" id="L126">                match = false;</span>
            } else {
<span class="fc" id="L128">                match = true;</span>
<span class="fc bfc" id="L129" title="All 2 branches covered.">                for (int i = 0; i &lt; creatorConstructorParameterTypes.length; i++) {</span>
<span class="fc bfc" id="L130" title="All 2 branches covered.">                    if (creatorConstructorParameterTypes[i] != fields[i].fieldClass) {</span>
<span class="fc" id="L131">                        match = false;</span>
<span class="fc" id="L132">                        break;</span>
                    }
                }
            }

<span class="fc bfc" id="L137" title="All 2 branches covered.">            if (!match) {</span>
<span class="fc" id="L138">                boolean kotlin = TypeUtils.isKotlin(clazz);</span>
<span class="fc bfc" id="L139" title="All 2 branches covered.">                if (kotlin) {</span>
<span class="fc" id="L140">                    this.creatorConstructorParameters = TypeUtils.getKoltinConstructorParameters(clazz);</span>

<span class="fc" id="L142">                    Annotation[][] paramAnnotationArrays = creatorConstructor.getParameterAnnotations();</span>
<span class="pc bpc" id="L143" title="1 of 4 branches missed.">                    for (int i = 0; i &lt; creatorConstructorParameters.length &amp;&amp; i &lt; paramAnnotationArrays.length; ++i) {</span>
<span class="fc" id="L144">                        Annotation[] paramAnnotations = paramAnnotationArrays[i];</span>
<span class="fc" id="L145">                        JSONField fieldAnnotation = null;</span>
<span class="pc bfc" id="L146" title="All 2 branches covered.">                        for (Annotation paramAnnotation : paramAnnotations) {</span>
<span class="pc bpc" id="L147" title="1 of 2 branches missed.">                            if (paramAnnotation instanceof JSONField) {</span>
<span class="fc" id="L148">                                fieldAnnotation = (JSONField) paramAnnotation;</span>
<span class="fc" id="L149">                                break;</span>
                            }
                        }
<span class="fc bfc" id="L152" title="All 2 branches covered.">                        if (fieldAnnotation != null) {</span>
<span class="fc" id="L153">                            String fieldAnnotationName = fieldAnnotation.name();</span>
<span class="pc bpc" id="L154" title="1 of 2 branches missed.">                            if (fieldAnnotationName.length() &gt; 0) {</span>
<span class="fc" id="L155">                                creatorConstructorParameters[i] = fieldAnnotationName;</span>
                            }
                        }
                    }
<span class="fc" id="L159">                } else {</span>
<span class="fc" id="L160">                    this.creatorConstructorParameters = ASMUtils.lookupParameterNames(creatorConstructor);</span>
                }
            }
        }
<span class="fc" id="L164">    }</span>

    private static FieldInfo getField(List&lt;FieldInfo&gt; fieldList, String propertyName) {
<span class="fc bfc" id="L167" title="All 2 branches covered.">        for (FieldInfo item : fieldList) {</span>
<span class="fc bfc" id="L168" title="All 2 branches covered.">            if (item.name.equals(propertyName)) {</span>
<span class="fc" id="L169">                return item;</span>
            }

<span class="fc" id="L172">            Field field = item.field;</span>
<span class="fc bfc" id="L173" title="All 6 branches covered.">            if (field != null &amp;&amp; item.getAnnotation() != null &amp;&amp; field.getName().equals(propertyName)) {</span>
<span class="fc" id="L174">                return item;</span>
            }
<span class="fc" id="L176">        }</span>
<span class="fc" id="L177">        return null;</span>
    }


    static boolean add(List&lt;FieldInfo&gt; fieldList, FieldInfo field) {
<span class="fc bfc" id="L182" title="All 2 branches covered.">        for (int i = fieldList.size() - 1; i &gt;= 0; --i) {</span>
<span class="fc" id="L183">            FieldInfo item = fieldList.get(i);</span>

<span class="fc bfc" id="L185" title="All 2 branches covered.">            if (item.name.equals(field.name)) {</span>
<span class="pc bpc" id="L186" title="3 of 4 branches missed.">                if (item.getOnly &amp;&amp; !field.getOnly) {</span>
<span class="nc" id="L187">                    continue;</span>
                }

<span class="fc bfc" id="L190" title="All 2 branches covered.">                if (item.fieldClass.isAssignableFrom(field.fieldClass)) {</span>
<span class="fc" id="L191">                    fieldList.remove(i);</span>
<span class="fc" id="L192">                    break;</span>
                }

<span class="fc" id="L195">                int result = item.compareTo(field);</span>

<span class="fc bfc" id="L197" title="All 2 branches covered.">                if (result &lt; 0) {</span>
<span class="fc" id="L198">                    fieldList.remove(i);</span>
<span class="fc" id="L199">                    break;</span>
                } else {
<span class="fc" id="L201">                    return false;</span>
                }
            }
        }
<span class="fc" id="L205">        fieldList.add(field);</span>

<span class="fc" id="L207">        return true;</span>
    }

    public static JavaBeanInfo build(Class&lt;?&gt; clazz, Type type, PropertyNamingStrategy propertyNamingStrategy) {
<span class="fc" id="L211">        return build(clazz, type, propertyNamingStrategy, false, TypeUtils.compatibleWithJavaBean);</span>
    }

    public static JavaBeanInfo build(Class&lt;?&gt; clazz //
            , Type type //
            , PropertyNamingStrategy propertyNamingStrategy //
            , boolean fieldBased //
            , boolean compatibleWithJavaBean
    ) {
<span class="fc" id="L220">        JSONType jsonType = TypeUtils.getAnnotation(clazz,JSONType.class);</span>
<span class="fc bfc" id="L221" title="All 2 branches covered.">        if (jsonType != null) {</span>
<span class="fc" id="L222">            PropertyNamingStrategy jsonTypeNaming = jsonType.naming();</span>
<span class="pc bpc" id="L223" title="1 of 4 branches missed.">            if (jsonTypeNaming != null &amp;&amp; jsonTypeNaming != PropertyNamingStrategy.CamelCase) {</span>
<span class="fc" id="L224">                propertyNamingStrategy = jsonTypeNaming;</span>
            }
        }

<span class="fc" id="L228">        Class&lt;?&gt; builderClass = getBuilderClass(clazz, jsonType);</span>

<span class="fc" id="L230">        Field[] declaredFields = clazz.getDeclaredFields();</span>
<span class="fc" id="L231">        Method[] methods = clazz.getMethods();</span>

<span class="fc" id="L233">        boolean kotlin = TypeUtils.isKotlin(clazz);</span>
<span class="fc" id="L234">        Constructor[] constructors = clazz.getDeclaredConstructors();</span>

<span class="fc" id="L236">        Constructor&lt;?&gt; defaultConstructor = null;</span>
<span class="fc bfc" id="L237" title="All 4 branches covered.">        if ((!kotlin) || constructors.length == 1) {</span>
<span class="fc bfc" id="L238" title="All 2 branches covered.">            if (builderClass == null) {</span>
<span class="fc" id="L239">                defaultConstructor = getDefaultConstructor(clazz, constructors);</span>
            } else {
<span class="fc" id="L241">                defaultConstructor = getDefaultConstructor(builderClass, builderClass.getDeclaredConstructors());</span>
            }
        }

<span class="fc" id="L245">        Constructor&lt;?&gt; creatorConstructor = null;</span>
<span class="fc" id="L246">        Method buildMethod = null;</span>
<span class="fc" id="L247">        Method factoryMethod = null;</span>

<span class="fc" id="L249">        List&lt;FieldInfo&gt; fieldList = new ArrayList&lt;FieldInfo&gt;();</span>

<span class="fc bfc" id="L251" title="All 2 branches covered.">        if (fieldBased) {</span>
<span class="fc bfc" id="L252" title="All 2 branches covered.">            for (Class&lt;?&gt; currentClass = clazz; currentClass != null; currentClass = currentClass.getSuperclass()) {</span>
<span class="fc" id="L253">                Field[] fields = currentClass.getDeclaredFields();</span>

<span class="fc" id="L255">                computeFields(clazz, type, propertyNamingStrategy, fieldList, fields);</span>
            }
<span class="fc" id="L257">            return new JavaBeanInfo(clazz, builderClass, defaultConstructor, null, factoryMethod, buildMethod, jsonType, fieldList);</span>
        }

<span class="fc bfc" id="L260" title="All 4 branches covered.">        boolean isInterfaceOrAbstract = clazz.isInterface() || Modifier.isAbstract(clazz.getModifiers());</span>
<span class="pc bpc" id="L261" title="2 of 6 branches missed.">        if ((defaultConstructor == null &amp;&amp; builderClass == null) || isInterfaceOrAbstract) {</span>
<span class="fc" id="L262">            creatorConstructor = getCreatorConstructor(constructors);</span>

<span class="pc bpc" id="L264" title="1 of 4 branches missed.">            if (creatorConstructor != null &amp;&amp; !isInterfaceOrAbstract) { // 基于标记 JSONCreator 注解的构造方法</span>
<span class="fc" id="L265">                TypeUtils.setAccessible(creatorConstructor);</span>

<span class="fc" id="L267">                Class&lt;?&gt;[] types = creatorConstructor.getParameterTypes();</span>
<span class="pc bpc" id="L268" title="1 of 2 branches missed.">                if (types.length &gt; 0) {</span>
<span class="fc" id="L269">                    Annotation[][] paramAnnotationArrays = creatorConstructor.getParameterAnnotations();</span>
<span class="fc bfc" id="L270" title="All 2 branches covered.">                    for (int i = 0; i &lt; types.length; ++i) {</span>
<span class="fc" id="L271">                        Annotation[] paramAnnotations = paramAnnotationArrays[i];</span>
<span class="fc" id="L272">                        JSONField fieldAnnotation = null;</span>
<span class="pc bfc" id="L273" title="All 2 branches covered.">                        for (Annotation paramAnnotation : paramAnnotations) {</span>
<span class="pc bpc" id="L274" title="1 of 2 branches missed.">                            if (paramAnnotation instanceof JSONField) {</span>
<span class="fc" id="L275">                                fieldAnnotation = (JSONField) paramAnnotation;</span>
<span class="fc" id="L276">                                break;</span>
                            }
                        }
<span class="fc bfc" id="L279" title="All 2 branches covered.">                        if (fieldAnnotation == null) {</span>
<span class="fc" id="L280">                            throw new JSONException(&quot;illegal json creator&quot;);</span>
                        }
<span class="fc" id="L282">                        Class&lt;?&gt; fieldClass = types[i];</span>
<span class="fc" id="L283">                        Type fieldType = creatorConstructor.getGenericParameterTypes()[i];</span>
<span class="fc" id="L284">                        Field field = TypeUtils.getField(clazz, fieldAnnotation.name(), declaredFields);</span>
<span class="fc" id="L285">                        final int ordinal = fieldAnnotation.ordinal();</span>
<span class="fc" id="L286">                        final int serialzeFeatures = SerializerFeature.of(fieldAnnotation.serialzeFeatures());</span>
<span class="fc" id="L287">                        final int parserFeatures = Feature.of(fieldAnnotation.parseFeatures());</span>
<span class="fc" id="L288">                        FieldInfo fieldInfo = new FieldInfo(fieldAnnotation.name(), clazz, fieldClass, fieldType, field,</span>
                                ordinal, serialzeFeatures, parserFeatures);
<span class="fc" id="L290">                        add(fieldList, fieldInfo);</span>
                    }
                }

                //return new JavaBeanInfo(clazz, builderClass, null, creatorConstructor, null, null, jsonType, fieldList);
<span class="fc bfc" id="L295" title="All 2 branches covered.">            } else if ((factoryMethod = getFactoryMethod(clazz, methods)) != null) {</span>
<span class="fc" id="L296">                TypeUtils.setAccessible(factoryMethod);</span>

<span class="fc" id="L298">                Class&lt;?&gt;[] types = factoryMethod.getParameterTypes();</span>
<span class="fc bfc" id="L299" title="All 2 branches covered.">                if (types.length &gt; 0) {</span>
<span class="fc" id="L300">                    Annotation[][] paramAnnotationArrays = factoryMethod.getParameterAnnotations();</span>
<span class="fc bfc" id="L301" title="All 2 branches covered.">                    for (int i = 0; i &lt; types.length; ++i) {</span>
<span class="fc" id="L302">                        Annotation[] paramAnnotations = paramAnnotationArrays[i];</span>
<span class="fc" id="L303">                        JSONField fieldAnnotation = null;</span>
<span class="pc bfc" id="L304" title="All 2 branches covered.">                        for (Annotation paramAnnotation : paramAnnotations) {</span>
<span class="pc bpc" id="L305" title="1 of 2 branches missed.">                            if (paramAnnotation instanceof JSONField) {</span>
<span class="fc" id="L306">                                fieldAnnotation = (JSONField) paramAnnotation;</span>
<span class="fc" id="L307">                                break;</span>
                            }
                        }
<span class="fc bfc" id="L310" title="All 2 branches covered.">                        if (fieldAnnotation == null) {</span>
<span class="fc" id="L311">                            throw new JSONException(&quot;illegal json creator&quot;);</span>
                        }

<span class="fc" id="L314">                        Class&lt;?&gt; fieldClass = types[i];</span>
<span class="fc" id="L315">                        Type fieldType = factoryMethod.getGenericParameterTypes()[i];</span>
<span class="fc" id="L316">                        Field field = TypeUtils.getField(clazz, fieldAnnotation.name(), declaredFields);</span>
<span class="fc" id="L317">                        final int ordinal = fieldAnnotation.ordinal();</span>
<span class="fc" id="L318">                        final int serialzeFeatures = SerializerFeature.of(fieldAnnotation.serialzeFeatures());</span>
<span class="fc" id="L319">                        final int parserFeatures = Feature.of(fieldAnnotation.parseFeatures());</span>
<span class="fc" id="L320">                        FieldInfo fieldInfo = new FieldInfo(fieldAnnotation.name(), clazz, fieldClass, fieldType, field,</span>
                                ordinal, serialzeFeatures, parserFeatures);
<span class="fc" id="L322">                        add(fieldList, fieldInfo);</span>
                    }

<span class="fc" id="L325">                    return new JavaBeanInfo(clazz, builderClass, null, null, factoryMethod, null, jsonType, fieldList);</span>
                }
<span class="fc bfc" id="L327" title="All 2 branches covered.">            } else if (!isInterfaceOrAbstract) {</span>
<span class="fc" id="L328">                String className = clazz.getName();</span>

<span class="fc" id="L330">                String[] paramNames = null;</span>
<span class="pc bpc" id="L331" title="1 of 4 branches missed.">                if (kotlin &amp;&amp; constructors.length &gt; 0) {</span>
<span class="fc" id="L332">                    paramNames = TypeUtils.getKoltinConstructorParameters(clazz);</span>
<span class="fc" id="L333">                    creatorConstructor = TypeUtils.getKoltinConstructor(constructors);</span>
<span class="fc" id="L334">                    TypeUtils.setAccessible(creatorConstructor);</span>
                } else {

<span class="fc bfc" id="L337" title="All 2 branches covered.">                    for (Constructor constructor : constructors) {</span>
<span class="fc" id="L338">                        Class&lt;?&gt;[] parameterTypes = constructor.getParameterTypes();</span>

<span class="fc bfc" id="L340" title="All 2 branches covered.">                        if (className.equals(&quot;org.springframework.security.web.authentication.WebAuthenticationDetails&quot;)) {</span>
<span class="pc bpc" id="L341" title="2 of 6 branches missed.">                            if (parameterTypes.length == 2 &amp;&amp; parameterTypes[0] == String.class &amp;&amp; parameterTypes[1] == String.class) {</span>
<span class="fc" id="L342">                                creatorConstructor = constructor;</span>
<span class="fc" id="L343">                                creatorConstructor.setAccessible(true);</span>
<span class="fc" id="L344">                                paramNames = ASMUtils.lookupParameterNames(constructor);</span>
<span class="fc" id="L345">                                break;</span>
                            }
                        }

<span class="fc bfc" id="L349" title="All 2 branches covered.">                        if (className.equals(&quot;org.springframework.security.web.authentication.preauth.PreAuthenticatedAuthenticationToken&quot;)) {</span>
<span class="pc bpc" id="L350" title="3 of 8 branches missed.">                            if (parameterTypes.length == 3</span>
                                    &amp;&amp; parameterTypes[0] == Object.class
                                    &amp;&amp; parameterTypes[1] == Object.class
                                    &amp;&amp; parameterTypes[2] == Collection.class) {
<span class="fc" id="L354">                                creatorConstructor = constructor;</span>
<span class="fc" id="L355">                                creatorConstructor.setAccessible(true);</span>
<span class="fc" id="L356">                                paramNames = new String[] {&quot;principal&quot;, &quot;credentials&quot;, &quot;authorities&quot;};</span>
<span class="fc" id="L357">                                break;</span>
                            }
                        }

<span class="fc bfc" id="L361" title="All 2 branches covered.">                        if (className.equals(&quot;org.springframework.security.core.authority.SimpleGrantedAuthority&quot;)) {</span>
<span class="pc bpc" id="L362" title="2 of 4 branches missed.">                            if (parameterTypes.length == 1</span>
                                    &amp;&amp; parameterTypes[0] == String.class) {
<span class="fc" id="L364">                                creatorConstructor = constructor;</span>
<span class="fc" id="L365">                                paramNames = new String[] {&quot;authority&quot;};</span>
<span class="fc" id="L366">                                break;</span>
                            }
                        }

                        //


<span class="pc bpc" id="L373" title="1 of 2 branches missed.">                        boolean is_public = (constructor.getModifiers() &amp; Modifier.PUBLIC) != 0;</span>
<span class="pc bpc" id="L374" title="1 of 2 branches missed.">                        if (!is_public) {</span>
<span class="nc" id="L375">                            continue;</span>
                        }
<span class="fc" id="L377">                        String[] lookupParameterNames = ASMUtils.lookupParameterNames(constructor);</span>
<span class="pc bpc" id="L378" title="2 of 4 branches missed.">                        if (lookupParameterNames == null || lookupParameterNames.length == 0) {</span>
<span class="nc" id="L379">                            continue;</span>
                        }

<span class="pc bpc" id="L382" title="1 of 6 branches missed.">                        if (creatorConstructor != null</span>
                                &amp;&amp; paramNames != null &amp;&amp; lookupParameterNames.length &lt;= paramNames.length) {
<span class="fc" id="L384">                            continue;</span>
                        }

<span class="fc" id="L387">                        paramNames = lookupParameterNames;</span>
<span class="fc" id="L388">                        creatorConstructor = constructor;</span>
                    }
                }

<span class="fc" id="L392">                Class&lt;?&gt;[] types = null;</span>
<span class="pc bpc" id="L393" title="1 of 2 branches missed.">                if (paramNames != null) {</span>
<span class="fc" id="L394">                    types = creatorConstructor.getParameterTypes();</span>
                }

<span class="pc bpc" id="L397" title="1 of 4 branches missed.">                if (paramNames != null</span>
                        &amp;&amp; types.length == paramNames.length) {
<span class="fc" id="L399">                    Annotation[][] paramAnnotationArrays = creatorConstructor.getParameterAnnotations();</span>
<span class="fc bfc" id="L400" title="All 2 branches covered.">                    for (int i = 0; i &lt; types.length; ++i) {</span>
<span class="fc" id="L401">                        Annotation[] paramAnnotations = paramAnnotationArrays[i];</span>
<span class="fc" id="L402">                        String paramName = paramNames[i];</span>

<span class="fc" id="L404">                        JSONField fieldAnnotation = null;</span>
<span class="pc bpc" id="L405" title="1 of 2 branches missed.">                        for (Annotation paramAnnotation : paramAnnotations) {</span>
<span class="nc bnc" id="L406" title="All 2 branches missed.">                            if (paramAnnotation instanceof JSONField) {</span>
<span class="nc" id="L407">                                fieldAnnotation = (JSONField) paramAnnotation;</span>
<span class="nc" id="L408">                                break;</span>
                            }
                        }

<span class="fc" id="L412">                        Class&lt;?&gt; fieldClass = types[i];</span>
<span class="fc" id="L413">                        Type fieldType = creatorConstructor.getGenericParameterTypes()[i];</span>
<span class="fc" id="L414">                        Field field = TypeUtils.getField(clazz, paramName, declaredFields);</span>
<span class="fc bfc" id="L415" title="All 2 branches covered.">                        if (field != null) {</span>
<span class="pc bpc" id="L416" title="1 of 2 branches missed.">                            if (fieldAnnotation == null) {</span>
<span class="fc" id="L417">                                fieldAnnotation = field.getAnnotation(JSONField.class);</span>
                            }
                        }
                        final int ordinal, serialzeFeatures, parserFeatures;
<span class="fc bfc" id="L421" title="All 2 branches covered.">                        if (fieldAnnotation == null) {</span>
<span class="fc" id="L422">                            ordinal = 0;</span>
<span class="fc" id="L423">                            serialzeFeatures = 0;</span>

<span class="fc bfc" id="L425" title="All 2 branches covered.">                            if (&quot;org.springframework.security.core.userdetails.User&quot;.equals(className)</span>
<span class="fc bfc" id="L426" title="All 2 branches covered.">                                    &amp;&amp; &quot;password&quot;.equals(paramName)) {</span>
<span class="fc" id="L427">                                parserFeatures = Feature.InitStringFieldAsEmpty.mask;</span>
                            } else {
<span class="fc" id="L429">                                parserFeatures = 0;</span>
                            }
                        } else {
<span class="fc" id="L432">                            String nameAnnotated = fieldAnnotation.name();</span>
<span class="pc bpc" id="L433" title="1 of 2 branches missed.">                            if (nameAnnotated.length() != 0) {</span>
<span class="fc" id="L434">                                paramName = nameAnnotated;</span>
                            }
<span class="fc" id="L436">                            ordinal = fieldAnnotation.ordinal();</span>
<span class="fc" id="L437">                            serialzeFeatures = SerializerFeature.of(fieldAnnotation.serialzeFeatures());</span>
<span class="fc" id="L438">                            parserFeatures = Feature.of(fieldAnnotation.parseFeatures());</span>
                        }
<span class="fc" id="L440">                        FieldInfo fieldInfo = new FieldInfo(paramName, clazz, fieldClass, fieldType, field,</span>
                                ordinal, serialzeFeatures, parserFeatures);
<span class="fc" id="L442">                        add(fieldList, fieldInfo);</span>
                    }

<span class="fc bfc" id="L445" title="All 2 branches covered.">                    if ((!kotlin)</span>
<span class="fc bfc" id="L446" title="All 2 branches covered.">                            &amp;&amp; !clazz.getName().equals(&quot;javax.servlet.http.Cookie&quot;)) {</span>
<span class="fc" id="L447">                        return new JavaBeanInfo(clazz, builderClass, null, creatorConstructor, null, null, jsonType, fieldList);</span>
                    }
<span class="fc" id="L449">                } else {</span>
<span class="fc" id="L450">                    throw new JSONException(&quot;default constructor not found. &quot; + clazz);</span>
                }
            }
        }

<span class="fc bfc" id="L455" title="All 2 branches covered.">        if (defaultConstructor != null) {</span>
<span class="fc" id="L456">            TypeUtils.setAccessible(defaultConstructor);</span>
        }

<span class="fc bfc" id="L459" title="All 2 branches covered.">        if (builderClass != null) {</span>
<span class="fc" id="L460">            String withPrefix = null;</span>

<span class="fc" id="L462">            JSONPOJOBuilder builderAnno = builderClass.getAnnotation(JSONPOJOBuilder.class);</span>
<span class="fc bfc" id="L463" title="All 2 branches covered.">            if (builderAnno != null) {</span>
<span class="fc" id="L464">                withPrefix = builderAnno.withPrefix();</span>
            }

<span class="pc bpc" id="L467" title="1 of 4 branches missed.">            if (withPrefix == null || withPrefix.length() == 0) {</span>
<span class="fc" id="L468">                withPrefix = &quot;with&quot;;</span>
            }

<span class="fc bfc" id="L471" title="All 2 branches covered.">            for (Method method : builderClass.getMethods()) {</span>
<span class="pc bpc" id="L472" title="1 of 2 branches missed.">                if (Modifier.isStatic(method.getModifiers())) {</span>
<span class="nc" id="L473">                    continue;</span>
                }

<span class="fc bfc" id="L476" title="All 2 branches covered.">                if (!(method.getReturnType().equals(builderClass))) {</span>
<span class="fc" id="L477">                    continue;</span>
                }

<span class="fc" id="L480">                int ordinal = 0, serialzeFeatures = 0, parserFeatures = 0;</span>

<span class="fc" id="L482">                JSONField annotation = method.getAnnotation(JSONField.class);</span>

<span class="fc bfc" id="L484" title="All 2 branches covered.">                if (annotation == null) {</span>
<span class="fc" id="L485">                    annotation = TypeUtils.getSuperMethodAnnotation(clazz, method);</span>
                }

<span class="fc bfc" id="L488" title="All 2 branches covered.">                if (annotation != null) {</span>
<span class="pc bpc" id="L489" title="1 of 2 branches missed.">                    if (!annotation.deserialize()) {</span>
<span class="nc" id="L490">                        continue;</span>
                    }

<span class="fc" id="L493">                    ordinal = annotation.ordinal();</span>
<span class="fc" id="L494">                    serialzeFeatures = SerializerFeature.of(annotation.serialzeFeatures());</span>
<span class="fc" id="L495">                    parserFeatures = Feature.of(annotation.parseFeatures());</span>

<span class="pc bpc" id="L497" title="1 of 2 branches missed.">                    if (annotation.name().length() != 0) {</span>
<span class="fc" id="L498">                        String propertyName = annotation.name();</span>
<span class="fc" id="L499">                        add(fieldList, new FieldInfo(propertyName, method, null, clazz, type, ordinal, serialzeFeatures, parserFeatures,</span>
                                annotation, null, null));
<span class="fc" id="L501">                        continue;</span>
                    }
                }

<span class="fc" id="L505">                String methodName = method.getName();</span>
                StringBuilder properNameBuilder;
<span class="pc bpc" id="L507" title="1 of 4 branches missed.">                if (methodName.startsWith(&quot;set&quot;) &amp;&amp; methodName.length() &gt; 3) {</span>
<span class="fc" id="L508">                    properNameBuilder = new StringBuilder(methodName.substring(3));</span>
                } else {
<span class="pc bpc" id="L510" title="1 of 2 branches missed.">                    if (!methodName.startsWith(withPrefix)) {</span>
<span class="nc" id="L511">                        continue;</span>
                    }

<span class="pc bpc" id="L514" title="1 of 2 branches missed.">                    if (methodName.length() &lt;= withPrefix.length()) {</span>
<span class="nc" id="L515">                        continue;</span>
                    }

<span class="fc" id="L518">                    properNameBuilder = new StringBuilder(methodName.substring(withPrefix.length()));</span>
                }

<span class="fc" id="L521">                char c0 = properNameBuilder.charAt(0);</span>
<span class="pc bpc" id="L522" title="1 of 2 branches missed.">                if (!Character.isUpperCase(c0)) {</span>
<span class="nc" id="L523">                    continue;</span>
                }

<span class="fc" id="L526">                properNameBuilder.setCharAt(0, Character.toLowerCase(c0));</span>

<span class="fc" id="L528">                String propertyName = properNameBuilder.toString();</span>

<span class="fc" id="L530">                add(fieldList, new FieldInfo(propertyName, method, null, clazz, type, ordinal, serialzeFeatures, parserFeatures,</span>
                        annotation, null, null));
            }

<span class="pc bpc" id="L534" title="1 of 2 branches missed.">            if (builderClass != null) {</span>
<span class="fc" id="L535">                JSONPOJOBuilder builderAnnotation = builderClass.getAnnotation(JSONPOJOBuilder.class);</span>

<span class="fc" id="L537">                String buildMethodName = null;</span>
<span class="fc bfc" id="L538" title="All 2 branches covered.">                if (builderAnnotation != null) {</span>
<span class="fc" id="L539">                    buildMethodName = builderAnnotation.buildMethod();</span>
                }

<span class="pc bpc" id="L542" title="1 of 4 branches missed.">                if (buildMethodName == null || buildMethodName.length() == 0) {</span>
<span class="fc" id="L543">                    buildMethodName = &quot;build&quot;;</span>
                }

                try {
<span class="fc" id="L547">                    buildMethod = builderClass.getMethod(buildMethodName);</span>
<span class="fc" id="L548">                } catch (NoSuchMethodException e) {</span>
                    // skip
<span class="nc" id="L550">                } catch (SecurityException e) {</span>
                    // skip
<span class="fc" id="L552">                }</span>

<span class="fc bfc" id="L554" title="All 2 branches covered.">                if (buildMethod == null) {</span>
                    try {
<span class="fc" id="L556">                        buildMethod = builderClass.getMethod(&quot;create&quot;);</span>
<span class="nc" id="L557">                    } catch (NoSuchMethodException e) {</span>
                        // skip
<span class="nc" id="L559">                    } catch (SecurityException e) {</span>
                        // skip
<span class="pc" id="L561">                    }</span>
                }

<span class="pc bpc" id="L564" title="1 of 2 branches missed.">                if (buildMethod == null) {</span>
<span class="nc" id="L565">                    throw new JSONException(&quot;buildMethod not found.&quot;);</span>
                }

<span class="fc" id="L568">                TypeUtils.setAccessible(buildMethod);</span>
            }
        }

<span class="fc bfc" id="L572" title="All 2 branches covered.">        for (Method method : methods) { //</span>
<span class="fc" id="L573">            int ordinal = 0, serialzeFeatures = 0, parserFeatures = 0;</span>
<span class="fc" id="L574">            String methodName = method.getName();</span>

<span class="fc bfc" id="L576" title="All 2 branches covered.">            if (Modifier.isStatic(method.getModifiers())) {</span>
<span class="fc" id="L577">                continue;</span>
            }

            // support builder set
<span class="fc" id="L581">            Class&lt;?&gt; returnType = method.getReturnType();</span>
<span class="fc bfc" id="L582" title="All 4 branches covered.">            if (!(returnType.equals(Void.TYPE) || returnType.equals(method.getDeclaringClass()))) {</span>
<span class="fc" id="L583">                continue;</span>
            }

<span class="fc bfc" id="L586" title="All 2 branches covered.">            if (method.getDeclaringClass() == Object.class) {</span>
<span class="fc" id="L587">                continue;</span>
            }

<span class="fc" id="L590">            Class&lt;?&gt;[] types = method.getParameterTypes();</span>

<span class="fc bfc" id="L592" title="All 4 branches covered.">            if (types.length == 0 || types.length &gt; 2) {</span>
<span class="fc" id="L593">                continue;</span>
            }

<span class="fc" id="L596">            JSONField annotation = method.getAnnotation(JSONField.class);</span>
<span class="pc bpc" id="L597" title="2 of 8 branches missed.">            if (annotation != null</span>
                    &amp;&amp; types.length == 2
                    &amp;&amp; types[0] == String.class
                    &amp;&amp; types[1] == Object.class) {
<span class="fc" id="L601">                add(fieldList, new FieldInfo(&quot;&quot;, method, null, clazz, type, ordinal,</span>
                        serialzeFeatures, parserFeatures, annotation, null, null));
<span class="fc" id="L603">                continue;</span>
            }

<span class="fc bfc" id="L606" title="All 2 branches covered.">            if (types.length != 1) {</span>
<span class="fc" id="L607">                continue;</span>
            }

<span class="fc bfc" id="L610" title="All 2 branches covered.">            if (annotation == null) {</span>
<span class="fc" id="L611">                annotation = TypeUtils.getSuperMethodAnnotation(clazz, method);</span>
            }

<span class="fc bfc" id="L614" title="All 4 branches covered.">            if (annotation == null &amp;&amp; methodName.length() &lt; 4) {</span>
<span class="fc" id="L615">                continue;</span>
            }

<span class="fc bfc" id="L618" title="All 2 branches covered.">            if (annotation != null) {</span>
<span class="fc bfc" id="L619" title="All 2 branches covered.">                if (!annotation.deserialize()) {</span>
<span class="fc" id="L620">                    continue;</span>
                }

<span class="fc" id="L623">                ordinal = annotation.ordinal();</span>
<span class="fc" id="L624">                serialzeFeatures = SerializerFeature.of(annotation.serialzeFeatures());</span>
<span class="fc" id="L625">                parserFeatures = Feature.of(annotation.parseFeatures());</span>

<span class="fc bfc" id="L627" title="All 2 branches covered.">                if (annotation.name().length() != 0) {</span>
<span class="fc" id="L628">                    String propertyName = annotation.name();</span>
<span class="fc" id="L629">                    add(fieldList, new FieldInfo(propertyName, method, null, clazz, type, ordinal, serialzeFeatures, parserFeatures,</span>
                            annotation, null, null));
<span class="fc" id="L631">                    continue;</span>
                }
            }

<span class="fc bfc" id="L635" title="All 4 branches covered.">            if (annotation == null &amp;&amp; !methodName.startsWith(&quot;set&quot;)) { // TODO &quot;set&quot;的判断放在 JSONField 注解后面，意思是允许非 setter 方法标记 JSONField 注解？</span>
<span class="fc" id="L636">                continue;</span>
            }

<span class="fc" id="L639">            char c3 = methodName.charAt(3);</span>

            String propertyName;
<span class="fc bfc" id="L642" title="All 4 branches covered.">            if (Character.isUpperCase(c3) //</span>
                    || c3 &gt; 512 // for unicode method name
                    ) {
<span class="fc bfc" id="L645" title="All 2 branches covered.">                if (TypeUtils.compatibleWithJavaBean) {</span>
<span class="fc" id="L646">                    propertyName = TypeUtils.decapitalize(methodName.substring(3));</span>
                } else {
<span class="fc" id="L648">                    propertyName = Character.toLowerCase(methodName.charAt(3)) + methodName.substring(4);</span>
                }
<span class="fc bfc" id="L650" title="All 2 branches covered.">            } else if (c3 == '_') {</span>
<span class="fc" id="L651">                propertyName = methodName.substring(4);</span>
<span class="fc bfc" id="L652" title="All 2 branches covered.">            } else if (c3 == 'f') {</span>
<span class="fc" id="L653">                propertyName = methodName.substring(3);</span>
<span class="pc bpc" id="L654" title="1 of 4 branches missed.">            } else if (methodName.length() &gt;= 5 &amp;&amp; Character.isUpperCase(methodName.charAt(4))) {</span>
<span class="fc" id="L655">                propertyName = TypeUtils.decapitalize(methodName.substring(3));</span>
            } else {
                continue;
            }

<span class="fc" id="L660">            Field field = TypeUtils.getField(clazz, propertyName, declaredFields);</span>
<span class="fc bfc" id="L661" title="All 4 branches covered.">            if (field == null &amp;&amp; types[0] == boolean.class) {</span>
<span class="fc" id="L662">                String isFieldName = &quot;is&quot; + Character.toUpperCase(propertyName.charAt(0)) + propertyName.substring(1);</span>
<span class="fc" id="L663">                field = TypeUtils.getField(clazz, isFieldName, declaredFields);</span>
            }

<span class="fc" id="L666">            JSONField fieldAnnotation = null;</span>
<span class="fc bfc" id="L667" title="All 2 branches covered.">            if (field != null) {</span>
<span class="fc" id="L668">                fieldAnnotation = field.getAnnotation(JSONField.class);</span>

<span class="fc bfc" id="L670" title="All 2 branches covered.">                if (fieldAnnotation != null) {</span>
<span class="fc bfc" id="L671" title="All 2 branches covered.">                    if (!fieldAnnotation.deserialize()) {</span>
<span class="fc" id="L672">                        continue;</span>
                    }

<span class="fc" id="L675">                    ordinal = fieldAnnotation.ordinal();</span>
<span class="fc" id="L676">                    serialzeFeatures = SerializerFeature.of(fieldAnnotation.serialzeFeatures());</span>
<span class="fc" id="L677">                    parserFeatures = Feature.of(fieldAnnotation.parseFeatures());</span>

<span class="fc bfc" id="L679" title="All 2 branches covered.">                    if (fieldAnnotation.name().length() != 0) {</span>
<span class="fc" id="L680">                        propertyName = fieldAnnotation.name();</span>
<span class="fc" id="L681">                        add(fieldList, new FieldInfo(propertyName, method, field, clazz, type, ordinal,</span>
                                serialzeFeatures, parserFeatures, annotation, fieldAnnotation, null));
<span class="fc" id="L683">                        continue;</span>
                    }
                }

            }

<span class="fc bfc" id="L689" title="All 2 branches covered.">            if (propertyNamingStrategy != null) {</span>
<span class="fc" id="L690">                propertyName = propertyNamingStrategy.translate(propertyName);</span>
            }

<span class="fc" id="L693">            add(fieldList, new FieldInfo(propertyName, method, field, clazz, type, ordinal, serialzeFeatures, parserFeatures,</span>
                    annotation, fieldAnnotation, null));
        }

<span class="fc" id="L697">        Field[] fields = clazz.getFields();</span>
<span class="fc" id="L698">        computeFields(clazz, type, propertyNamingStrategy, fieldList, fields);</span>

<span class="fc bfc" id="L700" title="All 2 branches covered.">        for (Method method : clazz.getMethods()) { // getter methods</span>
<span class="fc" id="L701">            String methodName = method.getName();</span>
<span class="fc bfc" id="L702" title="All 2 branches covered.">            if (methodName.length() &lt; 4) {</span>
<span class="fc" id="L703">                continue;</span>
            }

<span class="fc bfc" id="L706" title="All 2 branches covered.">            if (Modifier.isStatic(method.getModifiers())) {</span>
<span class="fc" id="L707">                continue;</span>
            }

<span class="fc bfc" id="L710" title="All 6 branches covered.">            if (builderClass == null &amp;&amp; methodName.startsWith(&quot;get&quot;) &amp;&amp; Character.isUpperCase(methodName.charAt(3))) {</span>
<span class="fc bfc" id="L711" title="All 2 branches covered.">                if (method.getParameterTypes().length != 0) {</span>
<span class="fc" id="L712">                    continue;</span>
                }

<span class="fc bfc" id="L715" title="All 2 branches covered.">                if (Collection.class.isAssignableFrom(method.getReturnType()) //</span>
<span class="fc bfc" id="L716" title="All 2 branches covered.">                        || Map.class.isAssignableFrom(method.getReturnType()) //</span>
<span class="fc bfc" id="L717" title="All 2 branches covered.">                        || AtomicBoolean.class == method.getReturnType() //</span>
<span class="fc bfc" id="L718" title="All 2 branches covered.">                        || AtomicInteger.class == method.getReturnType() //</span>
<span class="fc bfc" id="L719" title="All 2 branches covered.">                        || AtomicLong.class == method.getReturnType() //</span>
                        ) {
                    String propertyName;

<span class="fc" id="L723">                    JSONField annotation = method.getAnnotation(JSONField.class);</span>
<span class="pc bpc" id="L724" title="1 of 4 branches missed.">                    if (annotation != null &amp;&amp; annotation.deserialize()) {</span>
<span class="fc" id="L725">                        continue;</span>
                    }

<span class="pc bpc" id="L728" title="3 of 4 branches missed.">                    if (annotation != null &amp;&amp; annotation.name().length() &gt; 0) {</span>
<span class="nc" id="L729">                        propertyName = annotation.name();</span>
                    } else {
<span class="fc" id="L731">                        propertyName = Character.toLowerCase(methodName.charAt(3)) + methodName.substring(4);</span>

<span class="fc" id="L733">                        Field field = TypeUtils.getField(clazz, propertyName, declaredFields);</span>
<span class="fc bfc" id="L734" title="All 2 branches covered.">                        if (field != null) {</span>
<span class="fc" id="L735">                            JSONField fieldAnnotation = field.getAnnotation(JSONField.class);</span>
<span class="fc bfc" id="L736" title="All 4 branches covered.">                            if (fieldAnnotation != null &amp;&amp; !fieldAnnotation.deserialize()) {</span>
<span class="fc" id="L737">                                continue;</span>
                            }
                        }
                    }

<span class="fc" id="L742">                    FieldInfo fieldInfo = getField(fieldList, propertyName);</span>
<span class="fc bfc" id="L743" title="All 2 branches covered.">                    if (fieldInfo != null) {</span>
<span class="fc" id="L744">                        continue;</span>
                    }

<span class="pc bpc" id="L747" title="1 of 2 branches missed.">                    if (propertyNamingStrategy != null) {</span>
<span class="nc" id="L748">                        propertyName = propertyNamingStrategy.translate(propertyName);</span>
                    }

<span class="fc" id="L751">                    add(fieldList, new FieldInfo(propertyName, method, null, clazz, type, 0, 0, 0, annotation, null, null));</span>
                }
            }
        }

<span class="fc" id="L756">        return new JavaBeanInfo(clazz, builderClass, defaultConstructor, creatorConstructor, factoryMethod, buildMethod, jsonType, fieldList);</span>
    }

    private static void computeFields(Class&lt;?&gt; clazz, Type type, PropertyNamingStrategy propertyNamingStrategy, List&lt;FieldInfo&gt; fieldList, Field[] fields) {
<span class="fc bfc" id="L760" title="All 2 branches covered.">        for (Field field : fields) { // public static fields</span>
<span class="fc" id="L761">            int modifiers = field.getModifiers();</span>
<span class="fc bfc" id="L762" title="All 2 branches covered.">            if ((modifiers &amp; Modifier.STATIC) != 0) {</span>
<span class="fc" id="L763">                continue;</span>
            }

<span class="fc bfc" id="L766" title="All 2 branches covered.">            if ((modifiers &amp; Modifier.FINAL) != 0) {</span>
<span class="fc" id="L767">                Class&lt;?&gt; fieldType = field.getType();</span>
<span class="fc bfc" id="L768" title="All 2 branches covered.">                boolean supportReadOnly = Map.class.isAssignableFrom(fieldType)</span>
<span class="fc bfc" id="L769" title="All 2 branches covered.">                        || Collection.class.isAssignableFrom(fieldType)</span>
<span class="fc bfc" id="L770" title="All 2 branches covered.">                        || AtomicLong.class.equals(fieldType) //</span>
<span class="fc bfc" id="L771" title="All 2 branches covered.">                        || AtomicInteger.class.equals(fieldType) //</span>
<span class="fc bfc" id="L772" title="All 2 branches covered.">                        || AtomicBoolean.class.equals(fieldType);</span>
<span class="fc bfc" id="L773" title="All 2 branches covered.">                if (!supportReadOnly) {</span>
<span class="fc" id="L774">                    continue;</span>
                }
            }

<span class="fc" id="L778">            boolean contains = false;</span>
<span class="fc bfc" id="L779" title="All 2 branches covered.">            for (FieldInfo item : fieldList) {</span>
<span class="fc bfc" id="L780" title="All 2 branches covered.">                if (item.name.equals(field.getName())) {</span>
<span class="fc" id="L781">                    contains = true;</span>
<span class="fc" id="L782">                    break; // 已经是 contains = true，无需继续遍历</span>
                }
<span class="fc" id="L784">            }</span>

<span class="fc bfc" id="L786" title="All 2 branches covered.">            if (contains) {</span>
<span class="fc" id="L787">                continue;</span>
            }

<span class="fc" id="L790">            int ordinal = 0, serialzeFeatures = 0, parserFeatures = 0;</span>
<span class="fc" id="L791">            String propertyName = field.getName();</span>

<span class="fc" id="L793">            JSONField fieldAnnotation = field.getAnnotation(JSONField.class);</span>

<span class="fc bfc" id="L795" title="All 2 branches covered.">            if (fieldAnnotation != null) {</span>
<span class="fc bfc" id="L796" title="All 2 branches covered.">                if (!fieldAnnotation.deserialize()) {</span>
<span class="fc" id="L797">                    continue;</span>
                }

<span class="fc" id="L800">                ordinal = fieldAnnotation.ordinal();</span>
<span class="fc" id="L801">                serialzeFeatures = SerializerFeature.of(fieldAnnotation.serialzeFeatures());</span>
<span class="fc" id="L802">                parserFeatures = Feature.of(fieldAnnotation.parseFeatures());</span>

<span class="fc bfc" id="L804" title="All 2 branches covered.">                if (fieldAnnotation.name().length() != 0) {</span>
<span class="fc" id="L805">                    propertyName = fieldAnnotation.name();</span>
                }
            }

<span class="fc bfc" id="L809" title="All 2 branches covered.">            if (propertyNamingStrategy != null) {</span>
<span class="fc" id="L810">                propertyName = propertyNamingStrategy.translate(propertyName);</span>
            }

<span class="fc" id="L813">            add(fieldList, new FieldInfo(propertyName, null, field, clazz, type, ordinal, serialzeFeatures, parserFeatures, null,</span>
                    fieldAnnotation, null));
        }
<span class="fc" id="L816">    }</span>

    static Constructor&lt;?&gt; getDefaultConstructor(Class&lt;?&gt; clazz, final Constructor&lt;?&gt;[] constructors) {
<span class="fc bfc" id="L819" title="All 2 branches covered.">        if (Modifier.isAbstract(clazz.getModifiers())) {</span>
<span class="fc" id="L820">            return null;</span>
        }

<span class="fc" id="L823">        Constructor&lt;?&gt; defaultConstructor = null;</span>

<span class="fc bfc" id="L825" title="All 2 branches covered.">        for (Constructor&lt;?&gt; constructor : constructors) {</span>
<span class="fc bfc" id="L826" title="All 2 branches covered.">            if (constructor.getParameterTypes().length == 0) {</span>
<span class="fc" id="L827">                defaultConstructor = constructor;</span>
<span class="fc" id="L828">                break;</span>
            }
        }

<span class="fc bfc" id="L832" title="All 2 branches covered.">        if (defaultConstructor == null) {</span>
<span class="fc bfc" id="L833" title="All 4 branches covered.">            if (clazz.isMemberClass() &amp;&amp; !Modifier.isStatic(clazz.getModifiers())) {</span>
                Class&lt;?&gt;[] types;
<span class="fc bfc" id="L835" title="All 2 branches covered.">                for (Constructor&lt;?&gt; constructor : constructors) {</span>
<span class="fc bfc" id="L836" title="All 2 branches covered.">                    if ((types = constructor.getParameterTypes()).length == 1</span>
<span class="pc bpc" id="L837" title="1 of 2 branches missed.">                            &amp;&amp; types[0].equals(clazz.getDeclaringClass())) {</span>
<span class="fc" id="L838">                        defaultConstructor = constructor;</span>
<span class="fc" id="L839">                        break;</span>
                    }
                }
            }
        }

<span class="fc" id="L845">        return defaultConstructor;</span>
    }

    public static Constructor&lt;?&gt; getCreatorConstructor(Constructor[] constructors) {
<span class="fc" id="L849">        Constructor&lt;?&gt; creatorConstructor = null;</span>

<span class="fc bfc" id="L851" title="All 2 branches covered.">        for (Constructor&lt;?&gt; constructor : constructors) {</span>
<span class="fc" id="L852">            JSONCreator annotation = constructor.getAnnotation(JSONCreator.class);</span>
<span class="fc bfc" id="L853" title="All 2 branches covered.">            if (annotation != null) {</span>
<span class="pc bpc" id="L854" title="1 of 2 branches missed.">                if (creatorConstructor != null) {</span>
<span class="nc" id="L855">                    throw new JSONException(&quot;multi-JSONCreator&quot;);</span>
                }

<span class="fc" id="L858">                creatorConstructor = constructor;</span>
                // 不应该break，否则多个构造方法上存在 JSONCreator 注解时，并不会触发上述异常抛出
            }
        }
<span class="fc bfc" id="L862" title="All 2 branches covered.">        if (creatorConstructor != null) {</span>
<span class="fc" id="L863">            return creatorConstructor;</span>
        }

<span class="fc bfc" id="L866" title="All 2 branches covered.">        for (Constructor constructor : constructors) {</span>
<span class="fc" id="L867">            Annotation[][] paramAnnotationArrays = constructor.getParameterAnnotations();</span>
<span class="fc bfc" id="L868" title="All 2 branches covered.">            if (paramAnnotationArrays.length == 0) {</span>
<span class="fc" id="L869">                continue;</span>
            }
<span class="fc" id="L871">            boolean match = true;</span>
<span class="fc bfc" id="L872" title="All 2 branches covered.">            for (Annotation[] paramAnnotationArray : paramAnnotationArrays) {</span>
<span class="fc" id="L873">                boolean paramMatch = false;</span>
<span class="pc bfc" id="L874" title="All 2 branches covered.">                for (Annotation paramAnnotation : paramAnnotationArray) {</span>
<span class="pc bpc" id="L875" title="1 of 2 branches missed.">                    if (paramAnnotation instanceof JSONField) {</span>
<span class="fc" id="L876">                        paramMatch = true;</span>
<span class="fc" id="L877">                        break;</span>
                    }
                }
<span class="fc bfc" id="L880" title="All 2 branches covered.">                if (!paramMatch) {</span>
<span class="fc" id="L881">                    match = false;</span>
<span class="fc" id="L882">                    break;</span>
                }
            }

<span class="fc bfc" id="L886" title="All 2 branches covered.">            if (match) {</span>
<span class="pc bpc" id="L887" title="1 of 2 branches missed.">                if (creatorConstructor != null) {</span>
<span class="nc" id="L888">                    throw new JSONException(&quot;multi-JSONCreator&quot;);</span>
                }

<span class="fc" id="L891">                creatorConstructor = constructor;</span>
            }
        }

<span class="fc bfc" id="L895" title="All 2 branches covered.">        if (creatorConstructor != null) {</span>
<span class="fc" id="L896">            return creatorConstructor;</span>
        }

<span class="fc" id="L899">        return creatorConstructor;</span>
    }

    private static Method getFactoryMethod(Class&lt;?&gt; clazz, Method[] methods) {
<span class="fc" id="L903">        Method factoryMethod = null;</span>

<span class="fc bfc" id="L905" title="All 2 branches covered.">        for (Method method : methods) {</span>
<span class="fc bfc" id="L906" title="All 2 branches covered.">            if (!Modifier.isStatic(method.getModifiers())) {</span>
<span class="fc" id="L907">                continue;</span>
            }

<span class="fc bfc" id="L910" title="All 2 branches covered.">            if (!clazz.isAssignableFrom(method.getReturnType())) {</span>
<span class="fc" id="L911">                continue;</span>
            }

<span class="fc" id="L914">            JSONCreator annotation = method.getAnnotation(JSONCreator.class);</span>
<span class="fc bfc" id="L915" title="All 2 branches covered.">            if (annotation != null) {</span>
<span class="fc bfc" id="L916" title="All 2 branches covered.">                if (factoryMethod != null) {</span>
<span class="fc" id="L917">                    throw new JSONException(&quot;multi-JSONCreator&quot;);</span>
                }

<span class="fc" id="L920">                factoryMethod = method;</span>
                // 不应该break，否则多个静态工厂方法上存在 JSONCreator 注解时，并不会触发上述异常抛出
            }
        }
<span class="fc" id="L924">        return factoryMethod;</span>
    }

    public static Class&lt;?&gt; getBuilderClass(JSONType type) {
<span class="nc" id="L928">        return getBuilderClass(null, type);</span>
    }

    public static Class&lt;?&gt; getBuilderClass(Class&lt;?&gt; clazz, JSONType type) {
<span class="pc bpc" id="L932" title="1 of 4 branches missed.">        if (clazz != null &amp;&amp; clazz.getName().equals(&quot;org.springframework.security.web.savedrequest.DefaultSavedRequest&quot;)) {</span>
<span class="fc" id="L933">            return TypeUtils.loadClass(&quot;org.springframework.security.web.savedrequest.DefaultSavedRequest$Builder&quot;);</span>
        }

<span class="fc bfc" id="L936" title="All 2 branches covered.">        if (type == null) {</span>
<span class="fc" id="L937">            return null;</span>
        }

<span class="fc" id="L940">        Class&lt;?&gt; builderClass = type.builder();</span>

<span class="fc bfc" id="L942" title="All 2 branches covered.">        if (builderClass == Void.class) {</span>
<span class="fc" id="L943">            return null;</span>
        }

<span class="fc" id="L946">        return builderClass;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.5.201910111838</span></div></body></html>